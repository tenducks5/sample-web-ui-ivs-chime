{"ast":null,"code":"\"use strict\"; // Copyright 2019-2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) {\n        if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n      }\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar DefaultBrowserBehavior_1 = require(\"../browserbehavior/DefaultBrowserBehavior\");\n\nvar Maybe_1 = require(\"../maybe/Maybe\");\n\nvar MediaRecordingEvent_1 = require(\"./MediaRecordingEvent\");\n\nvar WebMMediaRecording =\n/** @class */\nfunction () {\n  function WebMMediaRecording(mediaStream, options, browser) {\n    if (options === void 0) {\n      options = {};\n    }\n\n    if (browser === void 0) {\n      browser = WebMMediaRecording.browser;\n    }\n\n    this.mediaStream = mediaStream;\n    this.browser = browser;\n    this.delegate = null;\n    this.listeners = new Map();\n    this.options = __assign(__assign({}, options), WebMMediaRecording.options);\n  }\n\n  WebMMediaRecording.prototype.key = function () {\n    var _this = this;\n\n    if (this.delegate && this.delegate.state === 'paused') {\n      return;\n    }\n\n    var delegate = this.delegate;\n    var mediaStream = delegate === null ? this.mediaStream : this.mediaStream.clone();\n    this.delegate = new MediaRecorder(mediaStream, this.options);\n    this.delegate.addEventListener('dataavailable', function (event) {\n      _this.dispatchEvent(event);\n    });\n    /**\n     * Chrome 'ended' callback:\n     * This is a Chrome-specific callback that we receive when the user clicks the \"Stop Sharing\" button\n     * in the Chrome screen sharing bar.\n     */\n\n    this.delegate.stream.getTracks().forEach(function (track) {\n      track.addEventListener('ended', function () {\n        var event = new CustomEvent(MediaRecordingEvent_1.default.EndedEvent, {\n          detail: track\n        });\n\n        _this.dispatchEvent(event);\n      });\n    });\n\n    if (delegate !== null) {\n      if (this.browser.hasChromiumWebRTC()) {\n        delegate.stream.getTracks().forEach(function (stream) {\n          return stream.stop();\n        });\n      }\n\n      delegate.stop();\n    }\n\n    this.delegate.start(this.timeSliceMs);\n  };\n\n  WebMMediaRecording.prototype.start = function (timeSliceMs) {\n    this.timeSliceMs = timeSliceMs;\n    this.key();\n  };\n\n  WebMMediaRecording.prototype.stop = function () {\n    var _this = this;\n\n    return new Promise(function (resolve, reject) {\n      if (_this.delegate === null) {\n        reject(new Error('not started'));\n      } // this event should fire after any data is de-queued\n\n\n      _this.delegate.addEventListener('stop', function () {\n        resolve();\n      });\n\n      _this.delegate.stream.getTracks().forEach(function (track) {\n        track.stop();\n      });\n\n      _this.delegate.stop();\n    });\n  };\n\n  WebMMediaRecording.prototype.pause = function () {\n    var _this = this;\n\n    return new Promise(function (resolve, reject) {\n      if (_this.delegate === null) {\n        reject(new Error('not started'));\n      } // this event should fire after any data is de-queued\n\n\n      _this.delegate.addEventListener('pause', function () {\n        resolve();\n      });\n\n      _this.delegate.pause();\n    });\n  };\n\n  WebMMediaRecording.prototype.unpause = function () {\n    var _this = this;\n\n    return new Promise(function (resolve, reject) {\n      if (_this.delegate === null) {\n        reject(new Error('not started'));\n      }\n\n      resolve();\n\n      _this.delegate.resume();\n    });\n  };\n\n  Object.defineProperty(WebMMediaRecording.prototype, \"recordingState\", {\n    get: function get() {\n      return this.delegate.state;\n    },\n    enumerable: false,\n    configurable: true\n  });\n\n  WebMMediaRecording.prototype.addEventListener = function (type, listener) {\n    var _this = this;\n\n    Maybe_1.default.of(this.listeners.get(type)).defaulting(new Set()).map(function (listeners) {\n      return listeners.add(listener);\n    }).map(function (listeners) {\n      return _this.listeners.set(type, listeners);\n    });\n  };\n\n  WebMMediaRecording.prototype.dispatchEvent = function (event) {\n    Maybe_1.default.of(this.listeners.get(event.type)).map(function (listeners) {\n      listeners.forEach(function (listener) {\n        return listener(event);\n      });\n    });\n    return event.defaultPrevented;\n  };\n\n  WebMMediaRecording.prototype.removeEventListener = function (type, listener) {\n    Maybe_1.default.of(this.listeners.get(type)).map(function (f) {\n      return f.delete(listener);\n    });\n  };\n\n  WebMMediaRecording.browser = new DefaultBrowserBehavior_1.default();\n  WebMMediaRecording.options = {\n    mimeType: 'video/webm; codecs=vp8'\n  };\n  return WebMMediaRecording;\n}();\n\nexports.default = WebMMediaRecording;","map":{"version":3,"sources":["../../src/mediarecording/WebMMediaRecording.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\n// Copyright 2019-2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nvar __assign = (this && this.__assign) || function () {\n    __assign = Object.assign || function(t) {\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\n            s = arguments[i];\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\n                t[p] = s[p];\n        }\n        return t;\n    };\n    return __assign.apply(this, arguments);\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar DefaultBrowserBehavior_1 = require(\"../browserbehavior/DefaultBrowserBehavior\");\nvar Maybe_1 = require(\"../maybe/Maybe\");\nvar MediaRecordingEvent_1 = require(\"./MediaRecordingEvent\");\nvar WebMMediaRecording = /** @class */ (function () {\n    function WebMMediaRecording(mediaStream, options, browser) {\n        if (options === void 0) { options = {}; }\n        if (browser === void 0) { browser = WebMMediaRecording.browser; }\n        this.mediaStream = mediaStream;\n        this.browser = browser;\n        this.delegate = null;\n        this.listeners = new Map();\n        this.options = __assign(__assign({}, options), WebMMediaRecording.options);\n    }\n    WebMMediaRecording.prototype.key = function () {\n        var _this = this;\n        if (this.delegate && this.delegate.state === 'paused') {\n            return;\n        }\n        var delegate = this.delegate;\n        var mediaStream = delegate === null ? this.mediaStream : this.mediaStream.clone();\n        this.delegate = new MediaRecorder(mediaStream, this.options);\n        this.delegate.addEventListener('dataavailable', function (event) {\n            _this.dispatchEvent(event);\n        });\n        /**\n         * Chrome 'ended' callback:\n         * This is a Chrome-specific callback that we receive when the user clicks the \"Stop Sharing\" button\n         * in the Chrome screen sharing bar.\n         */\n        this.delegate.stream.getTracks().forEach(function (track) {\n            track.addEventListener('ended', function () {\n                var event = new CustomEvent(MediaRecordingEvent_1.default.EndedEvent, { detail: track });\n                _this.dispatchEvent(event);\n            });\n        });\n        if (delegate !== null) {\n            if (this.browser.hasChromiumWebRTC()) {\n                delegate.stream.getTracks().forEach(function (stream) { return stream.stop(); });\n            }\n            delegate.stop();\n        }\n        this.delegate.start(this.timeSliceMs);\n    };\n    WebMMediaRecording.prototype.start = function (timeSliceMs) {\n        this.timeSliceMs = timeSliceMs;\n        this.key();\n    };\n    WebMMediaRecording.prototype.stop = function () {\n        var _this = this;\n        return new Promise(function (resolve, reject) {\n            if (_this.delegate === null) {\n                reject(new Error('not started'));\n            }\n            // this event should fire after any data is de-queued\n            _this.delegate.addEventListener('stop', function () {\n                resolve();\n            });\n            _this.delegate.stream.getTracks().forEach(function (track) {\n                track.stop();\n            });\n            _this.delegate.stop();\n        });\n    };\n    WebMMediaRecording.prototype.pause = function () {\n        var _this = this;\n        return new Promise(function (resolve, reject) {\n            if (_this.delegate === null) {\n                reject(new Error('not started'));\n            }\n            // this event should fire after any data is de-queued\n            _this.delegate.addEventListener('pause', function () {\n                resolve();\n            });\n            _this.delegate.pause();\n        });\n    };\n    WebMMediaRecording.prototype.unpause = function () {\n        var _this = this;\n        return new Promise(function (resolve, reject) {\n            if (_this.delegate === null) {\n                reject(new Error('not started'));\n            }\n            resolve();\n            _this.delegate.resume();\n        });\n    };\n    Object.defineProperty(WebMMediaRecording.prototype, \"recordingState\", {\n        get: function () {\n            return this.delegate.state;\n        },\n        enumerable: false,\n        configurable: true\n    });\n    WebMMediaRecording.prototype.addEventListener = function (type, listener) {\n        var _this = this;\n        Maybe_1.default.of(this.listeners.get(type))\n            .defaulting(new Set())\n            .map(function (listeners) { return listeners.add(listener); })\n            .map(function (listeners) { return _this.listeners.set(type, listeners); });\n    };\n    WebMMediaRecording.prototype.dispatchEvent = function (event) {\n        Maybe_1.default.of(this.listeners.get(event.type)).map(function (listeners) {\n            listeners.forEach(function (listener) { return listener(event); });\n        });\n        return event.defaultPrevented;\n    };\n    WebMMediaRecording.prototype.removeEventListener = function (type, listener) {\n        Maybe_1.default.of(this.listeners.get(type)).map(function (f) { return f.delete(listener); });\n    };\n    WebMMediaRecording.browser = new DefaultBrowserBehavior_1.default();\n    WebMMediaRecording.options = {\n        mimeType: 'video/webm; codecs=vp8',\n    };\n    return WebMMediaRecording;\n}());\nexports.default = WebMMediaRecording;\n//# sourceMappingURL=WebMMediaRecording.js.map"]},"metadata":{},"sourceType":"script"}