{"ast":null,"code":"import _regeneratorRuntime from\"/Users/sykang/Documents/Git/amazon-ivs-chime-web-demo/web-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/sykang/Documents/Git/amazon-ivs-chime-web-demo/web-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/Users/sykang/Documents/Git/amazon-ivs-chime-web-demo/web-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/sykang/Documents/Git/amazon-ivs-chime-web-demo/web-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import{ConsoleLogger,DefaultDeviceController,DefaultDOMWebSocketFactory,DefaultMeetingSession,DefaultModality,DefaultPromisedWebSocketFactory,FullJitterBackoff,LogLevel,MeetingSessionConfiguration,ReconnectingPromisedWebSocket}from'amazon-chime-sdk-js';import throttle from'lodash/throttle';import*as config from'../../config';var ChimeSdkWrapper=/*#__PURE__*/function(){function ChimeSdkWrapper(){_classCallCheck(this,ChimeSdkWrapper);this.initializeSdkWrapper();}_createClass(ChimeSdkWrapper,[{key:\"initializeSdkWrapper\",value:function initializeSdkWrapper(){this.meetingSession=null;this.audioVideo=null;this.title=null;this.name=null;this.region=null;this.currentAudioInputDevice=null;this.currentAudioOutputDevice=null;this.currentVideoInputDevice=null;this.audioInputDevices=[];this.audioOutputDevices=[];this.videoInputDevices=[];this.devicesUpdatedCallbacks=[];this.roster={};this.rosterUpdateCallbacks=[];this.configuration=null;this.messagingSocket=null;this.messageUpdateCallbacks=[];}},{key:\"logError\",value:function logError(error){console.error(error);}},{key:\"createRoom\",value:function(){var _createRoom=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(role,name,title,playbackURL,region){var payload,response,json,JoinInfo;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(!name||!title||!role)){_context.next=3;break;}console.error(\"role=\".concat(role,\" name=\").concat(name,\" title=\").concat(title,\" must exist\"));return _context.abrupt(\"return\");case 3:payload={name:name,title:title,playbackURL:playbackURL,role:role};_context.next=6;return fetch(\"\".concat(config.CHIME_ROOM_API,\"/join\"),{method:'POST',body:JSON.stringify(payload)});case 6:response=_context.sent;_context.next=9;return response.json();case 9:json=_context.sent;if(!json.error){_context.next=12;break;}throw new Error(json.error);case 12:JoinInfo=json.JoinInfo;if(JoinInfo){_context.next=15;break;}throw new Error('CreateOrJoin.classRoomDoesNotExist');case 15:this.configuration=new MeetingSessionConfiguration(JoinInfo.Meeting,JoinInfo.Attendee);_context.next=18;return this.initializeMeetingSession(this.configuration);case 18:this.title=title;this.name=name;this.region=region;return _context.abrupt(\"return\",JoinInfo);case 22:case\"end\":return _context.stop();}}},_callee,this);}));function createRoom(_x,_x2,_x3,_x4,_x5){return _createRoom.apply(this,arguments);}return createRoom;}()},{key:\"reInitializeMeetingSession\",value:function(){var _reInitializeMeetingSession=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(JoinInfo,name){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:this.configuration=new MeetingSessionConfiguration(JoinInfo.Meeting,JoinInfo.Attendee);_context2.next=3;return this.initializeMeetingSession(this.configuration);case 3:this.title=JoinInfo.Title;this.name=name;// this.region = region;\ncase 5:case\"end\":return _context2.stop();}}},_callee2,this);}));function reInitializeMeetingSession(_x6,_x7){return _reInitializeMeetingSession.apply(this,arguments);}return reInitializeMeetingSession;}()},{key:\"initializeMeetingSession\",value:function(){var _initializeMeetingSession=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(configuration){var _this=this;var logger,deviceController;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:logger=new ConsoleLogger('SDK',LogLevel.ERROR);deviceController=new DefaultDeviceController(logger);this.meetingSession=new DefaultMeetingSession(configuration,logger,deviceController);this.audioVideo=this.meetingSession.audioVideo;this.audioInputDevices=[];_context4.next=7;return this.audioVideo.listAudioInputDevices();case 7:_context4.sent.forEach(function(mediaDeviceInfo){_this.audioInputDevices.push({label:mediaDeviceInfo.label,value:mediaDeviceInfo.deviceId});});this.audioOutputDevices=[];_context4.next=11;return this.audioVideo.listAudioOutputDevices();case 11:_context4.sent.forEach(function(mediaDeviceInfo){_this.audioOutputDevices.push({label:mediaDeviceInfo.label,value:mediaDeviceInfo.deviceId});});this.videoInputDevices=[];_context4.next=15;return this.audioVideo.listVideoInputDevices();case 15:_context4.sent.forEach(function(mediaDeviceInfo){_this.videoInputDevices.push({label:mediaDeviceInfo.label,value:mediaDeviceInfo.deviceId});});this.publishDevicesUpdated();this.audioVideo.addDeviceChangeObserver(this);this.audioVideo.realtimeSubscribeToAttendeeIdPresence(function(presentAttendeeId,present){if(!present){delete _this.roster[presentAttendeeId];//this.publishRosterUpdate.cancel();\n_this.publishRosterUpdate()();return;}_this.audioVideo.realtimeSubscribeToVolumeIndicator(presentAttendeeId,/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(attendeeId,volume,muted,signalStrength){var baseAttendeeId,shouldPublishImmediately,response,json;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:baseAttendeeId=new DefaultModality(attendeeId).base();if(!(baseAttendeeId!==attendeeId)){_context3.next=3;break;}return _context3.abrupt(\"return\");case 3:shouldPublishImmediately=false;if(!_this.roster[attendeeId]){_this.roster[attendeeId]={name:''};}if(volume!==null){_this.roster[attendeeId].volume=Math.round(volume*100);}if(muted!==null){_this.roster[attendeeId].muted=muted;}if(signalStrength!==null){_this.roster[attendeeId].signalStrength=Math.round(signalStrength*100);}if(!(_this.title&&attendeeId&&!_this.roster[attendeeId].name)){_context3.next=16;break;}_context3.next=11;return fetch(\"\".concat(config.CHIME_ROOM_API,\"/attendee?title=\").concat(encodeURIComponent(_this.title),\"&attendeeId=\").concat(encodeURIComponent(attendeeId)));case 11:response=_context3.sent;_context3.next=14;return response.json();case 14:json=_context3.sent;if(json.AttendeeInfo&&_this.roster[attendeeId]){_this.roster[attendeeId].name=json.AttendeeInfo.Name||'';shouldPublishImmediately=true;}case 16:if(shouldPublishImmediately){//this.publishRosterUpdate.cancel();\n}_this.publishRosterUpdate()();case 18:case\"end\":return _context3.stop();}}},_callee3);}));return function(_x9,_x10,_x11,_x12){return _ref.apply(this,arguments);};}());});case 19:case\"end\":return _context4.stop();}}},_callee4,this);}));function initializeMeetingSession(_x8){return _initializeMeetingSession.apply(this,arguments);}return initializeMeetingSession;}()},{key:\"joinRoom\",value:function(){var _joinRoom=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(element){var _this2=this;var audioInputs,audioOutputs,videoInputs;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:if(element){_context5.next=3;break;}this.logError(new Error(\"element does not exist\"));return _context5.abrupt(\"return\");case 3:window.addEventListener('unhandledrejection',function(event){_this2.logError(event.reason);});_context5.next=6;return this.audioVideo.listAudioInputDevices();case 6:audioInputs=_context5.sent;if(!(audioInputs&&audioInputs.length>0&&audioInputs[0].deviceId)){_context5.next=11;break;}this.currentAudioInputDevice={label:audioInputs[0].label,value:audioInputs[0].deviceId};_context5.next=11;return this.audioVideo.chooseAudioInputDevice(audioInputs[0].deviceId);case 11:_context5.next=13;return this.audioVideo.listAudioOutputDevices();case 13:audioOutputs=_context5.sent;if(!(audioOutputs&&audioOutputs.length>0&&audioOutputs[0].deviceId)){_context5.next=18;break;}this.currentAudioOutputDevice={label:audioOutputs[0].label,value:audioOutputs[0].deviceId};_context5.next=18;return this.audioVideo.chooseAudioOutputDevice(audioOutputs[0].deviceId);case 18:_context5.next=20;return this.audioVideo.listVideoInputDevices();case 20:videoInputs=_context5.sent;if(!(videoInputs&&videoInputs.length>0&&videoInputs[0].deviceId)){_context5.next=25;break;}this.currentVideoInputDevice={label:videoInputs[0].label,value:videoInputs[0].deviceId};_context5.next=25;return this.audioVideo.chooseVideoInputDevice(null);case 25:this.publishDevicesUpdated();this.audioVideo.bindAudioElement(element);this.audioVideo.start();case 28:case\"end\":return _context5.stop();}}},_callee5,this);}));function joinRoom(_x13){return _joinRoom.apply(this,arguments);}return joinRoom;}()},{key:\"joinRoomMessaging\",value:function(){var _joinRoomMessaging=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(){var _this3=this;var messagingUrl;return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:if(this.configuration){_context6.next=3;break;}this.logError(new Error('configuration does not exist'));return _context6.abrupt(\"return\");case 3:messagingUrl=\"\".concat(config.CHAT_WEBSOCKET,\"?MeetingId=\").concat(this.configuration.meetingId,\"&AttendeeId=\").concat(this.configuration.credentials.attendeeId,\"&JoinToken=\").concat(this.configuration.credentials.joinToken);this.messagingSocket=new ReconnectingPromisedWebSocket(messagingUrl,[],'arraybuffer',new DefaultPromisedWebSocketFactory(new DefaultDOMWebSocketFactory()),new FullJitterBackoff(1000,0,10000));_context6.next=7;return this.messagingSocket.open(this.WEB_SOCKET_TIMEOUT_MS);case 7:this.messagingSocket.addEventListener('message',function(event){try{var data=JSON.parse(event.data);var attendeeId=data.payload.attendeeId;var name;if(_this3.roster[attendeeId]){name=_this3.roster[attendeeId].name;}_this3.publishMessageUpdate({type:data.type,payload:data.payload,timestampMs:Date.now(),name:name});}catch(error){_this3.logError(error);}});case 8:case\"end\":return _context6.stop();}}},_callee6,this);}));function joinRoomMessaging(){return _joinRoomMessaging.apply(this,arguments);}return joinRoomMessaging;}()},{key:\"sendMessage\",value:function sendMessage(type,payload){if(!this.messagingSocket){return;}var message={message:'sendmessage',data:JSON.stringify({type:type,payload:payload})};try{this.messagingSocket.send(JSON.stringify(message));}catch(error){this.logError(error);}}},{key:\"leaveRoom\",value:function(){var _leaveRoom=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee7(end){return _regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:try{this.audioVideo.stop();}catch(error){this.logError(error);}// try {\n//   await this.messagingSocket.close(this.WEB_SOCKET_TIMEOUT_MS);\n// } catch (error) {\n//   this.logError(error);\n// }\n_context7.prev=1;if(!(end&&this.title)){_context7.next=5;break;}_context7.next=5;return fetch(\"\".concat(config.CHIME_ROOM_API,\"/end?title=\").concat(encodeURIComponent(this.title)),{method:'POST'});case 5:_context7.next=10;break;case 7:_context7.prev=7;_context7.t0=_context7[\"catch\"](1);this.logError(_context7.t0);case 10:this.initializeSdkWrapper();case 11:case\"end\":return _context7.stop();}}},_callee7,this,[[1,7]]);}));function leaveRoom(_x14){return _leaveRoom.apply(this,arguments);}return leaveRoom;}()// Device\n},{key:\"chooseAudioInputDevice\",value:function(){var _chooseAudioInputDevice=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee8(device){return _regeneratorRuntime.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:_context8.prev=0;_context8.next=3;return this.audioVideo.chooseAudioInputDevice(device.value);case 3:this.currentAudioInputDevice=device;_context8.next=9;break;case 6:_context8.prev=6;_context8.t0=_context8[\"catch\"](0);this.logError(_context8.t0);case 9:case\"end\":return _context8.stop();}}},_callee8,this,[[0,6]]);}));function chooseAudioInputDevice(_x15){return _chooseAudioInputDevice.apply(this,arguments);}return chooseAudioInputDevice;}()},{key:\"chooseAudioOutputDevice\",value:function(){var _chooseAudioOutputDevice=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee9(device){return _regeneratorRuntime.wrap(function _callee9$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:_context9.prev=0;_context9.next=3;return this.audioVideo.chooseAudioOutputDevice(device.value);case 3:this.currentAudioOutputDevice=device;_context9.next=9;break;case 6:_context9.prev=6;_context9.t0=_context9[\"catch\"](0);this.logError(_context9.t0);case 9:case\"end\":return _context9.stop();}}},_callee9,this,[[0,6]]);}));function chooseAudioOutputDevice(_x16){return _chooseAudioOutputDevice.apply(this,arguments);}return chooseAudioOutputDevice;}()},{key:\"chooseVideoInputDevice\",value:function(){var _chooseVideoInputDevice=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee10(device){return _regeneratorRuntime.wrap(function _callee10$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:_context10.prev=0;_context10.next=3;return this.audioVideo.chooseVideoInputDevice(device.value);case 3:this.currentVideoInputDevice=device;_context10.next=9;break;case 6:_context10.prev=6;_context10.t0=_context10[\"catch\"](0);this.logError(_context10.t0);case 9:case\"end\":return _context10.stop();}}},_callee10,this,[[0,6]]);}));function chooseVideoInputDevice(_x17){return _chooseVideoInputDevice.apply(this,arguments);}return chooseVideoInputDevice;}()// Observer methods\n},{key:\"audioInputsChanged\",value:function audioInputsChanged(freshAudioInputDeviceList){var _this4=this;var hasCurrentDevice=false;this.audioInputDevices=[];freshAudioInputDeviceList.forEach(function(mediaDeviceInfo){if(_this4.currentAudioInputDevice&&mediaDeviceInfo.deviceId===_this4.currentAudioInputDevice.value){hasCurrentDevice=true;}_this4.audioInputDevices.push({label:mediaDeviceInfo.label,value:mediaDeviceInfo.deviceId});});if(!hasCurrentDevice){this.currentAudioInputDevice=this.audioInputDevices.length>0?this.audioInputDevices[0]:null;}this.publishDevicesUpdated();}},{key:\"audioOutputsChanged\",value:function audioOutputsChanged(freshAudioOutputDeviceList){var _this5=this;var hasCurrentDevice=false;this.audioOutputDevices=[];freshAudioOutputDeviceList.forEach(function(mediaDeviceInfo){if(_this5.currentAudioOutputDevice&&mediaDeviceInfo.deviceId===_this5.currentAudioOutputDevice.value){hasCurrentDevice=true;}_this5.audioOutputDevices.push({label:mediaDeviceInfo.label,value:mediaDeviceInfo.deviceId});});if(!hasCurrentDevice){this.currentAudioOutputDevice=this.audioOutputDevices.length>0?this.audioOutputDevices[0]:null;}this.publishDevicesUpdated();}},{key:\"videoInputsChanged\",value:function videoInputsChanged(freshVideoInputDeviceList){var _this6=this;var hasCurrentDevice=false;this.videoInputDevices=[];freshVideoInputDeviceList.forEach(function(mediaDeviceInfo){if(_this6.currentVideoInputDevice&&mediaDeviceInfo.deviceId===_this6.currentVideoInputDevice.value){hasCurrentDevice=true;}_this6.videoInputDevices.push({label:mediaDeviceInfo.label,value:mediaDeviceInfo.deviceId});});if(!hasCurrentDevice){this.currentVideoInputDevice=this.videoInputDevices.length>0?this.videoInputDevices[0]:null;}this.publishDevicesUpdated();}// Subscribe and unsubscribe\n},{key:\"subscribeToDevicesUpdated\",value:function subscribeToDevicesUpdated(callback){this.devicesUpdatedCallbacks.push(callback);}},{key:\"unsubscribeFromDevicesUpdated\",value:function unsubscribeFromDevicesUpdated(callback){var index=this.devicesUpdatedCallbacks.indexOf(callback);if(index!==-1){this.devicesUpdatedCallbacks.splice(index,1);}}},{key:\"publishDevicesUpdated\",value:function publishDevicesUpdated(){var _this7=this;this.devicesUpdatedCallbacks.forEach(function(callback){callback({currentAudioInputDevice:_this7.currentAudioInputDevice,currentAudioOutputDevice:_this7.currentAudioOutputDevice,currentVideoInputDevice:_this7.currentVideoInputDevice,audioInputDevices:_this7.audioInputDevices,audioOutputDevices:_this7.audioOutputDevices,videoInputDevices:_this7.videoInputDevices});});}},{key:\"subscribeToRosterUpdate\",value:function subscribeToRosterUpdate(callback){this.rosterUpdateCallbacks.push(callback);}},{key:\"unsubscribeFromRosterUpdate\",value:function unsubscribeFromRosterUpdate(callback){var index=this.rosterUpdateCallbacks.indexOf(callback);if(index!==-1){this.rosterUpdateCallbacks.splice(index,1);}}},{key:\"publishRosterUpdate\",value:function publishRosterUpdate(){var _this8=this;return throttle(function(){for(var i=0;i<_this8.rosterUpdateCallbacks.length;i+=1){var callback=_this8.rosterUpdateCallbacks[i];callback(_this8.roster);}},this.ROSTER_THROTTLE_MS);}},{key:\"subscribeToMessageUpdate\",value:function subscribeToMessageUpdate(callback){this.messageUpdateCallbacks.push(callback);}},{key:\"unsubscribeFromMessageUpdate\",value:function unsubscribeFromMessageUpdate(callback){var index=this.messageUpdateCallbacks.indexOf(callback);if(index!==-1){this.messageUpdateCallbacks.splice(index,1);}}},{key:\"publishMessageUpdate\",value:function publishMessageUpdate(message){for(var i=0;i<this.messageUpdateCallbacks.length;i+=1){var callback=this.messageUpdateCallbacks[i];callback(message);}}}]);return ChimeSdkWrapper;}();ChimeSdkWrapper.WEB_SOCKET_TIMEOUT_MS=10000;ChimeSdkWrapper.ROSTER_THROTTLE_MS=400;export{ChimeSdkWrapper as default};","map":{"version":3,"sources":["/Users/sykang/Documents/Git/amazon-ivs-chime-web-demo/web-ui/src/components/chime/ChimeSdkWrapper.js"],"names":["ConsoleLogger","DefaultDeviceController","DefaultDOMWebSocketFactory","DefaultMeetingSession","DefaultModality","DefaultPromisedWebSocketFactory","FullJitterBackoff","LogLevel","MeetingSessionConfiguration","ReconnectingPromisedWebSocket","throttle","config","ChimeSdkWrapper","initializeSdkWrapper","meetingSession","audioVideo","title","name","region","currentAudioInputDevice","currentAudioOutputDevice","currentVideoInputDevice","audioInputDevices","audioOutputDevices","videoInputDevices","devicesUpdatedCallbacks","roster","rosterUpdateCallbacks","configuration","messagingSocket","messageUpdateCallbacks","error","console","role","playbackURL","payload","fetch","CHIME_ROOM_API","method","body","JSON","stringify","response","json","Error","JoinInfo","Meeting","Attendee","initializeMeetingSession","Title","logger","ERROR","deviceController","listAudioInputDevices","forEach","mediaDeviceInfo","push","label","value","deviceId","listAudioOutputDevices","listVideoInputDevices","publishDevicesUpdated","addDeviceChangeObserver","realtimeSubscribeToAttendeeIdPresence","presentAttendeeId","present","publishRosterUpdate","realtimeSubscribeToVolumeIndicator","attendeeId","volume","muted","signalStrength","baseAttendeeId","base","shouldPublishImmediately","Math","round","encodeURIComponent","AttendeeInfo","Name","element","logError","window","addEventListener","event","reason","audioInputs","length","chooseAudioInputDevice","audioOutputs","chooseAudioOutputDevice","videoInputs","chooseVideoInputDevice","bindAudioElement","start","messagingUrl","CHAT_WEBSOCKET","meetingId","credentials","joinToken","open","WEB_SOCKET_TIMEOUT_MS","data","parse","publishMessageUpdate","type","timestampMs","Date","now","message","send","end","stop","device","freshAudioInputDeviceList","hasCurrentDevice","freshAudioOutputDeviceList","freshVideoInputDeviceList","callback","index","indexOf","splice","i","ROSTER_THROTTLE_MS"],"mappings":"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","sourcesContent":["import {\n  ConsoleLogger,\n  DefaultDeviceController,\n  DefaultDOMWebSocketFactory,\n  DefaultMeetingSession,\n  DefaultModality,\n  DefaultPromisedWebSocketFactory,\n  FullJitterBackoff,\n  LogLevel,\n  MeetingSessionConfiguration,\n  ReconnectingPromisedWebSocket\n} from 'amazon-chime-sdk-js';\n\nimport throttle from 'lodash/throttle';\nimport * as config from '../../config';\n\n\nexport default class ChimeSdkWrapper {\n\n  static WEB_SOCKET_TIMEOUT_MS = 10000;\n  static ROSTER_THROTTLE_MS = 400;\n\n  constructor() {\n    this.initializeSdkWrapper();\n  }\n\n  initializeSdkWrapper() {\n    this.meetingSession = null;\n    this.audioVideo = null;\n    this.title = null;\n    this.name = null;\n    this.region = null;\n    this.currentAudioInputDevice = null;\n    this.currentAudioOutputDevice = null;\n    this.currentVideoInputDevice = null;\n    this.audioInputDevices = [];\n    this.audioOutputDevices = [];\n    this.videoInputDevices = [];\n    this.devicesUpdatedCallbacks = [];\n    this.roster = {};\n    this.rosterUpdateCallbacks = [];\n    this.configuration = null;\n    this.messagingSocket = null;\n    this.messageUpdateCallbacks = [];\n  }\n\n  logError(error) {\n    console.error(error);\n  }\n\n  async createRoom(role, name, title, playbackURL, region) {\n    if (!name || !title || !role) {\n      console.error(\n           `role=${role} name=${name} title=${title} must exist`\n      );\n      return;\n    }\n\n    const payload = {\n      name,\n      title,\n      playbackURL,\n      role\n    };\n\n    const response = await fetch(\n      `${config.CHIME_ROOM_API}/join`,\n      {\n        method: 'POST',\n        body: JSON.stringify(payload)\n      }\n    );\n    const json = await response.json();\n    if (json.error) {\n      throw new Error(\n        json.error\n      );\n    }\n\n    const { JoinInfo } = json;\n    if (!JoinInfo) {\n      throw new Error(\n        'CreateOrJoin.classRoomDoesNotExist'\n      );\n    }\n    this.configuration = new MeetingSessionConfiguration(\n      JoinInfo.Meeting,\n      JoinInfo.Attendee\n    );\n    await this.initializeMeetingSession(this.configuration);\n\n    this.title = title;\n    this.name = name;\n    this.region = region;\n\n    return JoinInfo;\n  }\n\n  async reInitializeMeetingSession(JoinInfo, name) {\n    this.configuration = new MeetingSessionConfiguration(\n      JoinInfo.Meeting,\n      JoinInfo.Attendee\n    );\n    await this.initializeMeetingSession(this.configuration);\n\n    this.title = JoinInfo.Title;\n    this.name = name;\n    // this.region = region;\n  }\n\n  async initializeMeetingSession(configuration) {\n    const logger = new ConsoleLogger('SDK', LogLevel.ERROR);\n    const deviceController = new DefaultDeviceController(logger);\n    this.meetingSession = new DefaultMeetingSession(\n      configuration,\n      logger,\n      deviceController\n    );\n    this.audioVideo = this.meetingSession.audioVideo;\n\n    this.audioInputDevices = [];\n    (await this.audioVideo.listAudioInputDevices()).forEach(\n      (mediaDeviceInfo) => {\n        this.audioInputDevices.push({\n          label: mediaDeviceInfo.label,\n          value: mediaDeviceInfo.deviceId\n        });\n      }\n    );\n    this.audioOutputDevices = [];\n    (await this.audioVideo.listAudioOutputDevices()).forEach(\n      (mediaDeviceInfo) => {\n        this.audioOutputDevices.push({\n          label: mediaDeviceInfo.label,\n          value: mediaDeviceInfo.deviceId\n        });\n      }\n    );\n    this.videoInputDevices = [];\n    (await this.audioVideo.listVideoInputDevices()).forEach(\n      (mediaDeviceInfo) => {\n        this.videoInputDevices.push({\n          label: mediaDeviceInfo.label,\n          value: mediaDeviceInfo.deviceId\n        });\n      }\n    );\n    this.publishDevicesUpdated();\n    this.audioVideo.addDeviceChangeObserver(this);\n\n    this.audioVideo.realtimeSubscribeToAttendeeIdPresence(\n      (presentAttendeeId, present) => {\n        if (!present) {\n          delete this.roster[presentAttendeeId];\n          //this.publishRosterUpdate.cancel();\n          this.publishRosterUpdate()();\n          return;\n        }\n\n        this.audioVideo.realtimeSubscribeToVolumeIndicator(\n          presentAttendeeId,\n          async (\n            attendeeId,\n            volume,\n            muted,\n            signalStrength\n          ) => {\n            const baseAttendeeId = new DefaultModality(attendeeId).base();\n            if (baseAttendeeId !== attendeeId) {\n              // Don't include the content attendee in the roster.\n              //\n              // When you or other attendees share content (a screen capture, a video file,\n              // or any other MediaStream object), the content attendee (attendee-id#content) joins the session and\n              // shares content as if a regular attendee shares a video.\n              //\n              // For example, your attendee ID is \"my-id\". When you call meetingSession.audioVideo.startContentShare,\n              // the content attendee \"my-id#content\" will join the session and share your content.\n              return;\n            }\n\n            let shouldPublishImmediately = false;\n\n            if (!this.roster[attendeeId]) {\n              this.roster[attendeeId] = { name: '' };\n            }\n            if (volume !== null) {\n              this.roster[attendeeId].volume = Math.round(volume * 100);\n            }\n            if (muted !== null) {\n              this.roster[attendeeId].muted = muted;\n            }\n            if (signalStrength !== null) {\n              this.roster[attendeeId].signalStrength = Math.round(\n                signalStrength * 100\n              );\n            }\n            if (this.title && attendeeId && !this.roster[attendeeId].name) {\n              const response = await fetch(\n                `${config.CHIME_ROOM_API}/attendee?title=${encodeURIComponent(\n                  this.title\n                )}&attendeeId=${encodeURIComponent(attendeeId)}`\n              );\n              const json = await response.json();\n              if (json.AttendeeInfo && this.roster[attendeeId]) {\n                this.roster[attendeeId].name = json.AttendeeInfo.Name || '';\n                shouldPublishImmediately = true;\n              }\n            }\n\n            if (shouldPublishImmediately) {\n              //this.publishRosterUpdate.cancel();\n            }\n            this.publishRosterUpdate()();\n          }\n        );\n      }\n    );\n  }\n\n  async joinRoom(element) {\n    if (!element) {\n      this.logError(new Error(`element does not exist`));\n      return;\n    }\n\n    window.addEventListener(\n      'unhandledrejection',\n      (event) => {\n        this.logError(event.reason);\n      }\n    );\n\n    const audioInputs = await this.audioVideo.listAudioInputDevices();\n    if (audioInputs && audioInputs.length > 0 && audioInputs[0].deviceId) {\n      this.currentAudioInputDevice = {\n        label: audioInputs[0].label,\n        value: audioInputs[0].deviceId\n      };\n      await this.audioVideo.chooseAudioInputDevice(audioInputs[0].deviceId);\n    }\n\n    const audioOutputs = await this.audioVideo.listAudioOutputDevices();\n    if (audioOutputs && audioOutputs.length > 0 && audioOutputs[0].deviceId) {\n      this.currentAudioOutputDevice = {\n        label: audioOutputs[0].label,\n        value: audioOutputs[0].deviceId\n      };\n      await this.audioVideo.chooseAudioOutputDevice(audioOutputs[0].deviceId);\n    }\n\n    const videoInputs = await this.audioVideo.listVideoInputDevices();\n    if (videoInputs && videoInputs.length > 0 && videoInputs[0].deviceId) {\n      this.currentVideoInputDevice = {\n        label: videoInputs[0].label,\n        value: videoInputs[0].deviceId\n      };\n      await this.audioVideo.chooseVideoInputDevice(null);\n    }\n\n    this.publishDevicesUpdated();\n\n    this.audioVideo.bindAudioElement(element);\n    this.audioVideo.start();\n  }\n\n  async joinRoomMessaging() {\n    if (!this.configuration) {\n      this.logError(new Error('configuration does not exist'));\n      return;\n    }\n\n    const messagingUrl = `${config.CHAT_WEBSOCKET}?MeetingId=${this.configuration.meetingId}&AttendeeId=${this.configuration.credentials.attendeeId}&JoinToken=${this.configuration.credentials.joinToken}`;\n    this.messagingSocket = new ReconnectingPromisedWebSocket(\n      messagingUrl,\n      [],\n      'arraybuffer',\n      new DefaultPromisedWebSocketFactory(new DefaultDOMWebSocketFactory()),\n      new FullJitterBackoff(1000, 0, 10000)\n    );\n\n    await this.messagingSocket.open(this.WEB_SOCKET_TIMEOUT_MS);\n\n    this.messagingSocket.addEventListener('message', (event) => {\n      try {\n        const data = JSON.parse(event.data);\n        const { attendeeId } = data.payload;\n\n        let name;\n        if (this.roster[attendeeId]) {\n          name = this.roster[attendeeId].name;\n        }\n\n        this.publishMessageUpdate({\n          type: data.type,\n          payload: data.payload,\n          timestampMs: Date.now(),\n          name\n        });\n      } catch (error) {\n        this.logError(error);\n      }\n    });\n  }\n\n  sendMessage(type, payload) {\n    if (!this.messagingSocket) {\n      return;\n    }\n    const message = {\n      message: 'sendmessage',\n      data: JSON.stringify({ type, payload })\n    };\n    try {\n      this.messagingSocket.send(JSON.stringify(message));\n    } catch (error) {\n      this.logError(error);\n    }\n  }\n\n  async leaveRoom(end) {\n    try {\n      this.audioVideo.stop();\n    } catch (error) {\n      this.logError(error);\n    }\n\n    // try {\n    //   await this.messagingSocket.close(this.WEB_SOCKET_TIMEOUT_MS);\n    // } catch (error) {\n    //   this.logError(error);\n    // }\n\n    try {\n      if (end && this.title) {\n        await fetch(\n          `${config.CHIME_ROOM_API}/end?title=${encodeURIComponent(this.title)}`,\n          {\n            method: 'POST'\n          }\n        );\n      }\n    } catch (error) {\n      this.logError(error);\n    }\n\n    this.initializeSdkWrapper();\n  }\n\n  // Device\n\n  async chooseAudioInputDevice(device) {\n    try {\n      await this.audioVideo.chooseAudioInputDevice(device.value);\n      this.currentAudioInputDevice = device;\n    } catch (error) {\n      this.logError(error);\n    }\n  }\n\n  async chooseAudioOutputDevice(device) {\n    try {\n      await this.audioVideo.chooseAudioOutputDevice(device.value);\n      this.currentAudioOutputDevice = device;\n    } catch (error) {\n      this.logError(error);\n    }\n  }\n\n  async chooseVideoInputDevice(device) {\n    try {\n      await this.audioVideo.chooseVideoInputDevice(device.value);\n      this.currentVideoInputDevice = device;\n    } catch (error) {\n      this.logError(error);\n    }\n  }\n\n  // Observer methods\n\n  audioInputsChanged(freshAudioInputDeviceList) {\n    let hasCurrentDevice = false;\n    this.audioInputDevices = [];\n    freshAudioInputDeviceList.forEach((mediaDeviceInfo) => {\n      if (\n        this.currentAudioInputDevice &&\n        mediaDeviceInfo.deviceId === this.currentAudioInputDevice.value\n      ) {\n        hasCurrentDevice = true;\n      }\n      this.audioInputDevices.push({\n        label: mediaDeviceInfo.label,\n        value: mediaDeviceInfo.deviceId\n      });\n    });\n    if (!hasCurrentDevice) {\n      this.currentAudioInputDevice =\n        this.audioInputDevices.length > 0 ? this.audioInputDevices[0] : null;\n    }\n    this.publishDevicesUpdated();\n  }\n\n  audioOutputsChanged(freshAudioOutputDeviceList) {\n    let hasCurrentDevice = false;\n    this.audioOutputDevices = [];\n    freshAudioOutputDeviceList.forEach((mediaDeviceInfo) => {\n      if (\n        this.currentAudioOutputDevice &&\n        mediaDeviceInfo.deviceId === this.currentAudioOutputDevice.value\n      ) {\n        hasCurrentDevice = true;\n      }\n      this.audioOutputDevices.push({\n        label: mediaDeviceInfo.label,\n        value: mediaDeviceInfo.deviceId\n      });\n    });\n    if (!hasCurrentDevice) {\n      this.currentAudioOutputDevice =\n        this.audioOutputDevices.length > 0 ? this.audioOutputDevices[0] : null;\n    }\n    this.publishDevicesUpdated();\n  }\n\n  videoInputsChanged(freshVideoInputDeviceList) {\n    let hasCurrentDevice = false;\n    this.videoInputDevices = [];\n    freshVideoInputDeviceList.forEach((mediaDeviceInfo) => {\n      if (\n        this.currentVideoInputDevice &&\n        mediaDeviceInfo.deviceId === this.currentVideoInputDevice.value\n      ) {\n        hasCurrentDevice = true;\n      }\n      this.videoInputDevices.push({\n        label: mediaDeviceInfo.label,\n        value: mediaDeviceInfo.deviceId\n      });\n    });\n    if (!hasCurrentDevice) {\n      this.currentVideoInputDevice =\n        this.videoInputDevices.length > 0 ? this.videoInputDevices[0] : null;\n    }\n    this.publishDevicesUpdated();\n  }\n\n  // Subscribe and unsubscribe\n\n  subscribeToDevicesUpdated(callback) {\n    this.devicesUpdatedCallbacks.push(callback);\n  }\n\n  unsubscribeFromDevicesUpdated(callback) {\n    const index = this.devicesUpdatedCallbacks.indexOf(callback);\n    if (index !== -1) {\n      this.devicesUpdatedCallbacks.splice(index, 1);\n    }\n  }\n\n  publishDevicesUpdated() {\n    this.devicesUpdatedCallbacks.forEach(\n      (callback) => {\n        callback({\n          currentAudioInputDevice: this.currentAudioInputDevice,\n          currentAudioOutputDevice: this.currentAudioOutputDevice,\n          currentVideoInputDevice: this.currentVideoInputDevice,\n          audioInputDevices: this.audioInputDevices,\n          audioOutputDevices: this.audioOutputDevices,\n          videoInputDevices: this.videoInputDevices\n        });\n      }\n    );\n  }\n\n  subscribeToRosterUpdate(callback) {\n    this.rosterUpdateCallbacks.push(callback);\n  }\n\n  unsubscribeFromRosterUpdate(callback) {\n    const index = this.rosterUpdateCallbacks.indexOf(callback);\n    if (index !== -1) {\n      this.rosterUpdateCallbacks.splice(index, 1);\n    }\n  }\n\n  publishRosterUpdate() {\n    return throttle(() => {\n      for (let i = 0; i < this.rosterUpdateCallbacks.length; i += 1) {\n        const callback = this.rosterUpdateCallbacks[i];\n        callback(this.roster);\n      }\n    }, this.ROSTER_THROTTLE_MS);\n  }\n\n  subscribeToMessageUpdate(callback) {\n    this.messageUpdateCallbacks.push(callback);\n  }\n\n  unsubscribeFromMessageUpdate(callback) {\n    const index = this.messageUpdateCallbacks.indexOf(callback);\n    if (index !== -1) {\n      this.messageUpdateCallbacks.splice(index, 1);\n    }\n  }\n\n  publishMessageUpdate(message) {\n    for (let i = 0; i < this.messageUpdateCallbacks.length; i += 1) {\n      const callback = this.messageUpdateCallbacks[i];\n      callback(message);\n    }\n  }\n}\n"]},"metadata":{},"sourceType":"module"}