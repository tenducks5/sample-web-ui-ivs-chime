{"ast":null,"code":"\"use strict\"; // Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar DragType_1 = require(\"../../dragobserver/DragType\");\n\nvar DefaultPresentation_1 = require(\"../../presentation/DefaultPresentation\");\n\nvar PresentationPolicy_1 = require(\"../../presentation/policy/PresentationPolicy\");\n\nvar ScaleToFitPresentationPolicy_1 = require(\"../../presentation/policy/ScaleToFitPresentationPolicy\");\n\nvar PresentationElementFactory_1 = require(\"../../presentation/PresentationElementFactory\");\n\nvar DefaultScreenViewingDeltaRenderer =\n/** @class */\nfunction () {\n  function DefaultScreenViewingDeltaRenderer(jpegDecoderController, logger, window, resizeObserverFactory, dragObserverFactory) {\n    var _this = this;\n\n    this.jpegDecoderController = jpegDecoderController;\n    this.logger = logger;\n    this.window = window;\n    this.dragObserverFactory = dragObserverFactory; // eslint-disable-next-line @typescript-eslint/no-explicit-any,@typescript-eslint/explicit-member-accessibility\n\n    this.syncBuffer = []; // eslint-disable-next-line @typescript-eslint/no-explicit-any,@typescript-eslint/explicit-member-accessibility\n\n    this.jpegDataArrays = []; // eslint-disable-next-line @typescript-eslint/no-explicit-any,@typescript-eslint/explicit-member-accessibility\n\n    this.hasRendered = [];\n    this.presentation = new DefaultPresentation_1.default();\n    this.policy = new ScaleToFitPresentationPolicy_1.default();\n    this.viewport = null;\n    this.content = null;\n    this.dragObserver = null;\n    this.resizeObserver = resizeObserverFactory.create(function () {\n      return _this.updatePresentation && _this.updatePresentation();\n    });\n  }\n\n  DefaultScreenViewingDeltaRenderer.make2DArray = function (columns, rows) {\n    var arr = [];\n\n    for (var i = 0; i < rows; i++) {\n      arr[i] = new Array(columns);\n    }\n\n    return arr;\n  };\n\n  DefaultScreenViewingDeltaRenderer.prototype.buildViewer = function (imageDimensions) {\n    this.logger.info(\"DefaultScreenViewingDeltaRenderer: Building viewer with info \" + JSON.stringify(imageDimensions));\n    this.syncBuffer = DefaultScreenViewingDeltaRenderer.make2DArray(imageDimensions.screenWidth, imageDimensions.screenHeight);\n    this.jpegDataArrays = DefaultScreenViewingDeltaRenderer.make2DArray(imageDimensions.screenWidth, imageDimensions.screenHeight);\n    this.hasRendered = DefaultScreenViewingDeltaRenderer.make2DArray(imageDimensions.screenWidth, imageDimensions.screenHeight);\n    this.jpegDecoderInstance = this.jpegDecoderController.createInstance(imageDimensions.macroBlock, imageDimensions.macroBlock);\n    this.imageDimensions = imageDimensions;\n  };\n\n  DefaultScreenViewingDeltaRenderer.prototype.resizeAndSync = function () {\n    if (!this.imageDimensions || !this.jpegDecoderInstance) {\n      return;\n    }\n\n    var now = this.window.performance.now();\n\n    if (!this.content || now - this.lastResizeAndSyncTime < DefaultScreenViewingDeltaRenderer.SYNC_TIMEOUT_MS) {\n      return;\n    }\n\n    this.logger.debug(function () {\n      return \"DefaultScreenViewingDeltaRenderer: sync'ing\";\n    });\n\n    if (this.content.width !== this.imageDimensions.imageWidthPixels || this.content.height !== this.imageDimensions.imageHeightPixels) {\n      this.content.width = this.imageDimensions.imageWidthPixels;\n      this.content.height = this.imageDimensions.imageHeightPixels;\n      this.updatePresentation && this.updatePresentation();\n    }\n\n    this.renderSync();\n    this.lastResizeAndSyncTime = this.window.performance.now();\n  };\n\n  DefaultScreenViewingDeltaRenderer.prototype.renderSync = function () {\n    this.logger.debug(function () {\n      return \"DefaultScreenViewingDeltaRenderer: Rendering sync\";\n    });\n    var context = this.getContext();\n\n    if (!context) {\n      return;\n    }\n\n    var _loop_1 = function _loop_1(row) {\n      var _loop_2 = function _loop_2(col) {\n        var dx = col * this_1.imageDimensions.macroBlock;\n        var dy = row * this_1.imageDimensions.macroBlock;\n        var rendered = this_1.hasRendered[row][col];\n        var jpegDataArray = this_1.jpegDataArrays[row][col];\n\n        if (!jpegDataArray || rendered) {\n          return \"continue\";\n        }\n\n        var imageData = this_1.getImageData(jpegDataArray);\n\n        if (!imageData) {\n          return \"continue\";\n        }\n\n        context.putImageData(imageData, dx, dy);\n        this_1.hasRendered[row][col] = true;\n        this_1.logger.debug(function () {\n          return \"rendered row=\" + row + \" col=\" + col;\n        });\n      };\n\n      for (var col = 0; col < this_1.imageDimensions.screenWidth; col++) {\n        _loop_2(col);\n      }\n    };\n\n    var this_1 = this;\n\n    for (var row = 0; row < this.imageDimensions.screenHeight; row++) {\n      _loop_1(row);\n    }\n  };\n\n  DefaultScreenViewingDeltaRenderer.prototype.getImageData = function (jpegDataArray) {\n    try {\n      return this.jpegDecoderInstance.decodeToImageData(jpegDataArray);\n    } catch (e) {\n      this.logger.error(e);\n    }\n  };\n\n  DefaultScreenViewingDeltaRenderer.prototype.getContext = function () {\n    return this.content && this.content.getContext('2d');\n  };\n\n  DefaultScreenViewingDeltaRenderer.prototype.close = function () {\n    this.logger.info(\"DefaultScreenViewingDeltaRenderer: Closing\");\n    this.getContext() && this.getContext().clearRect(0, 0, this.content.width, this.content.height);\n    this.viewport && this.viewport.removeChild(this.content);\n    this.dragObserver && this.dragObserver.unobserve();\n    this.content = null;\n    this.viewport = null;\n    this.dragObserver = null;\n  };\n\n  DefaultScreenViewingDeltaRenderer.prototype.setViewport = function (viewport) {\n    var _this = this;\n\n    if (this.viewport || this.content) {\n      this.logger.warn('Current view must be closed before starting anew');\n      return;\n    }\n\n    this.viewport = viewport;\n    this.content = this.window.document.createElement('canvas');\n    this.viewport.prepend(this.content);\n    this.resizeObserver.observe(viewport);\n    this.dragObserver = this.dragObserverFactory(this.window, function (dragEvent) {\n      dragEvent.type !== DragType_1.default.BEGIN && _this.updatePresentation && _this.updatePresentation({\n        type: PresentationPolicy_1.ZoomType.NONE\n      }, dragEvent);\n    }, viewport);\n\n    if (this.imageDimensions) {\n      this.hasRendered = DefaultScreenViewingDeltaRenderer.make2DArray(this.imageDimensions.screenWidth, this.imageDimensions.screenHeight);\n    }\n  };\n\n  DefaultScreenViewingDeltaRenderer.prototype.hideViewport = function () {\n    if (this.content) {\n      this.content.style.display = 'none';\n    }\n  };\n\n  DefaultScreenViewingDeltaRenderer.prototype.revealViewport = function () {\n    if (this.content) {\n      this.content.style.display = 'block';\n    }\n  };\n\n  DefaultScreenViewingDeltaRenderer.prototype.changePresentationPolicy = function (policy) {\n    this.policy = policy;\n    this.updatePresentation();\n  };\n\n  DefaultScreenViewingDeltaRenderer.prototype.zoomRelative = function (relativeZoomFactor) {\n    this.updatePresentation({\n      type: PresentationPolicy_1.ZoomType.ZOOM,\n      relativeFactor: relativeZoomFactor\n    });\n  };\n\n  DefaultScreenViewingDeltaRenderer.prototype.zoomAbsolute = function (absoluteZoomFactor) {\n    this.updatePresentation({\n      type: PresentationPolicy_1.ZoomType.ZOOM,\n      absoluteFactor: absoluteZoomFactor\n    });\n  };\n\n  DefaultScreenViewingDeltaRenderer.prototype.zoomReset = function () {\n    this.updatePresentation({\n      type: PresentationPolicy_1.ZoomType.RESET\n    });\n  };\n\n  DefaultScreenViewingDeltaRenderer.prototype.updatePresentation = function (zoomEvent, dragEvent) {\n    this.imageDimensions && this.viewport && this.content && this.presentation.present(PresentationElementFactory_1.default.createSource(this.imageDimensions), PresentationElementFactory_1.default.createViewport(this.viewport, this.window), PresentationElementFactory_1.default.createContent(this.content, this.window), this.policy, zoomEvent, dragEvent);\n  };\n\n  DefaultScreenViewingDeltaRenderer.SYNC_TIMEOUT_MS = 500;\n  return DefaultScreenViewingDeltaRenderer;\n}();\n\nexports.default = DefaultScreenViewingDeltaRenderer;","map":{"version":3,"sources":["../../../src/screenviewing/deltarenderer/DefaultScreenViewingDeltaRenderer.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\n// Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar DragType_1 = require(\"../../dragobserver/DragType\");\nvar DefaultPresentation_1 = require(\"../../presentation/DefaultPresentation\");\nvar PresentationPolicy_1 = require(\"../../presentation/policy/PresentationPolicy\");\nvar ScaleToFitPresentationPolicy_1 = require(\"../../presentation/policy/ScaleToFitPresentationPolicy\");\nvar PresentationElementFactory_1 = require(\"../../presentation/PresentationElementFactory\");\nvar DefaultScreenViewingDeltaRenderer = /** @class */ (function () {\n    function DefaultScreenViewingDeltaRenderer(jpegDecoderController, logger, window, resizeObserverFactory, dragObserverFactory) {\n        var _this = this;\n        this.jpegDecoderController = jpegDecoderController;\n        this.logger = logger;\n        this.window = window;\n        this.dragObserverFactory = dragObserverFactory;\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any,@typescript-eslint/explicit-member-accessibility\n        this.syncBuffer = [];\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any,@typescript-eslint/explicit-member-accessibility\n        this.jpegDataArrays = [];\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any,@typescript-eslint/explicit-member-accessibility\n        this.hasRendered = [];\n        this.presentation = new DefaultPresentation_1.default();\n        this.policy = new ScaleToFitPresentationPolicy_1.default();\n        this.viewport = null;\n        this.content = null;\n        this.dragObserver = null;\n        this.resizeObserver = resizeObserverFactory.create(function () { return _this.updatePresentation && _this.updatePresentation(); });\n    }\n    DefaultScreenViewingDeltaRenderer.make2DArray = function (columns, rows) {\n        var arr = [];\n        for (var i = 0; i < rows; i++) {\n            arr[i] = new Array(columns);\n        }\n        return arr;\n    };\n    DefaultScreenViewingDeltaRenderer.prototype.buildViewer = function (imageDimensions) {\n        this.logger.info(\"DefaultScreenViewingDeltaRenderer: Building viewer with info \" + JSON.stringify(imageDimensions));\n        this.syncBuffer = DefaultScreenViewingDeltaRenderer.make2DArray(imageDimensions.screenWidth, imageDimensions.screenHeight);\n        this.jpegDataArrays = DefaultScreenViewingDeltaRenderer.make2DArray(imageDimensions.screenWidth, imageDimensions.screenHeight);\n        this.hasRendered = DefaultScreenViewingDeltaRenderer.make2DArray(imageDimensions.screenWidth, imageDimensions.screenHeight);\n        this.jpegDecoderInstance = this.jpegDecoderController.createInstance(imageDimensions.macroBlock, imageDimensions.macroBlock);\n        this.imageDimensions = imageDimensions;\n    };\n    DefaultScreenViewingDeltaRenderer.prototype.resizeAndSync = function () {\n        if (!this.imageDimensions || !this.jpegDecoderInstance) {\n            return;\n        }\n        var now = this.window.performance.now();\n        if (!this.content ||\n            now - this.lastResizeAndSyncTime < DefaultScreenViewingDeltaRenderer.SYNC_TIMEOUT_MS) {\n            return;\n        }\n        this.logger.debug(function () { return \"DefaultScreenViewingDeltaRenderer: sync'ing\"; });\n        if (this.content.width !== this.imageDimensions.imageWidthPixels ||\n            this.content.height !== this.imageDimensions.imageHeightPixels) {\n            this.content.width = this.imageDimensions.imageWidthPixels;\n            this.content.height = this.imageDimensions.imageHeightPixels;\n            this.updatePresentation && this.updatePresentation();\n        }\n        this.renderSync();\n        this.lastResizeAndSyncTime = this.window.performance.now();\n    };\n    DefaultScreenViewingDeltaRenderer.prototype.renderSync = function () {\n        this.logger.debug(function () { return \"DefaultScreenViewingDeltaRenderer: Rendering sync\"; });\n        var context = this.getContext();\n        if (!context) {\n            return;\n        }\n        var _loop_1 = function (row) {\n            var _loop_2 = function (col) {\n                var dx = col * this_1.imageDimensions.macroBlock;\n                var dy = row * this_1.imageDimensions.macroBlock;\n                var rendered = this_1.hasRendered[row][col];\n                var jpegDataArray = this_1.jpegDataArrays[row][col];\n                if (!jpegDataArray || rendered) {\n                    return \"continue\";\n                }\n                var imageData = this_1.getImageData(jpegDataArray);\n                if (!imageData) {\n                    return \"continue\";\n                }\n                context.putImageData(imageData, dx, dy);\n                this_1.hasRendered[row][col] = true;\n                this_1.logger.debug(function () { return \"rendered row=\" + row + \" col=\" + col; });\n            };\n            for (var col = 0; col < this_1.imageDimensions.screenWidth; col++) {\n                _loop_2(col);\n            }\n        };\n        var this_1 = this;\n        for (var row = 0; row < this.imageDimensions.screenHeight; row++) {\n            _loop_1(row);\n        }\n    };\n    DefaultScreenViewingDeltaRenderer.prototype.getImageData = function (jpegDataArray) {\n        try {\n            return this.jpegDecoderInstance.decodeToImageData(jpegDataArray);\n        }\n        catch (e) {\n            this.logger.error(e);\n        }\n    };\n    DefaultScreenViewingDeltaRenderer.prototype.getContext = function () {\n        return this.content && this.content.getContext('2d');\n    };\n    DefaultScreenViewingDeltaRenderer.prototype.close = function () {\n        this.logger.info(\"DefaultScreenViewingDeltaRenderer: Closing\");\n        this.getContext() && this.getContext().clearRect(0, 0, this.content.width, this.content.height);\n        this.viewport && this.viewport.removeChild(this.content);\n        this.dragObserver && this.dragObserver.unobserve();\n        this.content = null;\n        this.viewport = null;\n        this.dragObserver = null;\n    };\n    DefaultScreenViewingDeltaRenderer.prototype.setViewport = function (viewport) {\n        var _this = this;\n        if (this.viewport || this.content) {\n            this.logger.warn('Current view must be closed before starting anew');\n            return;\n        }\n        this.viewport = viewport;\n        this.content = this.window.document.createElement('canvas');\n        this.viewport.prepend(this.content);\n        this.resizeObserver.observe(viewport);\n        this.dragObserver = this.dragObserverFactory(this.window, function (dragEvent) {\n            dragEvent.type !== DragType_1.default.BEGIN &&\n                _this.updatePresentation &&\n                _this.updatePresentation({\n                    type: PresentationPolicy_1.ZoomType.NONE,\n                }, dragEvent);\n        }, viewport);\n        if (this.imageDimensions) {\n            this.hasRendered = DefaultScreenViewingDeltaRenderer.make2DArray(this.imageDimensions.screenWidth, this.imageDimensions.screenHeight);\n        }\n    };\n    DefaultScreenViewingDeltaRenderer.prototype.hideViewport = function () {\n        if (this.content) {\n            this.content.style.display = 'none';\n        }\n    };\n    DefaultScreenViewingDeltaRenderer.prototype.revealViewport = function () {\n        if (this.content) {\n            this.content.style.display = 'block';\n        }\n    };\n    DefaultScreenViewingDeltaRenderer.prototype.changePresentationPolicy = function (policy) {\n        this.policy = policy;\n        this.updatePresentation();\n    };\n    DefaultScreenViewingDeltaRenderer.prototype.zoomRelative = function (relativeZoomFactor) {\n        this.updatePresentation({\n            type: PresentationPolicy_1.ZoomType.ZOOM,\n            relativeFactor: relativeZoomFactor,\n        });\n    };\n    DefaultScreenViewingDeltaRenderer.prototype.zoomAbsolute = function (absoluteZoomFactor) {\n        this.updatePresentation({\n            type: PresentationPolicy_1.ZoomType.ZOOM,\n            absoluteFactor: absoluteZoomFactor,\n        });\n    };\n    DefaultScreenViewingDeltaRenderer.prototype.zoomReset = function () {\n        this.updatePresentation({\n            type: PresentationPolicy_1.ZoomType.RESET,\n        });\n    };\n    DefaultScreenViewingDeltaRenderer.prototype.updatePresentation = function (zoomEvent, dragEvent) {\n        this.imageDimensions &&\n            this.viewport &&\n            this.content &&\n            this.presentation.present(PresentationElementFactory_1.default.createSource(this.imageDimensions), PresentationElementFactory_1.default.createViewport(this.viewport, this.window), PresentationElementFactory_1.default.createContent(this.content, this.window), this.policy, zoomEvent, dragEvent);\n    };\n    DefaultScreenViewingDeltaRenderer.SYNC_TIMEOUT_MS = 500;\n    return DefaultScreenViewingDeltaRenderer;\n}());\nexports.default = DefaultScreenViewingDeltaRenderer;\n//# sourceMappingURL=DefaultScreenViewingDeltaRenderer.js.map"]},"metadata":{},"sourceType":"script"}