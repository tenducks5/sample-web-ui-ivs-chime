{"ast":null,"code":"\"use strict\"; // Copyright 2019-2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function () {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n\n        case 7:\n          op = _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n\n            _.ops.push(op);\n\n            break;\n          }\n\n          if (t[2]) _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n      }\n\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nvar __values = this && this.__values || function (o) {\n  var s = typeof Symbol === \"function\" && Symbol.iterator,\n      m = s && o[s],\n      i = 0;\n  if (m) return m.call(o);\n  if (o && typeof o.length === \"number\") return {\n    next: function () {\n      if (o && i >= o.length) o = void 0;\n      return {\n        value: o && o[i++],\n        done: !o\n      };\n    }\n  };\n  throw new TypeError(s ? \"Object is not iterable.\" : \"Symbol.iterator is not defined.\");\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar BaseTask_1 = require(\"./BaseTask\");\n/*\n * [[CreatePeerConnectionTask]] sets up the peer connection object.\n */\n\n\nvar CreatePeerConnectionTask =\n/** @class */\nfunction (_super) {\n  __extends(CreatePeerConnectionTask, _super);\n\n  function CreatePeerConnectionTask(context) {\n    var _this = _super.call(this, context.logger) || this;\n\n    _this.context = context;\n    _this.taskName = 'CreatePeerConnectionTask';\n    _this.removeTrackAddedEventListener = null;\n    _this.removeTrackRemovedEventListeners = {};\n    _this.trackEvents = ['ended', 'mute', 'unmute', 'isolationchange', 'overconstrained'];\n    _this.removeVideoTrackEventListeners = {};\n\n    _this.trackAddedHandler = function (event) {\n      var track = event.track;\n\n      _this.context.logger.info(\"received track event: kind=\" + track.kind + \" id=\" + track.id + \" label=\" + track.label);\n\n      if (event.transceiver && event.transceiver.currentDirection === 'inactive') {\n        return;\n      }\n\n      if (event.streams.length === 0) {\n        _this.context.logger.warn(\"Track event but no stream\");\n\n        return;\n      }\n\n      var stream = event.streams[0];\n\n      if (track.kind === 'audio') {\n        _this.context.audioMixController.bindAudioStream(stream);\n      } else if (track.kind === 'video' && !_this.trackIsVideoInput(track)) {\n        _this.addRemoteVideoTrack(track, stream);\n      }\n    };\n\n    return _this;\n  }\n\n  CreatePeerConnectionTask.prototype.removeObserver = function () {\n    this.removeTrackAddedEventListener && this.removeTrackAddedEventListener();\n\n    for (var trackId in this.removeTrackRemovedEventListeners) {\n      this.removeTrackRemovedEventListeners[trackId]();\n    }\n  };\n\n  CreatePeerConnectionTask.prototype.addPeerConnectionEventLogger = function () {\n    var _this = this;\n\n    var peer = this.context.peer;\n    peer.addEventListener('connectionstatechange', function () {\n      _this.context.logger.info(\"peer connection state changed: \" + peer.connectionState);\n    });\n    peer.addEventListener('negotiationneeded', function () {\n      _this.context.logger.info('peer connection negotiation is needed');\n    });\n    peer.addEventListener('icegatheringstatechange', function () {\n      _this.context.logger.info(\"peer connection ice gathering state changed: \" + peer.iceGatheringState);\n    });\n    peer.addEventListener('icecandidate', function (event) {\n      _this.context.logger.info(\"peer connection ice candidate: \" + (event.candidate ? event.candidate.candidate : '(null)'));\n    });\n    peer.addEventListener('iceconnectionstatechange', function () {\n      _this.context.logger.info(\"peer connection ice connection state changed: \" + peer.iceConnectionState);\n    });\n  };\n\n  CreatePeerConnectionTask.prototype.run = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var hasTurnCredentials, configuration, connectionConstraints;\n\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        this.context.removableObservers.push(this);\n        hasTurnCredentials = this.context.turnCredentials && this.context.turnCredentials.uris.length > 0;\n        configuration = hasTurnCredentials ? {\n          iceServers: [{\n            urls: this.context.turnCredentials.uris,\n            username: this.context.turnCredentials.username,\n            credential: this.context.turnCredentials.password,\n            credentialType: 'password'\n          }],\n          iceTransportPolicy: 'relay'\n        } : {};\n        configuration.bundlePolicy = this.context.browserBehavior.requiresBundlePolicy(); // @ts-ignore\n\n        configuration.sdpSemantics = this.context.browserBehavior.requiresUnifiedPlan() ? 'unified-plan' : 'plan-b'; // @ts-ignore\n\n        this.logger.info(\"SDP semantics are \" + configuration.sdpSemantics);\n        connectionConstraints = {\n          optional: [{\n            googHighStartBitrate: 0\n          }, {\n            googCpuOveruseDetection: false\n          }, {\n            googCpuOveruseEncodeUsage: false\n          }, {\n            googCpuUnderuseThreshold: 55\n          }, {\n            googCpuOveruseThreshold: 150\n          }, {\n            googCombinedAudioVideoBwe: true\n          }]\n        };\n\n        if (this.context.peer) {\n          this.context.logger.info('reusing peer connection');\n        } else {\n          this.context.logger.info('creating new peer connection'); // @ts-ignore\n\n          this.context.peer = new RTCPeerConnection(configuration, connectionConstraints);\n          this.addPeerConnectionEventLogger();\n        }\n\n        this.removeTrackAddedEventListener = function () {\n          if (_this.context.peer) {\n            _this.context.peer.removeEventListener('track', _this.trackAddedHandler);\n          }\n\n          _this.removeTrackAddedEventListener = null;\n        };\n\n        this.context.peer.addEventListener('track', this.trackAddedHandler);\n        return [2\n        /*return*/\n        ];\n      });\n    });\n  };\n\n  CreatePeerConnectionTask.prototype.trackIsVideoInput = function (track) {\n    if (this.context.transceiverController.useTransceivers()) {\n      this.logger.debug(function () {\n        return \"getting video track type (unified-plan)\";\n      });\n      return this.context.transceiverController.trackIsVideoInput(track);\n    }\n\n    this.logger.debug(function () {\n      return \"getting video track type (plan-b)\";\n    });\n\n    if (this.context.activeVideoInput) {\n      var tracks = this.context.activeVideoInput.getVideoTracks();\n\n      if (tracks && tracks.length > 0 && tracks[0].id === track.id) {\n        return true;\n      }\n    }\n\n    return false;\n  };\n\n  CreatePeerConnectionTask.prototype.addRemoteVideoTrack = function (track, stream) {\n    var _this = this;\n\n    var trackId = stream.id;\n\n    if (!this.context.browserBehavior.requiresUnifiedPlan()) {\n      stream = new MediaStream([track]);\n      trackId = track.id;\n    }\n\n    var attendeeId = this.context.videoStreamIndex.attendeeIdForTrack(trackId);\n\n    if (this.context.videoTileController.haveVideoTileForAttendeeId(attendeeId)) {\n      this.context.logger.info(\"Not adding remote track. Already have tile for attendeeId:  \" + attendeeId);\n      return;\n    }\n\n    var tile = this.context.videoTileController.addVideoTile();\n    var streamId = this.context.videoStreamIndex.streamIdForTrack(trackId);\n\n    if (typeof streamId === 'undefined') {\n      this.logger.warn(\"stream not found for tile=\" + tile.id() + \" track=\" + trackId);\n      streamId = null;\n    }\n\n    var _loop_1 = function (i) {\n      var trackEvent = this_1.trackEvents[i];\n      var videoTracks = stream.getVideoTracks();\n\n      if (videoTracks && videoTracks.length) {\n        var videoTrack_1 = videoTracks[0];\n\n        var callback_1 = function () {\n          _this.context.logger.info(\"received the \" + trackEvent + \" event for tile=\" + tile.id() + \" id=\" + track.id + \" streamId=\" + streamId);\n\n          if (trackEvent === 'ended' && _this.context.browserBehavior.requiresUnifiedPlan()) {\n            _this.removeRemoteVideoTrack(track, tile.state());\n          }\n        };\n\n        videoTrack_1.addEventListener(trackEvent, callback_1);\n\n        if (!this_1.removeVideoTrackEventListeners[track.id]) {\n          this_1.removeVideoTrackEventListeners[track.id] = [];\n        }\n\n        this_1.removeVideoTrackEventListeners[track.id].push(function () {\n          videoTrack_1.removeEventListener(trackEvent, callback_1);\n        });\n      }\n    };\n\n    var this_1 = this;\n\n    for (var i = 0; i < this.trackEvents.length; i++) {\n      _loop_1(i);\n    }\n\n    var width;\n    var height;\n\n    if (track.getSettings) {\n      var cap = track.getSettings();\n      width = cap.width;\n      height = cap.height;\n    } else {\n      var cap = track.getCapabilities();\n      width = cap.width;\n      height = cap.height;\n    }\n\n    var externalUserId = this.context.videoStreamIndex.externalUserIdForTrack(trackId);\n    tile.bindVideoStream(attendeeId, false, stream, width, height, streamId, externalUserId);\n    this.logger.info(\"video track added, created tile=\" + tile.id() + \" track=\" + trackId + \" streamId=\" + streamId);\n    var endEvent = 'removetrack';\n    var target = stream;\n\n    if (!this.context.browserBehavior.requiresUnifiedPlan()) {\n      this.logger.debug(function () {\n        return 'updating end event and target track (plan-b)';\n      });\n      endEvent = 'ended'; // @ts-ignore\n\n      target = track;\n    }\n\n    var trackRemovedHandler = function () {\n      return _this.removeRemoteVideoTrack(track, tile.state());\n    };\n\n    this.removeTrackRemovedEventListeners[track.id] = function () {\n      target.removeEventListener(endEvent, trackRemovedHandler);\n      delete _this.removeTrackRemovedEventListeners[track.id];\n    };\n\n    target.addEventListener(endEvent, trackRemovedHandler);\n  };\n\n  CreatePeerConnectionTask.prototype.removeRemoteVideoTrack = function (track, tileState) {\n    var e_1, _a;\n\n    if (this.removeTrackRemovedEventListeners.hasOwnProperty(track.id)) {\n      this.removeTrackRemovedEventListeners[track.id]();\n\n      try {\n        for (var _b = __values(this.removeVideoTrackEventListeners[track.id]), _c = _b.next(); !_c.done; _c = _b.next()) {\n          var removeVideoTrackEventListener = _c.value;\n          removeVideoTrackEventListener();\n        }\n      } catch (e_1_1) {\n        e_1 = {\n          error: e_1_1\n        };\n      } finally {\n        try {\n          if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\n        } finally {\n          if (e_1) throw e_1.error;\n        }\n      }\n\n      delete this.removeVideoTrackEventListeners[track.id];\n    }\n\n    this.logger.info(\"video track ended, removing tile=\" + tileState.tileId + \" id=\" + track.id + \" stream=\" + tileState.streamId);\n\n    if (tileState.streamId) {\n      this.context.videosPaused.remove(tileState.streamId);\n    } else {\n      this.logger.warn(\"no stream found for tile=\" + tileState.tileId);\n    }\n\n    this.context.videoTileController.removeVideoTile(tileState.tileId);\n  };\n\n  CreatePeerConnectionTask.REMOVE_HANDLER_INTERVAL_MS = 10000;\n  return CreatePeerConnectionTask;\n}(BaseTask_1.default);\n\nexports.default = CreatePeerConnectionTask;","map":{"version":3,"sources":["../../src/task/CreatePeerConnectionTask.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\n// Copyright 2019-2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nvar __values = (this && this.__values) || function(o) {\n    var s = typeof Symbol === \"function\" && Symbol.iterator, m = s && o[s], i = 0;\n    if (m) return m.call(o);\n    if (o && typeof o.length === \"number\") return {\n        next: function () {\n            if (o && i >= o.length) o = void 0;\n            return { value: o && o[i++], done: !o };\n        }\n    };\n    throw new TypeError(s ? \"Object is not iterable.\" : \"Symbol.iterator is not defined.\");\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar BaseTask_1 = require(\"./BaseTask\");\n/*\n * [[CreatePeerConnectionTask]] sets up the peer connection object.\n */\nvar CreatePeerConnectionTask = /** @class */ (function (_super) {\n    __extends(CreatePeerConnectionTask, _super);\n    function CreatePeerConnectionTask(context) {\n        var _this = _super.call(this, context.logger) || this;\n        _this.context = context;\n        _this.taskName = 'CreatePeerConnectionTask';\n        _this.removeTrackAddedEventListener = null;\n        _this.removeTrackRemovedEventListeners = {};\n        _this.trackEvents = [\n            'ended',\n            'mute',\n            'unmute',\n            'isolationchange',\n            'overconstrained',\n        ];\n        _this.removeVideoTrackEventListeners = {};\n        _this.trackAddedHandler = function (event) {\n            var track = event.track;\n            _this.context.logger.info(\"received track event: kind=\" + track.kind + \" id=\" + track.id + \" label=\" + track.label);\n            if (event.transceiver && event.transceiver.currentDirection === 'inactive') {\n                return;\n            }\n            if (event.streams.length === 0) {\n                _this.context.logger.warn(\"Track event but no stream\");\n                return;\n            }\n            var stream = event.streams[0];\n            if (track.kind === 'audio') {\n                _this.context.audioMixController.bindAudioStream(stream);\n            }\n            else if (track.kind === 'video' && !_this.trackIsVideoInput(track)) {\n                _this.addRemoteVideoTrack(track, stream);\n            }\n        };\n        return _this;\n    }\n    CreatePeerConnectionTask.prototype.removeObserver = function () {\n        this.removeTrackAddedEventListener && this.removeTrackAddedEventListener();\n        for (var trackId in this.removeTrackRemovedEventListeners) {\n            this.removeTrackRemovedEventListeners[trackId]();\n        }\n    };\n    CreatePeerConnectionTask.prototype.addPeerConnectionEventLogger = function () {\n        var _this = this;\n        var peer = this.context.peer;\n        peer.addEventListener('connectionstatechange', function () {\n            _this.context.logger.info(\"peer connection state changed: \" + peer.connectionState);\n        });\n        peer.addEventListener('negotiationneeded', function () {\n            _this.context.logger.info('peer connection negotiation is needed');\n        });\n        peer.addEventListener('icegatheringstatechange', function () {\n            _this.context.logger.info(\"peer connection ice gathering state changed: \" + peer.iceGatheringState);\n        });\n        peer.addEventListener('icecandidate', function (event) {\n            _this.context.logger.info(\"peer connection ice candidate: \" + (event.candidate ? event.candidate.candidate : '(null)'));\n        });\n        peer.addEventListener('iceconnectionstatechange', function () {\n            _this.context.logger.info(\"peer connection ice connection state changed: \" + peer.iceConnectionState);\n        });\n    };\n    CreatePeerConnectionTask.prototype.run = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var hasTurnCredentials, configuration, connectionConstraints;\n            var _this = this;\n            return __generator(this, function (_a) {\n                this.context.removableObservers.push(this);\n                hasTurnCredentials = this.context.turnCredentials && this.context.turnCredentials.uris.length > 0;\n                configuration = hasTurnCredentials\n                    ? {\n                        iceServers: [\n                            {\n                                urls: this.context.turnCredentials.uris,\n                                username: this.context.turnCredentials.username,\n                                credential: this.context.turnCredentials.password,\n                                credentialType: 'password',\n                            },\n                        ],\n                        iceTransportPolicy: 'relay',\n                    }\n                    : {};\n                configuration.bundlePolicy = this.context.browserBehavior.requiresBundlePolicy();\n                // @ts-ignore\n                configuration.sdpSemantics = this.context.browserBehavior.requiresUnifiedPlan()\n                    ? 'unified-plan'\n                    : 'plan-b';\n                // @ts-ignore\n                this.logger.info(\"SDP semantics are \" + configuration.sdpSemantics);\n                connectionConstraints = {\n                    optional: [\n                        { googHighStartBitrate: 0 },\n                        { googCpuOveruseDetection: false },\n                        { googCpuOveruseEncodeUsage: false },\n                        { googCpuUnderuseThreshold: 55 },\n                        { googCpuOveruseThreshold: 150 },\n                        { googCombinedAudioVideoBwe: true },\n                    ],\n                };\n                if (this.context.peer) {\n                    this.context.logger.info('reusing peer connection');\n                }\n                else {\n                    this.context.logger.info('creating new peer connection');\n                    // @ts-ignore\n                    this.context.peer = new RTCPeerConnection(configuration, connectionConstraints);\n                    this.addPeerConnectionEventLogger();\n                }\n                this.removeTrackAddedEventListener = function () {\n                    if (_this.context.peer) {\n                        _this.context.peer.removeEventListener('track', _this.trackAddedHandler);\n                    }\n                    _this.removeTrackAddedEventListener = null;\n                };\n                this.context.peer.addEventListener('track', this.trackAddedHandler);\n                return [2 /*return*/];\n            });\n        });\n    };\n    CreatePeerConnectionTask.prototype.trackIsVideoInput = function (track) {\n        if (this.context.transceiverController.useTransceivers()) {\n            this.logger.debug(function () {\n                return \"getting video track type (unified-plan)\";\n            });\n            return this.context.transceiverController.trackIsVideoInput(track);\n        }\n        this.logger.debug(function () {\n            return \"getting video track type (plan-b)\";\n        });\n        if (this.context.activeVideoInput) {\n            var tracks = this.context.activeVideoInput.getVideoTracks();\n            if (tracks && tracks.length > 0 && tracks[0].id === track.id) {\n                return true;\n            }\n        }\n        return false;\n    };\n    CreatePeerConnectionTask.prototype.addRemoteVideoTrack = function (track, stream) {\n        var _this = this;\n        var trackId = stream.id;\n        if (!this.context.browserBehavior.requiresUnifiedPlan()) {\n            stream = new MediaStream([track]);\n            trackId = track.id;\n        }\n        var attendeeId = this.context.videoStreamIndex.attendeeIdForTrack(trackId);\n        if (this.context.videoTileController.haveVideoTileForAttendeeId(attendeeId)) {\n            this.context.logger.info(\"Not adding remote track. Already have tile for attendeeId:  \" + attendeeId);\n            return;\n        }\n        var tile = this.context.videoTileController.addVideoTile();\n        var streamId = this.context.videoStreamIndex.streamIdForTrack(trackId);\n        if (typeof streamId === 'undefined') {\n            this.logger.warn(\"stream not found for tile=\" + tile.id() + \" track=\" + trackId);\n            streamId = null;\n        }\n        var _loop_1 = function (i) {\n            var trackEvent = this_1.trackEvents[i];\n            var videoTracks = stream.getVideoTracks();\n            if (videoTracks && videoTracks.length) {\n                var videoTrack_1 = videoTracks[0];\n                var callback_1 = function () {\n                    _this.context.logger.info(\"received the \" + trackEvent + \" event for tile=\" + tile.id() + \" id=\" + track.id + \" streamId=\" + streamId);\n                    if (trackEvent === 'ended' && _this.context.browserBehavior.requiresUnifiedPlan()) {\n                        _this.removeRemoteVideoTrack(track, tile.state());\n                    }\n                };\n                videoTrack_1.addEventListener(trackEvent, callback_1);\n                if (!this_1.removeVideoTrackEventListeners[track.id]) {\n                    this_1.removeVideoTrackEventListeners[track.id] = [];\n                }\n                this_1.removeVideoTrackEventListeners[track.id].push(function () {\n                    videoTrack_1.removeEventListener(trackEvent, callback_1);\n                });\n            }\n        };\n        var this_1 = this;\n        for (var i = 0; i < this.trackEvents.length; i++) {\n            _loop_1(i);\n        }\n        var width;\n        var height;\n        if (track.getSettings) {\n            var cap = track.getSettings();\n            width = cap.width;\n            height = cap.height;\n        }\n        else {\n            var cap = track.getCapabilities();\n            width = cap.width;\n            height = cap.height;\n        }\n        var externalUserId = this.context.videoStreamIndex.externalUserIdForTrack(trackId);\n        tile.bindVideoStream(attendeeId, false, stream, width, height, streamId, externalUserId);\n        this.logger.info(\"video track added, created tile=\" + tile.id() + \" track=\" + trackId + \" streamId=\" + streamId);\n        var endEvent = 'removetrack';\n        var target = stream;\n        if (!this.context.browserBehavior.requiresUnifiedPlan()) {\n            this.logger.debug(function () {\n                return 'updating end event and target track (plan-b)';\n            });\n            endEvent = 'ended';\n            // @ts-ignore\n            target = track;\n        }\n        var trackRemovedHandler = function () { return _this.removeRemoteVideoTrack(track, tile.state()); };\n        this.removeTrackRemovedEventListeners[track.id] = function () {\n            target.removeEventListener(endEvent, trackRemovedHandler);\n            delete _this.removeTrackRemovedEventListeners[track.id];\n        };\n        target.addEventListener(endEvent, trackRemovedHandler);\n    };\n    CreatePeerConnectionTask.prototype.removeRemoteVideoTrack = function (track, tileState) {\n        var e_1, _a;\n        if (this.removeTrackRemovedEventListeners.hasOwnProperty(track.id)) {\n            this.removeTrackRemovedEventListeners[track.id]();\n            try {\n                for (var _b = __values(this.removeVideoTrackEventListeners[track.id]), _c = _b.next(); !_c.done; _c = _b.next()) {\n                    var removeVideoTrackEventListener = _c.value;\n                    removeVideoTrackEventListener();\n                }\n            }\n            catch (e_1_1) { e_1 = { error: e_1_1 }; }\n            finally {\n                try {\n                    if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\n                }\n                finally { if (e_1) throw e_1.error; }\n            }\n            delete this.removeVideoTrackEventListeners[track.id];\n        }\n        this.logger.info(\"video track ended, removing tile=\" + tileState.tileId + \" id=\" + track.id + \" stream=\" + tileState.streamId);\n        if (tileState.streamId) {\n            this.context.videosPaused.remove(tileState.streamId);\n        }\n        else {\n            this.logger.warn(\"no stream found for tile=\" + tileState.tileId);\n        }\n        this.context.videoTileController.removeVideoTile(tileState.tileId);\n    };\n    CreatePeerConnectionTask.REMOVE_HANDLER_INTERVAL_MS = 10000;\n    return CreatePeerConnectionTask;\n}(BaseTask_1.default));\nexports.default = CreatePeerConnectionTask;\n//# sourceMappingURL=CreatePeerConnectionTask.js.map"]},"metadata":{},"sourceType":"script"}