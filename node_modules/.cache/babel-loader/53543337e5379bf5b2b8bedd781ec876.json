{"ast":null,"code":"\"use strict\"; // Copyright 2019-2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n\nvar __extends = this && this.__extends || function () {\n  var _extendStatics = function extendStatics(d, b) {\n    _extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) {\n        if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n      }\n    };\n\n    return _extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    _extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar BaseConnectionHealthPolicy_1 = require(\"./BaseConnectionHealthPolicy\");\n\nvar ReconnectionHealthPolicy =\n/** @class */\nfunction (_super) {\n  __extends(ReconnectionHealthPolicy, _super);\n\n  function ReconnectionHealthPolicy(logger, configuration, data) {\n    var _this = _super.call(this, configuration, data) || this;\n\n    _this.logger = logger;\n    _this.audioDelayPointsOverMaximum = 0;\n    ReconnectionHealthPolicy.CONNECTION_UNHEALTHY_THRESHOLD = configuration.connectionUnhealthyThreshold;\n    ReconnectionHealthPolicy.CONNECTION_WAIT_TIME_MS = configuration.connectionWaitTimeMs;\n    ReconnectionHealthPolicy.MISSED_PONGS_THRESHOLD = configuration.missedPongsUpperThreshold;\n    ReconnectionHealthPolicy.MAXIMUM_AUDIO_DELAY_MS = configuration.maximumAudioDelayMs;\n    ReconnectionHealthPolicy.MAXIMUM_AUDIO_DELAY_DATA_POINTS = configuration.maximumAudioDelayDataPoints;\n    return _this;\n  }\n\n  ReconnectionHealthPolicy.prototype.health = function () {\n    var connectionStartedRecently = this.currentData.isConnectionStartRecent(ReconnectionHealthPolicy.CONNECTION_WAIT_TIME_MS);\n\n    if (connectionStartedRecently) {\n      return 1;\n    }\n\n    var noPacketsReceivedRecently = this.currentData.consecutiveStatsWithNoPackets >= ReconnectionHealthPolicy.CONNECTION_UNHEALTHY_THRESHOLD;\n    var missedPongsRecently = this.currentData.consecutiveMissedPongs >= ReconnectionHealthPolicy.MISSED_PONGS_THRESHOLD;\n\n    if (this.currentData.audioSpeakerDelayMs > ReconnectionHealthPolicy.MAXIMUM_AUDIO_DELAY_MS) {\n      this.audioDelayPointsOverMaximum += 1;\n    } else {\n      this.audioDelayPointsOverMaximum = 0;\n    }\n\n    var hasBadAudioDelay = this.audioDelayPointsOverMaximum > ReconnectionHealthPolicy.MAXIMUM_AUDIO_DELAY_DATA_POINTS;\n\n    if (hasBadAudioDelay) {\n      this.audioDelayPointsOverMaximum = 0;\n    }\n\n    var needsReconnect = noPacketsReceivedRecently || missedPongsRecently || hasBadAudioDelay;\n\n    if (needsReconnect) {\n      this.logger.warn(\"reconnection recommended due to: no packets received: \" + noPacketsReceivedRecently + \", missed pongs: \" + missedPongsRecently + \", bad audio delay: \" + hasBadAudioDelay);\n      return 0;\n    }\n\n    return 1;\n  };\n\n  return ReconnectionHealthPolicy;\n}(BaseConnectionHealthPolicy_1.default);\n\nexports.default = ReconnectionHealthPolicy;","map":{"version":3,"sources":["../../src/connectionhealthpolicy/ReconnectionHealthPolicy.ts"],"names":[],"mappings":"cAAA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGA,IAAA,4BAAA,GAAA,OAAA,CAAA,8BAAA,CAAA;;AAKA,IAAA,wBAAA;AAAA;AAAA,UAAA,MAAA,EAAA;AACU,EAAA,SAAA,CAAA,wBAAA,EAAA,MAAA,CAAA;;AAUR,WAAA,wBAAA,CACU,MADV,EAEE,aAFF,EAGE,IAHF,EAG4B;AAH5B,QAAA,KAAA,GAKE,MAAA,CAAA,IAAA,CAAA,IAAA,EAAM,aAAN,EAAqB,IAArB,KAA0B,IAL5B;;AACU,IAAA,KAAA,CAAA,MAAA,GAAA,MAAA;AAHF,IAAA,KAAA,CAAA,2BAAA,GAA8B,CAA9B;AAQN,IAAA,wBAAwB,CAAC,8BAAzB,GACE,aAAa,CAAC,4BADhB;AAEA,IAAA,wBAAwB,CAAC,uBAAzB,GAAmD,aAAa,CAAC,oBAAjE;AACA,IAAA,wBAAwB,CAAC,sBAAzB,GAAkD,aAAa,CAAC,yBAAhE;AACA,IAAA,wBAAwB,CAAC,sBAAzB,GAAkD,aAAa,CAAC,mBAAhE;AACA,IAAA,wBAAwB,CAAC,+BAAzB,GACE,aAAa,CAAC,2BADhB;;AAED;;AAED,EAAA,wBAAA,CAAA,SAAA,CAAA,MAAA,GAAA,YAAA;AACE,QAAM,yBAAyB,GAAG,KAAK,WAAL,CAAiB,uBAAjB,CAChC,wBAAwB,CAAC,uBADO,CAAlC;;AAGA,QAAI,yBAAJ,EAA+B;AAC7B,aAAO,CAAP;AACD;;AACD,QAAM,yBAAyB,GAC7B,KAAK,WAAL,CAAiB,6BAAjB,IACA,wBAAwB,CAAC,8BAF3B;AAGA,QAAM,mBAAmB,GACvB,KAAK,WAAL,CAAiB,sBAAjB,IAA2C,wBAAwB,CAAC,sBADtE;;AAEA,QAAI,KAAK,WAAL,CAAiB,mBAAjB,GAAuC,wBAAwB,CAAC,sBAApE,EAA4F;AAC1F,WAAK,2BAAL,IAAoC,CAApC;AACD,KAFD,MAEO;AACL,WAAK,2BAAL,GAAmC,CAAnC;AACD;;AACD,QAAM,gBAAgB,GACpB,KAAK,2BAAL,GAAmC,wBAAwB,CAAC,+BAD9D;;AAEA,QAAI,gBAAJ,EAAsB;AACpB,WAAK,2BAAL,GAAmC,CAAnC;AACD;;AACD,QAAM,cAAc,GAAG,yBAAyB,IAAI,mBAA7B,IAAoD,gBAA3E;;AACA,QAAI,cAAJ,EAAoB;AAClB,WAAK,MAAL,CAAY,IAAZ,CACE,2DAAyD,yBAAzD,GAAkF,kBAAlF,GAAqG,mBAArG,GAAwH,qBAAxH,GAA8I,gBADhJ;AAGA,aAAO,CAAP;AACD;;AACD,WAAO,CAAP;AACD,GA9BD;;AA+BF,SAAA,wBAAA;AAAC,CAzDD,CACU,4BAAA,CAAA,OADV,CAAA","sourceRoot":"","sourcesContent":["\"use strict\";\n// Copyright 2019-2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar BaseConnectionHealthPolicy_1 = require(\"./BaseConnectionHealthPolicy\");\nvar ReconnectionHealthPolicy = /** @class */ (function (_super) {\n    __extends(ReconnectionHealthPolicy, _super);\n    function ReconnectionHealthPolicy(logger, configuration, data) {\n        var _this = _super.call(this, configuration, data) || this;\n        _this.logger = logger;\n        _this.audioDelayPointsOverMaximum = 0;\n        ReconnectionHealthPolicy.CONNECTION_UNHEALTHY_THRESHOLD =\n            configuration.connectionUnhealthyThreshold;\n        ReconnectionHealthPolicy.CONNECTION_WAIT_TIME_MS = configuration.connectionWaitTimeMs;\n        ReconnectionHealthPolicy.MISSED_PONGS_THRESHOLD = configuration.missedPongsUpperThreshold;\n        ReconnectionHealthPolicy.MAXIMUM_AUDIO_DELAY_MS = configuration.maximumAudioDelayMs;\n        ReconnectionHealthPolicy.MAXIMUM_AUDIO_DELAY_DATA_POINTS =\n            configuration.maximumAudioDelayDataPoints;\n        return _this;\n    }\n    ReconnectionHealthPolicy.prototype.health = function () {\n        var connectionStartedRecently = this.currentData.isConnectionStartRecent(ReconnectionHealthPolicy.CONNECTION_WAIT_TIME_MS);\n        if (connectionStartedRecently) {\n            return 1;\n        }\n        var noPacketsReceivedRecently = this.currentData.consecutiveStatsWithNoPackets >=\n            ReconnectionHealthPolicy.CONNECTION_UNHEALTHY_THRESHOLD;\n        var missedPongsRecently = this.currentData.consecutiveMissedPongs >= ReconnectionHealthPolicy.MISSED_PONGS_THRESHOLD;\n        if (this.currentData.audioSpeakerDelayMs > ReconnectionHealthPolicy.MAXIMUM_AUDIO_DELAY_MS) {\n            this.audioDelayPointsOverMaximum += 1;\n        }\n        else {\n            this.audioDelayPointsOverMaximum = 0;\n        }\n        var hasBadAudioDelay = this.audioDelayPointsOverMaximum > ReconnectionHealthPolicy.MAXIMUM_AUDIO_DELAY_DATA_POINTS;\n        if (hasBadAudioDelay) {\n            this.audioDelayPointsOverMaximum = 0;\n        }\n        var needsReconnect = noPacketsReceivedRecently || missedPongsRecently || hasBadAudioDelay;\n        if (needsReconnect) {\n            this.logger.warn(\"reconnection recommended due to: no packets received: \" + noPacketsReceivedRecently + \", missed pongs: \" + missedPongsRecently + \", bad audio delay: \" + hasBadAudioDelay);\n            return 0;\n        }\n        return 1;\n    };\n    return ReconnectionHealthPolicy;\n}(BaseConnectionHealthPolicy_1.default));\nexports.default = ReconnectionHealthPolicy;\n//# sourceMappingURL=ReconnectionHealthPolicy.js.map"]},"metadata":{},"sourceType":"script"}