{"ast":null,"code":"\"use strict\"; // Copyright 2019-2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar DefaultVideoCaptureAndEncodeParameter_1 = require(\"../videocaptureandencodeparameter/DefaultVideoCaptureAndEncodeParameter\");\n/** NScaleVideoUplinkBandwidthPolicy implements capture and encode\n *  parameters that are nearly equivalent to those chosen by the\n *  traditional native clients, except for a modification to\n *  maxBandwidthKbps described below. */\n\n\nvar NScaleVideoUplinkBandwidthPolicy =\n/** @class */\nfunction () {\n  function NScaleVideoUplinkBandwidthPolicy(selfAttendeeId) {\n    this.selfAttendeeId = selfAttendeeId;\n    this.numParticipants = 0;\n    this.idealMaxBandwidthKbps = 1400;\n    this.hasBandwidthPriority = false;\n    this.optimalParameters = new DefaultVideoCaptureAndEncodeParameter_1.default(0, 0, 0, 0, false);\n    this.parametersInEffect = new DefaultVideoCaptureAndEncodeParameter_1.default(0, 0, 0, 0, false);\n  }\n\n  NScaleVideoUplinkBandwidthPolicy.prototype.updateConnectionMetric = function (_metrics) {\n    return;\n  };\n\n  NScaleVideoUplinkBandwidthPolicy.prototype.chooseMediaTrackConstraints = function () {\n    return {};\n  };\n\n  NScaleVideoUplinkBandwidthPolicy.prototype.chooseEncodingParameters = function () {\n    return new Map();\n  };\n\n  NScaleVideoUplinkBandwidthPolicy.prototype.updateIndex = function (videoIndex) {\n    // the +1 for self is assuming that we intend to send video, since\n    // the context here is VideoUplinkBandwidthPolicy\n    this.numParticipants = videoIndex.numberOfVideoPublishingParticipantsExcludingSelf(this.selfAttendeeId) + 1;\n    this.optimalParameters = new DefaultVideoCaptureAndEncodeParameter_1.default(this.captureWidth(), this.captureHeight(), this.captureFrameRate(), this.maxBandwidthKbps(), false);\n  };\n\n  NScaleVideoUplinkBandwidthPolicy.prototype.wantsResubscribe = function () {\n    return !this.parametersInEffect.equal(this.optimalParameters);\n  };\n\n  NScaleVideoUplinkBandwidthPolicy.prototype.chooseCaptureAndEncodeParameters = function () {\n    this.parametersInEffect = this.optimalParameters.clone();\n    return this.parametersInEffect.clone();\n  };\n\n  NScaleVideoUplinkBandwidthPolicy.prototype.captureWidth = function () {\n    var width = 640;\n\n    if (this.numParticipants > 4) {\n      width = 320;\n    }\n\n    return width;\n  };\n\n  NScaleVideoUplinkBandwidthPolicy.prototype.captureHeight = function () {\n    var height = 384;\n\n    if (this.numParticipants > 4) {\n      height = 192;\n    }\n\n    return height;\n  };\n\n  NScaleVideoUplinkBandwidthPolicy.prototype.captureFrameRate = function () {\n    return 15;\n  };\n\n  NScaleVideoUplinkBandwidthPolicy.prototype.maxBandwidthKbps = function () {\n    if (this.hasBandwidthPriority) {\n      return Math.trunc(this.idealMaxBandwidthKbps);\n    }\n\n    var rate = 0;\n\n    if (this.numParticipants <= 2) {\n      rate = this.idealMaxBandwidthKbps;\n    } else if (this.numParticipants <= 4) {\n      rate = this.idealMaxBandwidthKbps * 2 / 3;\n    } else {\n      rate = (544 / 11 + 14880 / (11 * this.numParticipants)) / 600 * this.idealMaxBandwidthKbps;\n    }\n\n    return Math.trunc(rate);\n  };\n\n  NScaleVideoUplinkBandwidthPolicy.prototype.setIdealMaxBandwidthKbps = function (idealMaxBandwidthKbps) {\n    this.idealMaxBandwidthKbps = idealMaxBandwidthKbps;\n  };\n\n  NScaleVideoUplinkBandwidthPolicy.prototype.setHasBandwidthPriority = function (hasBandwidthPriority) {\n    this.hasBandwidthPriority = hasBandwidthPriority;\n  };\n\n  return NScaleVideoUplinkBandwidthPolicy;\n}();\n\nexports.default = NScaleVideoUplinkBandwidthPolicy;","map":{"version":3,"sources":["../../src/videouplinkbandwidthpolicy/NScaleVideoUplinkBandwidthPolicy.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\n// Copyright 2019-2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar DefaultVideoCaptureAndEncodeParameter_1 = require(\"../videocaptureandencodeparameter/DefaultVideoCaptureAndEncodeParameter\");\n/** NScaleVideoUplinkBandwidthPolicy implements capture and encode\n *  parameters that are nearly equivalent to those chosen by the\n *  traditional native clients, except for a modification to\n *  maxBandwidthKbps described below. */\nvar NScaleVideoUplinkBandwidthPolicy = /** @class */ (function () {\n    function NScaleVideoUplinkBandwidthPolicy(selfAttendeeId) {\n        this.selfAttendeeId = selfAttendeeId;\n        this.numParticipants = 0;\n        this.idealMaxBandwidthKbps = 1400;\n        this.hasBandwidthPriority = false;\n        this.optimalParameters = new DefaultVideoCaptureAndEncodeParameter_1.default(0, 0, 0, 0, false);\n        this.parametersInEffect = new DefaultVideoCaptureAndEncodeParameter_1.default(0, 0, 0, 0, false);\n    }\n    NScaleVideoUplinkBandwidthPolicy.prototype.updateConnectionMetric = function (_metrics) {\n        return;\n    };\n    NScaleVideoUplinkBandwidthPolicy.prototype.chooseMediaTrackConstraints = function () {\n        return {};\n    };\n    NScaleVideoUplinkBandwidthPolicy.prototype.chooseEncodingParameters = function () {\n        return new Map();\n    };\n    NScaleVideoUplinkBandwidthPolicy.prototype.updateIndex = function (videoIndex) {\n        // the +1 for self is assuming that we intend to send video, since\n        // the context here is VideoUplinkBandwidthPolicy\n        this.numParticipants =\n            videoIndex.numberOfVideoPublishingParticipantsExcludingSelf(this.selfAttendeeId) + 1;\n        this.optimalParameters = new DefaultVideoCaptureAndEncodeParameter_1.default(this.captureWidth(), this.captureHeight(), this.captureFrameRate(), this.maxBandwidthKbps(), false);\n    };\n    NScaleVideoUplinkBandwidthPolicy.prototype.wantsResubscribe = function () {\n        return !this.parametersInEffect.equal(this.optimalParameters);\n    };\n    NScaleVideoUplinkBandwidthPolicy.prototype.chooseCaptureAndEncodeParameters = function () {\n        this.parametersInEffect = this.optimalParameters.clone();\n        return this.parametersInEffect.clone();\n    };\n    NScaleVideoUplinkBandwidthPolicy.prototype.captureWidth = function () {\n        var width = 640;\n        if (this.numParticipants > 4) {\n            width = 320;\n        }\n        return width;\n    };\n    NScaleVideoUplinkBandwidthPolicy.prototype.captureHeight = function () {\n        var height = 384;\n        if (this.numParticipants > 4) {\n            height = 192;\n        }\n        return height;\n    };\n    NScaleVideoUplinkBandwidthPolicy.prototype.captureFrameRate = function () {\n        return 15;\n    };\n    NScaleVideoUplinkBandwidthPolicy.prototype.maxBandwidthKbps = function () {\n        if (this.hasBandwidthPriority) {\n            return Math.trunc(this.idealMaxBandwidthKbps);\n        }\n        var rate = 0;\n        if (this.numParticipants <= 2) {\n            rate = this.idealMaxBandwidthKbps;\n        }\n        else if (this.numParticipants <= 4) {\n            rate = (this.idealMaxBandwidthKbps * 2) / 3;\n        }\n        else {\n            rate = ((544 / 11 + 14880 / (11 * this.numParticipants)) / 600) * this.idealMaxBandwidthKbps;\n        }\n        return Math.trunc(rate);\n    };\n    NScaleVideoUplinkBandwidthPolicy.prototype.setIdealMaxBandwidthKbps = function (idealMaxBandwidthKbps) {\n        this.idealMaxBandwidthKbps = idealMaxBandwidthKbps;\n    };\n    NScaleVideoUplinkBandwidthPolicy.prototype.setHasBandwidthPriority = function (hasBandwidthPriority) {\n        this.hasBandwidthPriority = hasBandwidthPriority;\n    };\n    return NScaleVideoUplinkBandwidthPolicy;\n}());\nexports.default = NScaleVideoUplinkBandwidthPolicy;\n//# sourceMappingURL=NScaleVideoUplinkBandwidthPolicy.js.map"]},"metadata":{},"sourceType":"script"}