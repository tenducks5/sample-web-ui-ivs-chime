{"ast":null,"code":"\"use strict\"; // Copyright 2019-2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar BaseConnectionHealthPolicy_1 = require(\"./BaseConnectionHealthPolicy\");\n\nvar UnusableAudioWarningConnectionHealthPolicy =\n/** @class */\nfunction (_super) {\n  __extends(UnusableAudioWarningConnectionHealthPolicy, _super);\n\n  function UnusableAudioWarningConnectionHealthPolicy(configuration, data) {\n    var _this = _super.call(this, configuration, data) || this;\n\n    _this.coolDownTimeMs = configuration.cooldownTimeMs;\n    _this.pastSamplesToConsider = configuration.pastSamplesToConsider;\n    _this.fractionalLoss = configuration.fractionalLoss;\n    _this.packetsExpected = configuration.packetsExpected;\n    _this.maximumTimesToWarn = configuration.maximumTimesToWarn;\n    _this.lastWarnTimestampMs = 0;\n    _this.warnCount = 0;\n    return _this;\n  }\n\n  UnusableAudioWarningConnectionHealthPolicy.prototype.calculateFractionalLoss = function () {\n    if (this.currentData.packetsReceivedInLastMinute.length < this.pastSamplesToConsider) {\n      return 0;\n    }\n\n    var samplesToConsider = this.pastSamplesToConsider;\n    var totalPacketsExpected = samplesToConsider * this.packetsExpected;\n    var totalPacketsReceived = 0;\n\n    for (var i = 0; i < samplesToConsider; i++) {\n      totalPacketsReceived += this.currentData.packetsReceivedInLastMinute[i];\n    }\n\n    return Math.min(Math.max(1 - totalPacketsReceived / totalPacketsExpected, 0), 1);\n  };\n\n  UnusableAudioWarningConnectionHealthPolicy.prototype.health = function () {\n    var warnedRecently = Date.now() - this.lastWarnTimestampMs < this.coolDownTimeMs;\n\n    if (warnedRecently) {\n      return this.currentHealth;\n    }\n\n    var hasHadHighPacketLoss = this.calculateFractionalLoss() >= this.fractionalLoss;\n\n    if (hasHadHighPacketLoss) {\n      if (this.currentHealth !== 0) {\n        this.lastWarnTimestampMs = Date.now();\n        this.warnCount++;\n\n        if (this.warnCount > this.maximumTimesToWarn) {\n          return 1;\n        }\n      }\n\n      return 0;\n    }\n\n    return 1;\n  };\n\n  return UnusableAudioWarningConnectionHealthPolicy;\n}(BaseConnectionHealthPolicy_1.default);\n\nexports.default = UnusableAudioWarningConnectionHealthPolicy;","map":{"version":3,"sources":["../../src/connectionhealthpolicy/UnusableAudioWarningConnectionHealthPolicy.ts"],"names":[],"mappings":"cAAA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA,IAAA,4BAAA,GAAA,OAAA,CAAA,8BAAA,CAAA;;AAKA,IAAA,0CAAA;AAAA;AAAA,UAAA,MAAA,EAAA;AACU,EAAA,SAAA,CAAA,0CAAA,EAAA,MAAA,CAAA;;AAUR,WAAA,0CAAA,CAAY,aAAZ,EAAgE,IAAhE,EAA0F;AAA1F,QAAA,KAAA,GACE,MAAA,CAAA,IAAA,CAAA,IAAA,EAAM,aAAN,EAAqB,IAArB,KAA0B,IAD5B;;AAEE,IAAA,KAAI,CAAC,cAAL,GAAsB,aAAa,CAAC,cAApC;AACA,IAAA,KAAI,CAAC,qBAAL,GAA6B,aAAa,CAAC,qBAA3C;AACA,IAAA,KAAI,CAAC,cAAL,GAAsB,aAAa,CAAC,cAApC;AACA,IAAA,KAAI,CAAC,eAAL,GAAuB,aAAa,CAAC,eAArC;AACA,IAAA,KAAI,CAAC,kBAAL,GAA0B,aAAa,CAAC,kBAAxC;AACA,IAAA,KAAI,CAAC,mBAAL,GAA2B,CAA3B;AACA,IAAA,KAAI,CAAC,SAAL,GAAiB,CAAjB;;AACD;;AAED,EAAA,0CAAA,CAAA,SAAA,CAAA,uBAAA,GAAA,YAAA;AACE,QAAI,KAAK,WAAL,CAAiB,2BAAjB,CAA6C,MAA7C,GAAsD,KAAK,qBAA/D,EAAsF;AACpF,aAAO,CAAP;AACD;;AACD,QAAM,iBAAiB,GAAG,KAAK,qBAA/B;AAEA,QAAM,oBAAoB,GAAG,iBAAiB,GAAG,KAAK,eAAtD;AACA,QAAI,oBAAoB,GAAG,CAA3B;;AACA,SAAK,IAAI,CAAC,GAAG,CAAb,EAAgB,CAAC,GAAG,iBAApB,EAAuC,CAAC,EAAxC,EAA4C;AAC1C,MAAA,oBAAoB,IAAI,KAAK,WAAL,CAAiB,2BAAjB,CAA6C,CAA7C,CAAxB;AACD;;AACD,WAAO,IAAI,CAAC,GAAL,CAAS,IAAI,CAAC,GAAL,CAAS,IAAI,oBAAoB,GAAG,oBAApC,EAA0D,CAA1D,CAAT,EAAuE,CAAvE,CAAP;AACD,GAZD;;AAcA,EAAA,0CAAA,CAAA,SAAA,CAAA,MAAA,GAAA,YAAA;AACE,QAAM,cAAc,GAAG,IAAI,CAAC,GAAL,KAAa,KAAK,mBAAlB,GAAwC,KAAK,cAApE;;AACA,QAAI,cAAJ,EAAoB;AAClB,aAAO,KAAK,aAAZ;AACD;;AACD,QAAM,oBAAoB,GAAG,KAAK,uBAAL,MAAkC,KAAK,cAApE;;AACA,QAAI,oBAAJ,EAA0B;AACxB,UAAI,KAAK,aAAL,KAAuB,CAA3B,EAA8B;AAC5B,aAAK,mBAAL,GAA2B,IAAI,CAAC,GAAL,EAA3B;AACA,aAAK,SAAL;;AACA,YAAI,KAAK,SAAL,GAAiB,KAAK,kBAA1B,EAA8C;AAC5C,iBAAO,CAAP;AACD;AACF;;AACD,aAAO,CAAP;AACD;;AACD,WAAO,CAAP;AACD,GAjBD;;AAkBF,SAAA,0CAAA;AAAC,CAtDD,CACU,4BAAA,CAAA,OADV,CAAA","sourceRoot":"","sourcesContent":["\"use strict\";\n// Copyright 2019-2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar BaseConnectionHealthPolicy_1 = require(\"./BaseConnectionHealthPolicy\");\nvar UnusableAudioWarningConnectionHealthPolicy = /** @class */ (function (_super) {\n    __extends(UnusableAudioWarningConnectionHealthPolicy, _super);\n    function UnusableAudioWarningConnectionHealthPolicy(configuration, data) {\n        var _this = _super.call(this, configuration, data) || this;\n        _this.coolDownTimeMs = configuration.cooldownTimeMs;\n        _this.pastSamplesToConsider = configuration.pastSamplesToConsider;\n        _this.fractionalLoss = configuration.fractionalLoss;\n        _this.packetsExpected = configuration.packetsExpected;\n        _this.maximumTimesToWarn = configuration.maximumTimesToWarn;\n        _this.lastWarnTimestampMs = 0;\n        _this.warnCount = 0;\n        return _this;\n    }\n    UnusableAudioWarningConnectionHealthPolicy.prototype.calculateFractionalLoss = function () {\n        if (this.currentData.packetsReceivedInLastMinute.length < this.pastSamplesToConsider) {\n            return 0;\n        }\n        var samplesToConsider = this.pastSamplesToConsider;\n        var totalPacketsExpected = samplesToConsider * this.packetsExpected;\n        var totalPacketsReceived = 0;\n        for (var i = 0; i < samplesToConsider; i++) {\n            totalPacketsReceived += this.currentData.packetsReceivedInLastMinute[i];\n        }\n        return Math.min(Math.max(1 - totalPacketsReceived / totalPacketsExpected, 0), 1);\n    };\n    UnusableAudioWarningConnectionHealthPolicy.prototype.health = function () {\n        var warnedRecently = Date.now() - this.lastWarnTimestampMs < this.coolDownTimeMs;\n        if (warnedRecently) {\n            return this.currentHealth;\n        }\n        var hasHadHighPacketLoss = this.calculateFractionalLoss() >= this.fractionalLoss;\n        if (hasHadHighPacketLoss) {\n            if (this.currentHealth !== 0) {\n                this.lastWarnTimestampMs = Date.now();\n                this.warnCount++;\n                if (this.warnCount > this.maximumTimesToWarn) {\n                    return 1;\n                }\n            }\n            return 0;\n        }\n        return 1;\n    };\n    return UnusableAudioWarningConnectionHealthPolicy;\n}(BaseConnectionHealthPolicy_1.default));\nexports.default = UnusableAudioWarningConnectionHealthPolicy;\n//# sourceMappingURL=UnusableAudioWarningConnectionHealthPolicy.js.map"]},"metadata":{},"sourceType":"script"}