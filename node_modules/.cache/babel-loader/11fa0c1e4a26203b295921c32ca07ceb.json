{"ast":null,"code":"\"use strict\"; // Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n\nvar __values = this && this.__values || function (o) {\n  var s = typeof Symbol === \"function\" && Symbol.iterator,\n      m = s && o[s],\n      i = 0;\n  if (m) return m.call(o);\n  if (o && typeof o.length === \"number\") return {\n    next: function () {\n      if (o && i >= o.length) o = void 0;\n      return {\n        value: o && o[i++],\n        done: !o\n      };\n    }\n  };\n  throw new TypeError(s ? \"Object is not iterable.\" : \"Symbol.iterator is not defined.\");\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar Maybe_1 = require(\"../maybe/Maybe\");\n\nvar AsyncScheduler_1 = require(\"../scheduler/AsyncScheduler\");\n\nvar SimulcastLayers_1 = require(\"../simulcastlayers/SimulcastLayers\");\n\nvar SimulcastTransceiverController_1 = require(\"../transceivercontroller/SimulcastTransceiverController\");\n\nvar DefaultVideoCaptureAndEncodeParameter_1 = require(\"../videocaptureandencodeparameter/DefaultVideoCaptureAndEncodeParameter\");\n\nvar BitrateParameters_1 = require(\"./BitrateParameters\");\n/**\n * [[DefaultSimulcastUplinkPolicy]] determines capture and encode\n *  parameters that reacts to estimated uplink bandwidth\n */\n\n\nvar DefaultSimulcastUplinkPolicy =\n/** @class */\nfunction () {\n  function DefaultSimulcastUplinkPolicy(selfAttendeeId, logger) {\n    this.selfAttendeeId = selfAttendeeId;\n    this.logger = logger;\n    this.numSenders = 0;\n    this.numParticipants = -1;\n    this.newQualityMap = new Map();\n    this.currentQualityMap = new Map();\n    this.newActiveStreams = 1\n    /* kHiAndLow */\n    ;\n    this.currentActiveStreams = 1\n    /* kHiAndLow */\n    ;\n    this.lastUplinkBandwidthKbps = DefaultSimulcastUplinkPolicy.defaultUplinkBandwidthKbps;\n    this.startTimeMs = 0;\n    this.lastUpdatedMs = Date.now();\n    this.videoIndex = null;\n    this.currLocalDescriptions = [];\n    this.nextLocalDescriptions = [];\n    this.observerQueue = new Set();\n    this.optimalParameters = new DefaultVideoCaptureAndEncodeParameter_1.default(0, 0, 0, 0, true);\n    this.parametersInEffect = new DefaultVideoCaptureAndEncodeParameter_1.default(0, 0, 0, 0, true);\n    this.lastUplinkBandwidthKbps = DefaultSimulcastUplinkPolicy.defaultUplinkBandwidthKbps;\n    this.currentQualityMap = this.fillEncodingParamWithBitrates([300, 0, 1200]);\n    this.newQualityMap = this.fillEncodingParamWithBitrates([300, 0, 1200]);\n  }\n\n  DefaultSimulcastUplinkPolicy.prototype.updateConnectionMetric = function (_b) {\n    var _this = this;\n\n    var _c = _b.uplinkKbps,\n        uplinkKbps = _c === void 0 ? 0 : _c;\n\n    if (isNaN(uplinkKbps)) {\n      return;\n    } // Check if startup period in order to ignore estimate when video first enabled.\n    // If only audio was active then the estimate will be very low\n\n\n    if (this.startTimeMs === 0) {\n      this.startTimeMs = Date.now();\n    }\n\n    if (Date.now() - this.startTimeMs < DefaultSimulcastUplinkPolicy.startupDurationMs) {\n      this.lastUplinkBandwidthKbps = DefaultSimulcastUplinkPolicy.defaultUplinkBandwidthKbps;\n    } else {\n      this.lastUplinkBandwidthKbps = uplinkKbps;\n    }\n\n    this.logger.debug(function () {\n      return \"simulcast: uplink policy update metrics \" + _this.lastUplinkBandwidthKbps;\n    });\n    var holdTime = DefaultSimulcastUplinkPolicy.holdDownDurationMs;\n\n    if (this.currentActiveStreams === 3\n    /* kLow */\n    ) {\n        holdTime = DefaultSimulcastUplinkPolicy.holdDownDurationMs * 2;\n      } else if (this.currentActiveStreams === 2\n    /* kMidAndLow */\n    && uplinkKbps <= DefaultSimulcastUplinkPolicy.kMidDisabledRate || this.currentActiveStreams === 1\n    /* kHiAndLow */\n    && uplinkKbps <= DefaultSimulcastUplinkPolicy.kHiDisabledRate) {\n      holdTime = DefaultSimulcastUplinkPolicy.holdDownDurationMs / 2;\n    }\n\n    if (Date.now() < this.lastUpdatedMs + holdTime) {\n      return;\n    }\n\n    this.newQualityMap = this.calculateEncodingParameters(false);\n  };\n\n  DefaultSimulcastUplinkPolicy.prototype.calculateEncodingParameters = function (numSendersChanged) {\n    // bitrates parameter min is not used for now\n    var newBitrates = [new BitrateParameters_1.default(), new BitrateParameters_1.default(), new BitrateParameters_1.default()];\n    var hysteresisIncrease = 0,\n        hysteresisDecrease = 0;\n\n    if (this.currentActiveStreams === 0\n    /* kHi */\n    ) {\n        // Don't trigger redetermination based on rate if only one simulcast stream\n        hysteresisIncrease = this.lastUplinkBandwidthKbps + 1;\n        hysteresisDecrease = 0;\n      } else if (this.currentActiveStreams === 1\n    /* kHiAndLow */\n    ) {\n        hysteresisIncrease = 2400;\n        hysteresisDecrease = DefaultSimulcastUplinkPolicy.kHiDisabledRate;\n      } else if (this.currentActiveStreams === 2\n    /* kMidAndLow */\n    ) {\n        hysteresisIncrease = 1000;\n        hysteresisDecrease = DefaultSimulcastUplinkPolicy.kMidDisabledRate;\n      } else {\n      hysteresisIncrease = 300;\n      hysteresisDecrease = 0;\n    }\n\n    if (numSendersChanged || this.lastUplinkBandwidthKbps >= hysteresisIncrease || this.lastUplinkBandwidthKbps <= hysteresisDecrease) {\n      if (this.numParticipants >= 0 && this.numParticipants <= 2) {\n        // Simulcast disabled\n        this.newActiveStreams = 0\n        /* kHi */\n        ;\n        newBitrates[0].maxBitrateKbps = 0;\n        newBitrates[1].maxBitrateKbps = 0;\n        newBitrates[2].maxBitrateKbps = 1200;\n      } else if (this.numSenders <= 4 && this.lastUplinkBandwidthKbps >= DefaultSimulcastUplinkPolicy.kHiDisabledRate) {\n        // 320x192+ (640x384)  + 1280x768\n        this.newActiveStreams = 1\n        /* kHiAndLow */\n        ;\n        newBitrates[0].maxBitrateKbps = 300;\n        newBitrates[1].maxBitrateKbps = 0;\n        newBitrates[2].maxBitrateKbps = 1200;\n      } else if (this.lastUplinkBandwidthKbps >= DefaultSimulcastUplinkPolicy.kMidDisabledRate) {\n        // 320x192 + 640x384 + (1280x768)\n        this.newActiveStreams = 2\n        /* kMidAndLow */\n        ;\n        newBitrates[0].maxBitrateKbps = this.lastUplinkBandwidthKbps >= 350 ? 200 : 150;\n        newBitrates[1].maxBitrateKbps = this.numSenders <= 6 ? 600 : 350;\n        newBitrates[2].maxBitrateKbps = 0;\n      } else {\n        // 320x192 + 640x384 + (1280x768)\n        this.newActiveStreams = 3\n        /* kLow */\n        ;\n        newBitrates[0].maxBitrateKbps = 300;\n        newBitrates[1].maxBitrateKbps = 0;\n        newBitrates[2].maxBitrateKbps = 0;\n      }\n\n      var bitrates = newBitrates.map(function (v, _i, _a) {\n        return v.maxBitrateKbps;\n      });\n      this.newQualityMap = this.fillEncodingParamWithBitrates(bitrates);\n\n      if (!this.encodingParametersEqual()) {\n        this.logger.info(\"simulcast: policy:calculateEncodingParameters bw:\" + this.lastUplinkBandwidthKbps + \" numSources:\" + this.numSenders + \" numClients:\" + this.numParticipants + \" newQualityMap: \" + this.getQualityMapString(this.newQualityMap));\n      }\n    }\n\n    return this.newQualityMap;\n  };\n\n  DefaultSimulcastUplinkPolicy.prototype.chooseMediaTrackConstraints = function () {\n    // Changing MediaTrackConstraints causes a restart of video input and possible small\n    // scaling changes.  Always use 720p for now\n    var trackConstraint = {\n      width: {\n        ideal: 1280\n      },\n      height: {\n        ideal: 768\n      },\n      frameRate: {\n        ideal: 15\n      }\n    };\n    return trackConstraint;\n  };\n\n  DefaultSimulcastUplinkPolicy.prototype.chooseEncodingParameters = function () {\n    this.currentQualityMap = this.newQualityMap;\n    this.currentActiveStreams = this.newActiveStreams;\n\n    if (this.activeStreamsToPublish !== this.newActiveStreams) {\n      this.activeStreamsToPublish = this.newActiveStreams;\n      this.publishEncodingSimulcastLayer();\n    }\n\n    return this.currentQualityMap;\n  };\n\n  DefaultSimulcastUplinkPolicy.prototype.updateIndex = function (videoIndex) {\n    // the +1 for self is assuming that we intend to send video, since\n    // the context here is VideoUplinkBandwidthPolicy\n    var numSenders = videoIndex.numberOfVideoPublishingParticipantsExcludingSelf(this.selfAttendeeId) + 1;\n    var numParticipants = videoIndex.numberOfParticipants();\n    var numSendersChanged = numSenders !== this.numSenders;\n    var numParticipantsChanged = numParticipants > 2 && this.numParticipants <= 2 || numParticipants <= 2 && this.numParticipants > 2;\n    this.numSenders = numSenders;\n    this.numParticipants = numParticipants;\n    this.optimalParameters = new DefaultVideoCaptureAndEncodeParameter_1.default(this.captureWidth(), this.captureHeight(), this.captureFrameRate(), this.maxBandwidthKbps(), false);\n    this.videoIndex = videoIndex;\n    this.newQualityMap = this.calculateEncodingParameters(numSendersChanged || numParticipantsChanged);\n  };\n\n  DefaultSimulcastUplinkPolicy.prototype.wantsResubscribe = function () {\n    var constraintDiff = !this.encodingParametersEqual();\n    this.nextLocalDescriptions = this.videoIndex.localStreamDescriptions();\n\n    var _loop_1 = function (i) {\n      var streamId = this_1.nextLocalDescriptions[i].streamId;\n\n      if (streamId !== 0 && !!streamId) {\n        var prevIndex = this_1.currLocalDescriptions.findIndex(function (val) {\n          return val.streamId === streamId;\n        });\n\n        if (prevIndex !== -1) {\n          if (this_1.nextLocalDescriptions[i].disabledByWebRTC !== this_1.currLocalDescriptions[prevIndex].disabledByWebRTC) {\n            constraintDiff = true;\n          }\n        }\n      }\n    };\n\n    var this_1 = this;\n\n    for (var i = 0; i < this.nextLocalDescriptions.length; i++) {\n      _loop_1(i);\n    }\n\n    if (constraintDiff) {\n      this.lastUpdatedMs = Date.now();\n    }\n\n    this.currLocalDescriptions = this.nextLocalDescriptions;\n    return constraintDiff;\n  };\n\n  DefaultSimulcastUplinkPolicy.prototype.compareEncodingParameter = function (encoding1, encoding2) {\n    return JSON.stringify(encoding1) === JSON.stringify(encoding2);\n  };\n\n  DefaultSimulcastUplinkPolicy.prototype.encodingParametersEqual = function () {\n    var e_1, _b;\n\n    var different = false;\n\n    try {\n      for (var _c = __values(SimulcastTransceiverController_1.default.NAME_ARR_ASCENDING), _d = _c.next(); !_d.done; _d = _c.next()) {\n        var ridName = _d.value;\n        different = different || !this.compareEncodingParameter(this.newQualityMap.get(ridName), this.currentQualityMap.get(ridName));\n\n        if (different) {\n          break;\n        }\n      }\n    } catch (e_1_1) {\n      e_1 = {\n        error: e_1_1\n      };\n    } finally {\n      try {\n        if (_d && !_d.done && (_b = _c.return)) _b.call(_c);\n      } finally {\n        if (e_1) throw e_1.error;\n      }\n    }\n\n    return !different;\n  };\n\n  DefaultSimulcastUplinkPolicy.prototype.chooseCaptureAndEncodeParameters = function () {\n    // should deprecate in this policy\n    this.parametersInEffect = this.optimalParameters.clone();\n    return this.parametersInEffect.clone();\n  };\n\n  DefaultSimulcastUplinkPolicy.prototype.captureWidth = function () {\n    // should deprecate in this policy\n    var width = 1280;\n    return width;\n  };\n\n  DefaultSimulcastUplinkPolicy.prototype.captureHeight = function () {\n    // should deprecate in this policy\n    var height = 768;\n    return height;\n  };\n\n  DefaultSimulcastUplinkPolicy.prototype.captureFrameRate = function () {\n    // should deprecate in this policy\n    return 15;\n  };\n\n  DefaultSimulcastUplinkPolicy.prototype.maxBandwidthKbps = function () {\n    // should deprecate in this policy\n    return 1400;\n  };\n\n  DefaultSimulcastUplinkPolicy.prototype.setIdealMaxBandwidthKbps = function (_idealMaxBandwidthKbps) {// should deprecate in this policy\n  };\n\n  DefaultSimulcastUplinkPolicy.prototype.setHasBandwidthPriority = function (_hasBandwidthPriority) {// should deprecate in this policy\n  };\n\n  DefaultSimulcastUplinkPolicy.prototype.fillEncodingParamWithBitrates = function (bitratesKbps) {\n    var newMap = new Map();\n    var toBps = 1000;\n    var nameArr = SimulcastTransceiverController_1.default.NAME_ARR_ASCENDING;\n    var bitrateArr = bitratesKbps;\n    var scale = 4;\n\n    for (var i = 0; i < nameArr.length; i++) {\n      var ridName = nameArr[i];\n      newMap.set(ridName, {\n        rid: ridName,\n        active: bitrateArr[i] > 0 ? true : false,\n        scaleResolutionDownBy: scale,\n        maxBitrate: bitrateArr[i] * toBps\n      });\n      scale = scale / 2;\n    }\n\n    return newMap;\n  };\n\n  DefaultSimulcastUplinkPolicy.prototype.getQualityMapString = function (params) {\n    var qualityString = '';\n    var localDescriptions = this.videoIndex.localStreamDescriptions();\n\n    if (localDescriptions.length === 3) {\n      params.forEach(function (value) {\n        var disabledByWebRTC = false;\n        if (value.rid === 'low') disabledByWebRTC = localDescriptions[0].disabledByWebRTC;else if (value.rid === 'mid') disabledByWebRTC = localDescriptions[1].disabledByWebRTC;else disabledByWebRTC = localDescriptions[2].disabledByWebRTC;\n        qualityString += \"{ rid: \" + value.rid + \" active:\" + value.active + \" disabledByWebRTC: \" + disabledByWebRTC + \" maxBitrate:\" + value.maxBitrate + \"}\";\n      });\n    }\n\n    return qualityString;\n  };\n\n  DefaultSimulcastUplinkPolicy.prototype.getEncodingSimulcastLayer = function (activeStreams) {\n    switch (activeStreams) {\n      case 0\n      /* kHi */\n      :\n        return SimulcastLayers_1.default.High;\n\n      case 1\n      /* kHiAndLow */\n      :\n        return SimulcastLayers_1.default.LowAndHigh;\n\n      case 2\n      /* kMidAndLow */\n      :\n        return SimulcastLayers_1.default.LowAndMedium;\n\n      case 3\n      /* kLow */\n      :\n        return SimulcastLayers_1.default.Low;\n    }\n  };\n\n  DefaultSimulcastUplinkPolicy.prototype.publishEncodingSimulcastLayer = function () {\n    var simulcastLayers = this.getEncodingSimulcastLayer(this.activeStreamsToPublish);\n    this.forEachObserver(function (observer) {\n      Maybe_1.default.of(observer.encodingSimulcastLayersDidChange).map(function (f) {\n        return f.bind(observer)(simulcastLayers);\n      });\n    });\n  };\n\n  DefaultSimulcastUplinkPolicy.prototype.addObserver = function (observer) {\n    this.logger.info('adding simulcast uplink observer');\n    this.observerQueue.add(observer);\n  };\n\n  DefaultSimulcastUplinkPolicy.prototype.removeObserver = function (observer) {\n    this.logger.info('removing simulcast uplink observer');\n    this.observerQueue.delete(observer);\n  };\n\n  DefaultSimulcastUplinkPolicy.prototype.forEachObserver = function (observerFunc) {\n    var e_2, _b;\n\n    var _this = this;\n\n    var _loop_2 = function (observer) {\n      new AsyncScheduler_1.default().start(function () {\n        if (_this.observerQueue.has(observer)) {\n          observerFunc(observer);\n        }\n      });\n    };\n\n    try {\n      for (var _c = __values(this.observerQueue), _d = _c.next(); !_d.done; _d = _c.next()) {\n        var observer = _d.value;\n\n        _loop_2(observer);\n      }\n    } catch (e_2_1) {\n      e_2 = {\n        error: e_2_1\n      };\n    } finally {\n      try {\n        if (_d && !_d.done && (_b = _c.return)) _b.call(_c);\n      } finally {\n        if (e_2) throw e_2.error;\n      }\n    }\n  };\n\n  DefaultSimulcastUplinkPolicy.defaultUplinkBandwidthKbps = 1200;\n  DefaultSimulcastUplinkPolicy.startupDurationMs = 6000;\n  DefaultSimulcastUplinkPolicy.holdDownDurationMs = 4000;\n  DefaultSimulcastUplinkPolicy.defaultMaxFrameRate = 15; // Current rough estimates where webrtc disables streams\n\n  DefaultSimulcastUplinkPolicy.kHiDisabledRate = 700;\n  DefaultSimulcastUplinkPolicy.kMidDisabledRate = 240;\n  return DefaultSimulcastUplinkPolicy;\n}();\n\nexports.default = DefaultSimulcastUplinkPolicy;","map":{"version":3,"sources":["../../src/videouplinkbandwidthpolicy/DefaultSimulcastUplinkPolicy.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\n// Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nvar __values = (this && this.__values) || function(o) {\n    var s = typeof Symbol === \"function\" && Symbol.iterator, m = s && o[s], i = 0;\n    if (m) return m.call(o);\n    if (o && typeof o.length === \"number\") return {\n        next: function () {\n            if (o && i >= o.length) o = void 0;\n            return { value: o && o[i++], done: !o };\n        }\n    };\n    throw new TypeError(s ? \"Object is not iterable.\" : \"Symbol.iterator is not defined.\");\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar Maybe_1 = require(\"../maybe/Maybe\");\nvar AsyncScheduler_1 = require(\"../scheduler/AsyncScheduler\");\nvar SimulcastLayers_1 = require(\"../simulcastlayers/SimulcastLayers\");\nvar SimulcastTransceiverController_1 = require(\"../transceivercontroller/SimulcastTransceiverController\");\nvar DefaultVideoCaptureAndEncodeParameter_1 = require(\"../videocaptureandencodeparameter/DefaultVideoCaptureAndEncodeParameter\");\nvar BitrateParameters_1 = require(\"./BitrateParameters\");\n/**\n * [[DefaultSimulcastUplinkPolicy]] determines capture and encode\n *  parameters that reacts to estimated uplink bandwidth\n */\nvar DefaultSimulcastUplinkPolicy = /** @class */ (function () {\n    function DefaultSimulcastUplinkPolicy(selfAttendeeId, logger) {\n        this.selfAttendeeId = selfAttendeeId;\n        this.logger = logger;\n        this.numSenders = 0;\n        this.numParticipants = -1;\n        this.newQualityMap = new Map();\n        this.currentQualityMap = new Map();\n        this.newActiveStreams = 1 /* kHiAndLow */;\n        this.currentActiveStreams = 1 /* kHiAndLow */;\n        this.lastUplinkBandwidthKbps = DefaultSimulcastUplinkPolicy.defaultUplinkBandwidthKbps;\n        this.startTimeMs = 0;\n        this.lastUpdatedMs = Date.now();\n        this.videoIndex = null;\n        this.currLocalDescriptions = [];\n        this.nextLocalDescriptions = [];\n        this.observerQueue = new Set();\n        this.optimalParameters = new DefaultVideoCaptureAndEncodeParameter_1.default(0, 0, 0, 0, true);\n        this.parametersInEffect = new DefaultVideoCaptureAndEncodeParameter_1.default(0, 0, 0, 0, true);\n        this.lastUplinkBandwidthKbps = DefaultSimulcastUplinkPolicy.defaultUplinkBandwidthKbps;\n        this.currentQualityMap = this.fillEncodingParamWithBitrates([300, 0, 1200]);\n        this.newQualityMap = this.fillEncodingParamWithBitrates([300, 0, 1200]);\n    }\n    DefaultSimulcastUplinkPolicy.prototype.updateConnectionMetric = function (_b) {\n        var _this = this;\n        var _c = _b.uplinkKbps, uplinkKbps = _c === void 0 ? 0 : _c;\n        if (isNaN(uplinkKbps)) {\n            return;\n        }\n        // Check if startup period in order to ignore estimate when video first enabled.\n        // If only audio was active then the estimate will be very low\n        if (this.startTimeMs === 0) {\n            this.startTimeMs = Date.now();\n        }\n        if (Date.now() - this.startTimeMs < DefaultSimulcastUplinkPolicy.startupDurationMs) {\n            this.lastUplinkBandwidthKbps = DefaultSimulcastUplinkPolicy.defaultUplinkBandwidthKbps;\n        }\n        else {\n            this.lastUplinkBandwidthKbps = uplinkKbps;\n        }\n        this.logger.debug(function () {\n            return \"simulcast: uplink policy update metrics \" + _this.lastUplinkBandwidthKbps;\n        });\n        var holdTime = DefaultSimulcastUplinkPolicy.holdDownDurationMs;\n        if (this.currentActiveStreams === 3 /* kLow */) {\n            holdTime = DefaultSimulcastUplinkPolicy.holdDownDurationMs * 2;\n        }\n        else if ((this.currentActiveStreams === 2 /* kMidAndLow */ &&\n            uplinkKbps <= DefaultSimulcastUplinkPolicy.kMidDisabledRate) ||\n            (this.currentActiveStreams === 1 /* kHiAndLow */ &&\n                uplinkKbps <= DefaultSimulcastUplinkPolicy.kHiDisabledRate)) {\n            holdTime = DefaultSimulcastUplinkPolicy.holdDownDurationMs / 2;\n        }\n        if (Date.now() < this.lastUpdatedMs + holdTime) {\n            return;\n        }\n        this.newQualityMap = this.calculateEncodingParameters(false);\n    };\n    DefaultSimulcastUplinkPolicy.prototype.calculateEncodingParameters = function (numSendersChanged) {\n        // bitrates parameter min is not used for now\n        var newBitrates = [\n            new BitrateParameters_1.default(),\n            new BitrateParameters_1.default(),\n            new BitrateParameters_1.default(),\n        ];\n        var hysteresisIncrease = 0, hysteresisDecrease = 0;\n        if (this.currentActiveStreams === 0 /* kHi */) {\n            // Don't trigger redetermination based on rate if only one simulcast stream\n            hysteresisIncrease = this.lastUplinkBandwidthKbps + 1;\n            hysteresisDecrease = 0;\n        }\n        else if (this.currentActiveStreams === 1 /* kHiAndLow */) {\n            hysteresisIncrease = 2400;\n            hysteresisDecrease = DefaultSimulcastUplinkPolicy.kHiDisabledRate;\n        }\n        else if (this.currentActiveStreams === 2 /* kMidAndLow */) {\n            hysteresisIncrease = 1000;\n            hysteresisDecrease = DefaultSimulcastUplinkPolicy.kMidDisabledRate;\n        }\n        else {\n            hysteresisIncrease = 300;\n            hysteresisDecrease = 0;\n        }\n        if (numSendersChanged ||\n            this.lastUplinkBandwidthKbps >= hysteresisIncrease ||\n            this.lastUplinkBandwidthKbps <= hysteresisDecrease) {\n            if (this.numParticipants >= 0 && this.numParticipants <= 2) {\n                // Simulcast disabled\n                this.newActiveStreams = 0 /* kHi */;\n                newBitrates[0].maxBitrateKbps = 0;\n                newBitrates[1].maxBitrateKbps = 0;\n                newBitrates[2].maxBitrateKbps = 1200;\n            }\n            else if (this.numSenders <= 4 &&\n                this.lastUplinkBandwidthKbps >= DefaultSimulcastUplinkPolicy.kHiDisabledRate) {\n                // 320x192+ (640x384)  + 1280x768\n                this.newActiveStreams = 1 /* kHiAndLow */;\n                newBitrates[0].maxBitrateKbps = 300;\n                newBitrates[1].maxBitrateKbps = 0;\n                newBitrates[2].maxBitrateKbps = 1200;\n            }\n            else if (this.lastUplinkBandwidthKbps >= DefaultSimulcastUplinkPolicy.kMidDisabledRate) {\n                // 320x192 + 640x384 + (1280x768)\n                this.newActiveStreams = 2 /* kMidAndLow */;\n                newBitrates[0].maxBitrateKbps = this.lastUplinkBandwidthKbps >= 350 ? 200 : 150;\n                newBitrates[1].maxBitrateKbps = this.numSenders <= 6 ? 600 : 350;\n                newBitrates[2].maxBitrateKbps = 0;\n            }\n            else {\n                // 320x192 + 640x384 + (1280x768)\n                this.newActiveStreams = 3 /* kLow */;\n                newBitrates[0].maxBitrateKbps = 300;\n                newBitrates[1].maxBitrateKbps = 0;\n                newBitrates[2].maxBitrateKbps = 0;\n            }\n            var bitrates = newBitrates.map(function (v, _i, _a) {\n                return v.maxBitrateKbps;\n            });\n            this.newQualityMap = this.fillEncodingParamWithBitrates(bitrates);\n            if (!this.encodingParametersEqual()) {\n                this.logger.info(\"simulcast: policy:calculateEncodingParameters bw:\" + this.lastUplinkBandwidthKbps + \" numSources:\" + this.numSenders + \" numClients:\" + this.numParticipants + \" newQualityMap: \" + this.getQualityMapString(this.newQualityMap));\n            }\n        }\n        return this.newQualityMap;\n    };\n    DefaultSimulcastUplinkPolicy.prototype.chooseMediaTrackConstraints = function () {\n        // Changing MediaTrackConstraints causes a restart of video input and possible small\n        // scaling changes.  Always use 720p for now\n        var trackConstraint = {\n            width: { ideal: 1280 },\n            height: { ideal: 768 },\n            frameRate: { ideal: 15 },\n        };\n        return trackConstraint;\n    };\n    DefaultSimulcastUplinkPolicy.prototype.chooseEncodingParameters = function () {\n        this.currentQualityMap = this.newQualityMap;\n        this.currentActiveStreams = this.newActiveStreams;\n        if (this.activeStreamsToPublish !== this.newActiveStreams) {\n            this.activeStreamsToPublish = this.newActiveStreams;\n            this.publishEncodingSimulcastLayer();\n        }\n        return this.currentQualityMap;\n    };\n    DefaultSimulcastUplinkPolicy.prototype.updateIndex = function (videoIndex) {\n        // the +1 for self is assuming that we intend to send video, since\n        // the context here is VideoUplinkBandwidthPolicy\n        var numSenders = videoIndex.numberOfVideoPublishingParticipantsExcludingSelf(this.selfAttendeeId) + 1;\n        var numParticipants = videoIndex.numberOfParticipants();\n        var numSendersChanged = numSenders !== this.numSenders;\n        var numParticipantsChanged = (numParticipants > 2 && this.numParticipants <= 2) ||\n            (numParticipants <= 2 && this.numParticipants > 2);\n        this.numSenders = numSenders;\n        this.numParticipants = numParticipants;\n        this.optimalParameters = new DefaultVideoCaptureAndEncodeParameter_1.default(this.captureWidth(), this.captureHeight(), this.captureFrameRate(), this.maxBandwidthKbps(), false);\n        this.videoIndex = videoIndex;\n        this.newQualityMap = this.calculateEncodingParameters(numSendersChanged || numParticipantsChanged);\n    };\n    DefaultSimulcastUplinkPolicy.prototype.wantsResubscribe = function () {\n        var constraintDiff = !this.encodingParametersEqual();\n        this.nextLocalDescriptions = this.videoIndex.localStreamDescriptions();\n        var _loop_1 = function (i) {\n            var streamId = this_1.nextLocalDescriptions[i].streamId;\n            if (streamId !== 0 && !!streamId) {\n                var prevIndex = this_1.currLocalDescriptions.findIndex(function (val) {\n                    return val.streamId === streamId;\n                });\n                if (prevIndex !== -1) {\n                    if (this_1.nextLocalDescriptions[i].disabledByWebRTC !==\n                        this_1.currLocalDescriptions[prevIndex].disabledByWebRTC) {\n                        constraintDiff = true;\n                    }\n                }\n            }\n        };\n        var this_1 = this;\n        for (var i = 0; i < this.nextLocalDescriptions.length; i++) {\n            _loop_1(i);\n        }\n        if (constraintDiff) {\n            this.lastUpdatedMs = Date.now();\n        }\n        this.currLocalDescriptions = this.nextLocalDescriptions;\n        return constraintDiff;\n    };\n    DefaultSimulcastUplinkPolicy.prototype.compareEncodingParameter = function (encoding1, encoding2) {\n        return JSON.stringify(encoding1) === JSON.stringify(encoding2);\n    };\n    DefaultSimulcastUplinkPolicy.prototype.encodingParametersEqual = function () {\n        var e_1, _b;\n        var different = false;\n        try {\n            for (var _c = __values(SimulcastTransceiverController_1.default.NAME_ARR_ASCENDING), _d = _c.next(); !_d.done; _d = _c.next()) {\n                var ridName = _d.value;\n                different =\n                    different ||\n                        !this.compareEncodingParameter(this.newQualityMap.get(ridName), this.currentQualityMap.get(ridName));\n                if (different) {\n                    break;\n                }\n            }\n        }\n        catch (e_1_1) { e_1 = { error: e_1_1 }; }\n        finally {\n            try {\n                if (_d && !_d.done && (_b = _c.return)) _b.call(_c);\n            }\n            finally { if (e_1) throw e_1.error; }\n        }\n        return !different;\n    };\n    DefaultSimulcastUplinkPolicy.prototype.chooseCaptureAndEncodeParameters = function () {\n        // should deprecate in this policy\n        this.parametersInEffect = this.optimalParameters.clone();\n        return this.parametersInEffect.clone();\n    };\n    DefaultSimulcastUplinkPolicy.prototype.captureWidth = function () {\n        // should deprecate in this policy\n        var width = 1280;\n        return width;\n    };\n    DefaultSimulcastUplinkPolicy.prototype.captureHeight = function () {\n        // should deprecate in this policy\n        var height = 768;\n        return height;\n    };\n    DefaultSimulcastUplinkPolicy.prototype.captureFrameRate = function () {\n        // should deprecate in this policy\n        return 15;\n    };\n    DefaultSimulcastUplinkPolicy.prototype.maxBandwidthKbps = function () {\n        // should deprecate in this policy\n        return 1400;\n    };\n    DefaultSimulcastUplinkPolicy.prototype.setIdealMaxBandwidthKbps = function (_idealMaxBandwidthKbps) {\n        // should deprecate in this policy\n    };\n    DefaultSimulcastUplinkPolicy.prototype.setHasBandwidthPriority = function (_hasBandwidthPriority) {\n        // should deprecate in this policy\n    };\n    DefaultSimulcastUplinkPolicy.prototype.fillEncodingParamWithBitrates = function (bitratesKbps) {\n        var newMap = new Map();\n        var toBps = 1000;\n        var nameArr = SimulcastTransceiverController_1.default.NAME_ARR_ASCENDING;\n        var bitrateArr = bitratesKbps;\n        var scale = 4;\n        for (var i = 0; i < nameArr.length; i++) {\n            var ridName = nameArr[i];\n            newMap.set(ridName, {\n                rid: ridName,\n                active: bitrateArr[i] > 0 ? true : false,\n                scaleResolutionDownBy: scale,\n                maxBitrate: bitrateArr[i] * toBps,\n            });\n            scale = scale / 2;\n        }\n        return newMap;\n    };\n    DefaultSimulcastUplinkPolicy.prototype.getQualityMapString = function (params) {\n        var qualityString = '';\n        var localDescriptions = this.videoIndex.localStreamDescriptions();\n        if (localDescriptions.length === 3) {\n            params.forEach(function (value) {\n                var disabledByWebRTC = false;\n                if (value.rid === 'low')\n                    disabledByWebRTC = localDescriptions[0].disabledByWebRTC;\n                else if (value.rid === 'mid')\n                    disabledByWebRTC = localDescriptions[1].disabledByWebRTC;\n                else\n                    disabledByWebRTC = localDescriptions[2].disabledByWebRTC;\n                qualityString += \"{ rid: \" + value.rid + \" active:\" + value.active + \" disabledByWebRTC: \" + disabledByWebRTC + \" maxBitrate:\" + value.maxBitrate + \"}\";\n            });\n        }\n        return qualityString;\n    };\n    DefaultSimulcastUplinkPolicy.prototype.getEncodingSimulcastLayer = function (activeStreams) {\n        switch (activeStreams) {\n            case 0 /* kHi */:\n                return SimulcastLayers_1.default.High;\n            case 1 /* kHiAndLow */:\n                return SimulcastLayers_1.default.LowAndHigh;\n            case 2 /* kMidAndLow */:\n                return SimulcastLayers_1.default.LowAndMedium;\n            case 3 /* kLow */:\n                return SimulcastLayers_1.default.Low;\n        }\n    };\n    DefaultSimulcastUplinkPolicy.prototype.publishEncodingSimulcastLayer = function () {\n        var simulcastLayers = this.getEncodingSimulcastLayer(this.activeStreamsToPublish);\n        this.forEachObserver(function (observer) {\n            Maybe_1.default.of(observer.encodingSimulcastLayersDidChange).map(function (f) {\n                return f.bind(observer)(simulcastLayers);\n            });\n        });\n    };\n    DefaultSimulcastUplinkPolicy.prototype.addObserver = function (observer) {\n        this.logger.info('adding simulcast uplink observer');\n        this.observerQueue.add(observer);\n    };\n    DefaultSimulcastUplinkPolicy.prototype.removeObserver = function (observer) {\n        this.logger.info('removing simulcast uplink observer');\n        this.observerQueue.delete(observer);\n    };\n    DefaultSimulcastUplinkPolicy.prototype.forEachObserver = function (observerFunc) {\n        var e_2, _b;\n        var _this = this;\n        var _loop_2 = function (observer) {\n            new AsyncScheduler_1.default().start(function () {\n                if (_this.observerQueue.has(observer)) {\n                    observerFunc(observer);\n                }\n            });\n        };\n        try {\n            for (var _c = __values(this.observerQueue), _d = _c.next(); !_d.done; _d = _c.next()) {\n                var observer = _d.value;\n                _loop_2(observer);\n            }\n        }\n        catch (e_2_1) { e_2 = { error: e_2_1 }; }\n        finally {\n            try {\n                if (_d && !_d.done && (_b = _c.return)) _b.call(_c);\n            }\n            finally { if (e_2) throw e_2.error; }\n        }\n    };\n    DefaultSimulcastUplinkPolicy.defaultUplinkBandwidthKbps = 1200;\n    DefaultSimulcastUplinkPolicy.startupDurationMs = 6000;\n    DefaultSimulcastUplinkPolicy.holdDownDurationMs = 4000;\n    DefaultSimulcastUplinkPolicy.defaultMaxFrameRate = 15;\n    // Current rough estimates where webrtc disables streams\n    DefaultSimulcastUplinkPolicy.kHiDisabledRate = 700;\n    DefaultSimulcastUplinkPolicy.kMidDisabledRate = 240;\n    return DefaultSimulcastUplinkPolicy;\n}());\nexports.default = DefaultSimulcastUplinkPolicy;\n//# sourceMappingURL=DefaultSimulcastUplinkPolicy.js.map"]},"metadata":{},"sourceType":"script"}