{"ast":null,"code":"\"use strict\"; // Copyright 2019-2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function () {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n\n        case 7:\n          op = _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n\n            _.ops.push(op);\n\n            break;\n          }\n\n          if (t[2]) _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n      }\n\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nvar __values = this && this.__values || function (o) {\n  var s = typeof Symbol === \"function\" && Symbol.iterator,\n      m = s && o[s],\n      i = 0;\n  if (m) return m.call(o);\n  if (o && typeof o.length === \"number\") return {\n    next: function () {\n      if (o && i >= o.length) o = void 0;\n      return {\n        value: o && o[i++],\n        done: !o\n      };\n    }\n  };\n  throw new TypeError(s ? \"Object is not iterable.\" : \"Symbol.iterator is not defined.\");\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar DefaultBrowserBehavior_1 = require(\"../browserbehavior/DefaultBrowserBehavior\");\n\nvar Maybe_1 = require(\"../maybe/Maybe\");\n\nvar DefaultMediaDeviceFactory_1 = require(\"../mediadevicefactory/DefaultMediaDeviceFactory\");\n\nvar AsyncScheduler_1 = require(\"../scheduler/AsyncScheduler\");\n\nvar IntervalScheduler_1 = require(\"../scheduler/IntervalScheduler\");\n\nvar DefaultVideoTile_1 = require(\"../videotile/DefaultVideoTile\");\n\nvar DevicePermission_1 = require(\"./DevicePermission\");\n\nvar DeviceSelection_1 = require(\"./DeviceSelection\");\n\nvar VideoQualitySettings_1 = require(\"./VideoQualitySettings\");\n\nvar DefaultDeviceController =\n/** @class */\nfunction () {\n  function DefaultDeviceController(logger) {\n    var _this = this;\n\n    this.logger = logger;\n    this.deviceInfoCache = null;\n    this.activeDevices = {\n      audio: null,\n      video: null\n    };\n    this.audioOutputDeviceId = null;\n    this.deviceChangeObservers = new Set();\n\n    this.deviceLabelTrigger = function () {\n      return navigator.mediaDevices.getUserMedia({\n        audio: true,\n        video: true\n      });\n    };\n\n    this.audioInputDestinationNode = null;\n    this.audioInputSourceNode = null;\n    this.videoInputQualitySettings = null;\n    this.useWebAudio = false;\n    this.inputDeviceCount = 0;\n    this.browserBehavior = new DefaultBrowserBehavior_1.default();\n    this.alreadyHandlingDeviceChange = false;\n    this.videoInputQualitySettings = new VideoQualitySettings_1.default(DefaultDeviceController.defaultVideoWidth, DefaultDeviceController.defaultVideoHeight, DefaultDeviceController.defaultVideoFrameRate, DefaultDeviceController.defaultVideoMaxBandwidthKbps);\n    var dimension = this.browserBehavior.requiresResolutionAlignment(this.videoInputQualitySettings.videoWidth, this.videoInputQualitySettings.videoHeight);\n    this.videoInputQualitySettings.videoWidth = dimension[0];\n    this.videoInputQualitySettings.videoHeight = dimension[1];\n    this.logger.info(\"DefaultDeviceController video dimension \" + this.videoInputQualitySettings.videoWidth + \" x \" + this.videoInputQualitySettings.videoHeight);\n\n    try {\n      var mediaDeviceWrapper = new DefaultMediaDeviceFactory_1.default().create();\n      mediaDeviceWrapper.addEventListener('devicechange', function () {\n        _this.handleDeviceChange();\n      });\n      var supportedConstraints = navigator.mediaDevices.getSupportedConstraints();\n      this.logger.info(\"Supported Constraints in this browser \" + JSON.stringify(supportedConstraints));\n    } catch (error) {\n      logger.error(error.message);\n    }\n  }\n\n  DefaultDeviceController.prototype.listAudioInputDevices = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var result;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this.listDevicesOfKind('audioinput')];\n\n          case 1:\n            result = _a.sent();\n            this.trace('listAudioInputDevices', null, result);\n            return [2\n            /*return*/\n            , result];\n        }\n      });\n    });\n  };\n\n  DefaultDeviceController.prototype.listVideoInputDevices = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var result;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this.listDevicesOfKind('videoinput')];\n\n          case 1:\n            result = _a.sent();\n            this.trace('listVideoInputDevices', null, result);\n            return [2\n            /*return*/\n            , result];\n        }\n      });\n    });\n  };\n\n  DefaultDeviceController.prototype.listAudioOutputDevices = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var result;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this.listDevicesOfKind('audiooutput')];\n\n          case 1:\n            result = _a.sent();\n            this.trace('listAudioOutputDevices', null, result);\n            return [2\n            /*return*/\n            , result];\n        }\n      });\n    });\n  };\n\n  DefaultDeviceController.prototype.chooseAudioInputDevice = function (device) {\n    var _a, _b;\n\n    return __awaiter(this, void 0, void 0, function () {\n      var result;\n      return __generator(this, function (_c) {\n        switch (_c.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this.chooseInputDevice('audio', device, false)];\n\n          case 1:\n            result = _c.sent();\n\n            if (result === DevicePermission_1.default.PermissionGrantedByUser || result === DevicePermission_1.default.PermissionGrantedByBrowser) {\n              (_b = (_a = this.boundAudioVideoController) === null || _a === void 0 ? void 0 : _a.eventController) === null || _b === void 0 ? void 0 : _b.pushMeetingState(device === null ? 'audioInputUnselected' : 'audioInputSelected');\n            }\n\n            this.trace('chooseAudioInputDevice', device, DevicePermission_1.default[result]);\n            return [2\n            /*return*/\n            , result];\n        }\n      });\n    });\n  };\n\n  DefaultDeviceController.prototype.chooseVideoInputDevice = function (device) {\n    var _a, _b;\n\n    return __awaiter(this, void 0, void 0, function () {\n      var result;\n      return __generator(this, function (_c) {\n        switch (_c.label) {\n          case 0:\n            this.updateMaxBandwidthKbps();\n            return [4\n            /*yield*/\n            , this.chooseInputDevice('video', device, false)];\n\n          case 1:\n            result = _c.sent();\n\n            if (result === DevicePermission_1.default.PermissionGrantedByUser || result === DevicePermission_1.default.PermissionGrantedByBrowser) {\n              (_b = (_a = this.boundAudioVideoController) === null || _a === void 0 ? void 0 : _a.eventController) === null || _b === void 0 ? void 0 : _b.pushMeetingState(device === null ? 'videoInputUnselected' : 'videoInputSelected');\n            }\n\n            this.trace('chooseVideoInputDevice', device, DevicePermission_1.default[result]);\n            return [2\n            /*return*/\n            , result];\n        }\n      });\n    });\n  };\n\n  DefaultDeviceController.prototype.chooseAudioOutputDevice = function (deviceId) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        this.audioOutputDeviceId = deviceId;\n        this.bindAudioOutput();\n        this.trace('chooseAudioOutputDevice', deviceId, null);\n        return [2\n        /*return*/\n        ];\n      });\n    });\n  };\n\n  DefaultDeviceController.prototype.enableWebAudio = function (flag) {\n    this.logger.warn('enableWebAudio has been Deprecated and will be removed in v2.0.0. ' + 'This API method will removed entirely, along with the corresponding field on MeetingSessionConfiguration. ' + 'The MeetingSession will no longer call enableWebAudio on the corresponding DeviceController. ');\n    this.useWebAudio = flag;\n    this.trace('enableWebAudio', flag);\n  };\n\n  DefaultDeviceController.prototype.addDeviceChangeObserver = function (observer) {\n    this.logger.info('adding device change observer');\n    this.deviceChangeObservers.add(observer);\n    this.trace('addDeviceChangeObserver');\n  };\n\n  DefaultDeviceController.prototype.removeDeviceChangeObserver = function (observer) {\n    this.logger.info('removing device change observer');\n    this.deviceChangeObservers.delete(observer);\n    this.trace('removeDeviceChangeObserver');\n  };\n\n  DefaultDeviceController.prototype.createAnalyserNodeForAudioInput = function () {\n    if (!this.activeDevices['audio']) {\n      return null;\n    }\n\n    var audioContext = DefaultDeviceController.getAudioContext();\n    var analyser = audioContext.createAnalyser();\n    audioContext.createMediaStreamSource(this.activeDevices['audio'].stream).connect(analyser);\n    this.trace('createAnalyserNodeForAudioInput');\n    return analyser;\n  };\n\n  DefaultDeviceController.prototype.startVideoPreviewForVideoInput = function (element) {\n    var _this = this;\n\n    if (!this.activeDevices['video']) {\n      this.logger.warn('cannot bind video preview since video input device has not been chosen');\n      this.trace('startVideoPreviewForVideoInput', element.id);\n      return;\n    } // TODO: implement MediaDestroyer to provide single release MediaStream function\n\n\n    this.releaseMediaStream(element.srcObject);\n    DefaultVideoTile_1.default.disconnectVideoStreamFromVideoElement(element, false);\n    navigator.mediaDevices.getUserMedia(this.activeDevices['video'].constraints).then(function (previewStream) {\n      DefaultVideoTile_1.default.connectVideoStreamToVideoElement(previewStream, element, true);\n    }).catch(function (error) {\n      _this.logger.warn(\"Unable to reacquire video stream for preview to element \" + element.id + \": \" + error);\n    });\n    this.trace('startVideoPreviewForVideoInput', element.id);\n  };\n\n  DefaultDeviceController.prototype.stopVideoPreviewForVideoInput = function (element) {\n    var stream = element.srcObject;\n\n    if (stream) {\n      this.releaseMediaStream(stream);\n      DefaultVideoTile_1.default.disconnectVideoStreamFromVideoElement(element, false);\n    }\n\n    if (this.activeDevices['video']) {\n      this.releaseMediaStream(this.activeDevices['video'].stream);\n    }\n\n    this.trace('stopVideoPreviewForVideoInput', element.id);\n  };\n\n  DefaultDeviceController.prototype.setDeviceLabelTrigger = function (trigger) {\n    this.deviceLabelTrigger = trigger;\n    this.trace('setDeviceLabelTrigger');\n  };\n\n  DefaultDeviceController.prototype.mixIntoAudioInput = function (stream) {\n    var node = null;\n\n    if (this.useWebAudio) {\n      node = DefaultDeviceController.getAudioContext().createMediaStreamSource(stream);\n      node.connect(this.getMediaStreamDestinationNode());\n    } else {\n      this.logger.warn('WebAudio is not enabled, mixIntoAudioInput will not work');\n    }\n\n    this.trace('mixIntoAudioInput', stream.id);\n    return node;\n  };\n\n  DefaultDeviceController.prototype.chooseVideoInputQuality = function (width, height, frameRate, maxBandwidthKbps) {\n    var dimension = this.browserBehavior.requiresResolutionAlignment(width, height);\n    this.videoInputQualitySettings = new VideoQualitySettings_1.default(dimension[0], dimension[1], frameRate, maxBandwidthKbps);\n    this.updateMaxBandwidthKbps();\n  };\n\n  DefaultDeviceController.prototype.getVideoInputQualitySettings = function () {\n    return this.videoInputQualitySettings;\n  };\n\n  DefaultDeviceController.prototype.acquireAudioInputStream = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this.acquireInputStream('audio')];\n\n          case 1:\n            return [2\n            /*return*/\n            , _a.sent()];\n        }\n      });\n    });\n  };\n\n  DefaultDeviceController.prototype.acquireVideoInputStream = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this.acquireInputStream('video')];\n\n          case 1:\n            return [2\n            /*return*/\n            , _a.sent()];\n        }\n      });\n    });\n  };\n\n  DefaultDeviceController.prototype.acquireDisplayInputStream = function (streamConstraints) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        if (streamConstraints && streamConstraints.video && // @ts-ignore\n        streamConstraints.video.mandatory && // @ts-ignore\n        streamConstraints.video.mandatory.chromeMediaSource && // @ts-ignore\n        streamConstraints.video.mandatory.chromeMediaSourceId) {\n          return [2\n          /*return*/\n          , navigator.mediaDevices.getUserMedia(streamConstraints)];\n        } // @ts-ignore https://github.com/microsoft/TypeScript/issues/31821\n\n\n        return [2\n        /*return*/\n        , navigator.mediaDevices.getDisplayMedia(streamConstraints)];\n      });\n    });\n  };\n\n  DefaultDeviceController.prototype.releaseMediaStream = function (mediaStreamToRelease) {\n    var e_1, _a;\n\n    if (!mediaStreamToRelease) {\n      return;\n    }\n\n    var tracksToStop = null;\n\n    if (!!this.audioInputDestinationNode && mediaStreamToRelease === this.audioInputDestinationNode.stream) {\n      // release the true audio stream if WebAudio is used.\n      this.logger.info('stopping audio track');\n      tracksToStop = this.audioInputSourceNode.mediaStream.getTracks();\n      this.audioInputSourceNode.disconnect();\n    } else {\n      tracksToStop = mediaStreamToRelease.getTracks();\n    }\n\n    try {\n      for (var tracksToStop_1 = __values(tracksToStop), tracksToStop_1_1 = tracksToStop_1.next(); !tracksToStop_1_1.done; tracksToStop_1_1 = tracksToStop_1.next()) {\n        var track = tracksToStop_1_1.value;\n        this.logger.info(\"stopping \" + track.kind + \" track\");\n        track.stop();\n      }\n    } catch (e_1_1) {\n      e_1 = {\n        error: e_1_1\n      };\n    } finally {\n      try {\n        if (tracksToStop_1_1 && !tracksToStop_1_1.done && (_a = tracksToStop_1.return)) _a.call(tracksToStop_1);\n      } finally {\n        if (e_1) throw e_1.error;\n      }\n    }\n\n    for (var kind in this.activeDevices) {\n      if (this.activeDevices[kind] && this.activeDevices[kind].stream === mediaStreamToRelease) {\n        this.activeDevices[kind] = null;\n\n        if (kind === 'video' && this.boundAudioVideoController && this.boundAudioVideoController.videoTileController.hasStartedLocalVideoTile()) {\n          this.boundAudioVideoController.videoTileController.stopLocalVideoTile();\n        }\n      }\n    }\n  };\n\n  DefaultDeviceController.prototype.bindToAudioVideoController = function (audioVideoController) {\n    this.boundAudioVideoController = audioVideoController;\n    this.bindAudioOutput();\n  };\n\n  DefaultDeviceController.createEmptyAudioDevice = function () {\n    return DefaultDeviceController.synthesizeAudioDevice(0);\n  };\n\n  DefaultDeviceController.createEmptyVideoDevice = function () {\n    return DefaultDeviceController.synthesizeVideoDevice('black');\n  };\n\n  DefaultDeviceController.synthesizeAudioDevice = function (toneHz) {\n    var audioContext = DefaultDeviceController.getAudioContext();\n    var outputNode = audioContext.createMediaStreamDestination();\n\n    if (!toneHz) {\n      var source = audioContext.createBufferSource(); // The AudioContext object uses the sample rate of the default output device\n      // if not specified. Creating an AudioBuffer object with the output device's\n      // sample rate fails in some browsers, e.g. Safari with a Bluetooth headphone.\n\n      try {\n        source.buffer = audioContext.createBuffer(1, audioContext.sampleRate * 5, audioContext.sampleRate);\n      } catch (error) {\n        if (error && error.name === 'NotSupportedError') {\n          source.buffer = audioContext.createBuffer(1, DefaultDeviceController.defaultSampleRate * 5, DefaultDeviceController.defaultSampleRate);\n        } else {\n          throw error;\n        }\n      } // Some browsers will not play audio out the MediaStreamDestination\n      // unless there is actually audio to play, so we add a small amount of\n      // noise here to ensure that audio is played out.\n\n\n      source.buffer.getChannelData(0)[0] = 0.0003;\n      source.loop = true;\n      source.connect(outputNode);\n      source.start();\n    } else {\n      var gainNode = audioContext.createGain();\n      gainNode.gain.value = 0.1;\n      gainNode.connect(outputNode);\n      var oscillatorNode = audioContext.createOscillator();\n      oscillatorNode.frequency.value = toneHz;\n      oscillatorNode.connect(gainNode);\n      oscillatorNode.start();\n    }\n\n    return outputNode.stream;\n  };\n\n  DefaultDeviceController.synthesizeVideoDevice = function (colorOrPattern) {\n    var canvas = document.createElement('canvas');\n    canvas.width = 480;\n    canvas.height = canvas.width / 16 * 9;\n    var scheduler = new IntervalScheduler_1.default(1000);\n    var context = canvas.getContext('2d'); // @ts-ignore\n\n    var stream = canvas.captureStream(5) || null;\n\n    if (stream) {\n      scheduler.start(function () {\n        if (colorOrPattern === 'smpte') {\n          DefaultDeviceController.fillSMPTEColorBars(canvas, 0);\n        } else {\n          context.fillStyle = colorOrPattern;\n          context.fillRect(0, 0, canvas.width, canvas.height);\n        }\n      });\n      stream.getVideoTracks()[0].addEventListener('ended', function () {\n        scheduler.stop();\n      });\n    }\n\n    return stream;\n  };\n\n  DefaultDeviceController.fillSMPTEColorBars = function (canvas, xShift) {\n    var w = canvas.width;\n    var h = canvas.height;\n    var h1 = h * 2 / 3;\n    var h2 = h * 3 / 4;\n    var h3 = h;\n    var top = ['#c0c0c0', '#c0c000', '#00c0c0', '#00c000', '#c000c0', '#c00000', '#0000c0'];\n    var middle = ['#0000c0', '#000000', '#c000c0', '#000000', '#00c0c0', '#000000', '#c0c0c0'];\n    var bottom = ['#00214c', '#ffffff', '#32006a', '#131313', '#090909', '#131313', '#1d1d1d', '#131313'];\n    var bottomX = [w * 0, w * 1 / 4 * (5 / 7), w * 2 / 4 * (5 / 7), w * 3 / 4 * (5 / 7), w * (5 / 7), w * (5 / 7 + 1 / 21), w * (5 / 7 + 2 / 21), w * (6 / 7), w * 1];\n    var segmentWidth = w / top.length;\n    var ctx = canvas.getContext('2d');\n\n    for (var i = 0; i < top.length; i++) {\n      ctx.fillStyle = top[i];\n      ctx.fillRect(xShift + i * segmentWidth, 0, segmentWidth, h1);\n      ctx.fillStyle = middle[i];\n      ctx.fillRect(xShift + i * segmentWidth, h1, segmentWidth, h2 - h1);\n    }\n\n    for (var i = 0; i < bottom.length; i++) {\n      ctx.fillStyle = bottom[i];\n      ctx.fillRect(xShift + bottomX[i], h2, bottomX[i + 1] - bottomX[i], h3 - h2);\n    }\n  };\n\n  DefaultDeviceController.prototype.updateMaxBandwidthKbps = function () {\n    if (this.boundAudioVideoController) {\n      this.boundAudioVideoController.setVideoMaxBandwidthKbps(this.videoInputQualitySettings.videoMaxBandwidthKbps);\n    }\n  };\n\n  DefaultDeviceController.prototype.listDevicesOfKind = function (deviceKind) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            if (!(this.deviceInfoCache === null)) return [3\n            /*break*/\n            , 2];\n            return [4\n            /*yield*/\n            , this.updateDeviceInfoCacheFromBrowser()];\n\n          case 1:\n            _a.sent();\n\n            _a.label = 2;\n\n          case 2:\n            return [2\n            /*return*/\n            , this.listCachedDevicesOfKind(deviceKind)];\n        }\n      });\n    });\n  };\n\n  DefaultDeviceController.prototype.updateDeviceInfoCacheFromBrowser = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var doesNotHaveAccessToMediaDevices, devices, hasDeviceLabels, devices_1, devices_1_1, device, triggerStream, _a, _b, track, err_1;\n\n      var e_2, _c, e_3, _d;\n\n      return __generator(this, function (_e) {\n        switch (_e.label) {\n          case 0:\n            doesNotHaveAccessToMediaDevices = !MediaDeviceInfo;\n\n            if (doesNotHaveAccessToMediaDevices) {\n              this.deviceInfoCache = [];\n              return [2\n              /*return*/\n              ];\n            }\n\n            return [4\n            /*yield*/\n            , navigator.mediaDevices.enumerateDevices()];\n\n          case 1:\n            devices = _e.sent();\n            hasDeviceLabels = true;\n\n            try {\n              for (devices_1 = __values(devices), devices_1_1 = devices_1.next(); !devices_1_1.done; devices_1_1 = devices_1.next()) {\n                device = devices_1_1.value;\n\n                if (!device.label) {\n                  hasDeviceLabels = false;\n                  break;\n                }\n              }\n            } catch (e_2_1) {\n              e_2 = {\n                error: e_2_1\n              };\n            } finally {\n              try {\n                if (devices_1_1 && !devices_1_1.done && (_c = devices_1.return)) _c.call(devices_1);\n              } finally {\n                if (e_2) throw e_2.error;\n              }\n            }\n\n            if (!!hasDeviceLabels) return [3\n            /*break*/\n            , 6];\n            _e.label = 2;\n\n          case 2:\n            _e.trys.push([2, 5,, 6]);\n\n            this.logger.info('attempting to trigger media device labels since they are hidden');\n            return [4\n            /*yield*/\n            , this.deviceLabelTrigger()];\n\n          case 3:\n            triggerStream = _e.sent();\n            return [4\n            /*yield*/\n            , navigator.mediaDevices.enumerateDevices()];\n\n          case 4:\n            devices = _e.sent();\n\n            try {\n              for (_a = __values(triggerStream.getTracks()), _b = _a.next(); !_b.done; _b = _a.next()) {\n                track = _b.value;\n                track.stop();\n              }\n            } catch (e_3_1) {\n              e_3 = {\n                error: e_3_1\n              };\n            } finally {\n              try {\n                if (_b && !_b.done && (_d = _a.return)) _d.call(_a);\n              } finally {\n                if (e_3) throw e_3.error;\n              }\n            }\n\n            return [3\n            /*break*/\n            , 6];\n\n          case 5:\n            err_1 = _e.sent();\n            this.logger.info('unable to get media device labels');\n            return [3\n            /*break*/\n            , 6];\n\n          case 6:\n            this.deviceInfoCache = devices;\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  DefaultDeviceController.prototype.listCachedDevicesOfKind = function (deviceKind) {\n    var e_4, _a;\n\n    var devicesOfKind = [];\n\n    try {\n      for (var _b = __values(this.deviceInfoCache), _c = _b.next(); !_c.done; _c = _b.next()) {\n        var device = _c.value;\n\n        if (device.kind === deviceKind) {\n          devicesOfKind.push(device);\n        }\n      }\n    } catch (e_4_1) {\n      e_4 = {\n        error: e_4_1\n      };\n    } finally {\n      try {\n        if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\n      } finally {\n        if (e_4) throw e_4.error;\n      }\n    }\n\n    return devicesOfKind;\n  };\n\n  DefaultDeviceController.prototype.handleDeviceChange = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var oldAudioInputDevices, oldVideoInputDevices, oldAudioOutputDevices, newAudioInputDevices, newVideoInputDevices, newAudioOutputDevices;\n\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            if (this.deviceInfoCache === null) {\n              return [2\n              /*return*/\n              ];\n            }\n\n            if (this.alreadyHandlingDeviceChange) {\n              new AsyncScheduler_1.default().start(function () {\n                _this.handleDeviceChange();\n              });\n              return [2\n              /*return*/\n              ];\n            }\n\n            this.alreadyHandlingDeviceChange = true;\n            oldAudioInputDevices = this.listCachedDevicesOfKind('audioinput');\n            oldVideoInputDevices = this.listCachedDevicesOfKind('videoinput');\n            oldAudioOutputDevices = this.listCachedDevicesOfKind('audiooutput');\n            return [4\n            /*yield*/\n            , this.updateDeviceInfoCacheFromBrowser()];\n\n          case 1:\n            _a.sent();\n\n            newAudioInputDevices = this.listCachedDevicesOfKind('audioinput');\n            newVideoInputDevices = this.listCachedDevicesOfKind('videoinput');\n            newAudioOutputDevices = this.listCachedDevicesOfKind('audiooutput');\n            this.forEachObserver(function (observer) {\n              if (!_this.areDeviceListsEqual(oldAudioInputDevices, newAudioInputDevices)) {\n                Maybe_1.default.of(observer.audioInputsChanged).map(function (f) {\n                  return f.bind(observer)(newAudioInputDevices);\n                });\n              }\n\n              if (!_this.areDeviceListsEqual(oldVideoInputDevices, newVideoInputDevices)) {\n                Maybe_1.default.of(observer.videoInputsChanged).map(function (f) {\n                  return f.bind(observer)(newVideoInputDevices);\n                });\n              }\n\n              if (!_this.areDeviceListsEqual(oldAudioOutputDevices, newAudioOutputDevices)) {\n                Maybe_1.default.of(observer.audioOutputsChanged).map(function (f) {\n                  return f.bind(observer)(newAudioOutputDevices);\n                });\n              }\n            });\n            this.alreadyHandlingDeviceChange = false;\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  DefaultDeviceController.prototype.handleDeviceStreamEnded = function (kind, deviceId) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this.chooseInputDevice(kind, null, false)];\n\n          case 1:\n            _a.sent();\n\n            if (kind === 'audio') {\n              this.forEachObserver(function (observer) {\n                Maybe_1.default.of(observer.audioInputStreamEnded).map(function (f) {\n                  return f.bind(observer)(deviceId);\n                });\n              });\n            } else {\n              this.forEachObserver(function (observer) {\n                Maybe_1.default.of(observer.videoInputStreamEnded).map(function (f) {\n                  return f.bind(observer)(deviceId);\n                });\n              });\n            }\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  DefaultDeviceController.prototype.forEachObserver = function (observerFunc) {\n    var e_5, _a;\n\n    var _this = this;\n\n    var _loop_1 = function (observer) {\n      new AsyncScheduler_1.default().start(function () {\n        /* istanbul ignore else */\n        if (_this.deviceChangeObservers.has(observer)) {\n          observerFunc(observer);\n        }\n      });\n    };\n\n    try {\n      for (var _b = __values(this.deviceChangeObservers), _c = _b.next(); !_c.done; _c = _b.next()) {\n        var observer = _c.value;\n\n        _loop_1(observer);\n      }\n    } catch (e_5_1) {\n      e_5 = {\n        error: e_5_1\n      };\n    } finally {\n      try {\n        if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\n      } finally {\n        if (e_5) throw e_5.error;\n      }\n    }\n  };\n\n  DefaultDeviceController.prototype.areDeviceListsEqual = function (a, b) {\n    return JSON.stringify(a.map(function (device) {\n      return JSON.stringify(device);\n    }).sort()) === JSON.stringify(b.map(function (device) {\n      return JSON.stringify(device);\n    }).sort());\n  };\n\n  DefaultDeviceController.prototype.deviceAsMediaStream = function (device) {\n    // @ts-ignore\n    return device && device.id ? device : null;\n  };\n\n  DefaultDeviceController.prototype.hasSameGroupId = function (groupId, kind, device) {\n    device = this.getDeviceIdStr(device);\n\n    if (groupId === this.getGroupIdFromDeviceId(kind, device) || groupId === '') {\n      return true;\n    }\n\n    return false;\n  };\n\n  DefaultDeviceController.prototype.getGroupIdFromDeviceId = function (kind, device) {\n    if (this.deviceInfoCache !== null) {\n      var cachedDeviceInfo = this.listCachedDevicesOfKind(kind + \"input\").find(function (cachedDevice) {\n        return cachedDevice.deviceId === device;\n      });\n\n      if (cachedDeviceInfo && cachedDeviceInfo.groupId) {\n        return cachedDeviceInfo.groupId;\n      }\n    }\n\n    return '';\n  };\n\n  DefaultDeviceController.prototype.getDeviceIdStr = function (device) {\n    if (device === null) {\n      return null;\n    } else if (typeof device === 'string') {\n      return device;\n    } else if (device.id) {\n      return device.id;\n    }\n\n    var constraints = device;\n\n    if (!constraints.deviceId) {\n      return '';\n    } else if (typeof constraints.deviceId === 'string') {\n      return constraints.deviceId;\n    }\n\n    var deviceIdConstraint = constraints.deviceId;\n\n    if (typeof deviceIdConstraint.exact === 'string') {\n      return deviceIdConstraint.exact;\n    }\n\n    return '';\n  };\n\n  DefaultDeviceController.prototype.getActiveDeviceId = function (kind) {\n    /* istanbul ignore else */\n    if (this.activeDevices[kind] && this.activeDevices[kind].constraints) {\n      var activeDeviceMediaTrackConstraints = this.activeDevices[kind].constraints.audio || this.activeDevices[kind].constraints.video;\n      var activeDeviceConstrainDOMStringParameters = activeDeviceMediaTrackConstraints.deviceId;\n      var activeDeviceId = void 0;\n\n      if (typeof activeDeviceConstrainDOMStringParameters === 'string') {\n        activeDeviceId = activeDeviceConstrainDOMStringParameters;\n      } else {\n        activeDeviceId = activeDeviceConstrainDOMStringParameters.exact;\n      }\n\n      return activeDeviceId;\n    }\n    /* istanbul ignore next */\n\n\n    return null;\n  };\n\n  DefaultDeviceController.prototype.restartLocalVideoAfterSelection = function (oldStream, fromAcquire) {\n    var _this = this;\n\n    if (!fromAcquire && this.boundAudioVideoController && this.boundAudioVideoController.videoTileController.hasStartedLocalVideoTile()) {\n      this.logger.info('restarting local video to switch to new device');\n      this.boundAudioVideoController.restartLocalVideo(function () {\n        // TODO: implement MediaStreamDestroyer\n        // tracks of oldStream should be stopped when video tile is disconnected from MediaStream\n        // otherwise, camera is still being accessed and we need to stop it here.\n        if (oldStream && oldStream.active) {\n          _this.logger.warn('previous media stream is not stopped during restart video');\n\n          _this.releaseMediaStream(oldStream);\n        }\n      });\n    } else {\n      this.releaseMediaStream(oldStream);\n    }\n  };\n\n  DefaultDeviceController.prototype.chooseInputDevice = function (kind, device, fromAcquire) {\n    var _a, _b, _c, _d;\n\n    return __awaiter(this, void 0, void 0, function () {\n      function grantedForDuration(start, end) {\n        return end - start < DefaultDeviceController.permissionGrantedOriginDetectionThresholdMs ? DevicePermission_1.default.PermissionGrantedByBrowser : DevicePermission_1.default.PermissionGrantedByUser;\n      }\n\n      function deniedForDuration(start, end) {\n        return end - start < DefaultDeviceController.permissionDeniedOriginDetectionThresholdMs ? DevicePermission_1.default.PermissionDeniedByBrowser : DevicePermission_1.default.PermissionDeniedByUser;\n      }\n\n      var callCount, proposedConstraints, startTimeMs, newDevice, stream, _e, error_1, errorMessage, error_2;\n\n      var _this = this;\n\n      return __generator(this, function (_f) {\n        switch (_f.label) {\n          case 0:\n            this.inputDeviceCount += 1;\n            callCount = this.inputDeviceCount;\n\n            if (device === null && kind === 'video') {\n              this.lastNoVideoInputDeviceCount = this.inputDeviceCount;\n\n              if (this.activeDevices[kind]) {\n                this.releaseMediaStream(this.activeDevices[kind].stream);\n                delete this.activeDevices[kind];\n              }\n\n              return [2\n              /*return*/\n              , DevicePermission_1.default.PermissionGrantedByBrowser];\n            }\n\n            proposedConstraints = this.calculateMediaStreamConstraints(kind, device);\n\n            if (this.activeDevices[kind] && this.activeDevices[kind].matchesConstraints(proposedConstraints) && this.activeDevices[kind].stream.active && this.activeDevices[kind].groupId !== null && this.hasSameGroupId(this.activeDevices[kind].groupId, kind, device)) {\n              this.logger.info(\"reusing existing \" + kind + \" device\");\n              return [2\n              /*return*/\n              , DevicePermission_1.default.PermissionGrantedPreviously];\n            }\n\n            if (kind === 'audio' && this.activeDevices[kind] && this.activeDevices[kind].stream) {\n              this.releaseMediaStream(this.activeDevices[kind].stream);\n            }\n\n            startTimeMs = Date.now();\n            newDevice = new DeviceSelection_1.default();\n            _f.label = 1;\n\n          case 1:\n            _f.trys.push([1, 7,, 12]);\n\n            this.logger.info(\"requesting new \" + kind + \" device with constraint \" + JSON.stringify(proposedConstraints));\n            stream = this.deviceAsMediaStream(device);\n            if (!(kind === 'audio' && device === null)) return [3\n            /*break*/\n            , 2];\n            newDevice.stream = DefaultDeviceController.createEmptyAudioDevice();\n            newDevice.constraints = null;\n            return [3\n            /*break*/\n            , 6];\n\n          case 2:\n            if (!stream) return [3\n            /*break*/\n            , 3];\n            this.logger.info(\"using media stream \" + stream.id + \" for \" + kind + \" device\");\n            newDevice.stream = stream;\n            newDevice.constraints = proposedConstraints;\n            return [3\n            /*break*/\n            , 6];\n\n          case 3:\n            _e = newDevice;\n            return [4\n            /*yield*/\n            , navigator.mediaDevices.getUserMedia(proposedConstraints)];\n\n          case 4:\n            _e.stream = _f.sent();\n            newDevice.constraints = proposedConstraints;\n\n            if (kind === 'video' && this.lastNoVideoInputDeviceCount > callCount) {\n              this.logger.warn(\"ignored to get video device for constraints \" + JSON.stringify(proposedConstraints) + \" as no device was requested\");\n              this.releaseMediaStream(newDevice.stream);\n              return [2\n              /*return*/\n              , DevicePermission_1.default.PermissionGrantedByUser];\n            }\n\n            return [4\n            /*yield*/\n            , this.handleDeviceChange()];\n\n          case 5:\n            _f.sent();\n\n            newDevice.stream.getTracks()[0].addEventListener('ended', function () {\n              if (_this.activeDevices[kind] && _this.activeDevices[kind].stream === newDevice.stream) {\n                _this.logger.warn(kind + \" input device which was active is no longer available, resetting to null device\");\n\n                _this.handleDeviceStreamEnded(kind, _this.getActiveDeviceId(kind));\n              }\n            });\n            _f.label = 6;\n\n          case 6:\n            newDevice.groupId = this.getGroupIdFromDeviceId(kind, this.getDeviceIdStr(device));\n            return [3\n            /*break*/\n            , 12];\n\n          case 7:\n            error_1 = _f.sent();\n            errorMessage = void 0;\n\n            if ((error_1 === null || error_1 === void 0 ? void 0 : error_1.name) && error_1.message) {\n              errorMessage = error_1.name + \": \" + error_1.message;\n            } else if (error_1 === null || error_1 === void 0 ? void 0 : error_1.name) {\n              errorMessage = error_1.name;\n            } else if (error_1 === null || error_1 === void 0 ? void 0 : error_1.message) {\n              errorMessage = error_1.message;\n            } else {\n              errorMessage = 'UnknownError';\n            }\n\n            if (kind === 'audio') {\n              (_b = (_a = this.boundAudioVideoController) === null || _a === void 0 ? void 0 : _a.eventController) === null || _b === void 0 ? void 0 : _b.publishEvent('audioInputFailed', {\n                audioInputErrorMessage: errorMessage\n              });\n            } else {\n              (_d = (_c = this.boundAudioVideoController) === null || _c === void 0 ? void 0 : _c.eventController) === null || _d === void 0 ? void 0 : _d.publishEvent('videoInputFailed', {\n                videoInputErrorMessage: errorMessage\n              });\n            }\n\n            this.logger.error(\"failed to get \" + kind + \" device for constraints \" + JSON.stringify(proposedConstraints) + \": \" + errorMessage);\n            if (!(kind === 'audio')) return [3\n            /*break*/\n            , 11];\n            this.logger.info(\"choosing null \" + kind + \" device instead\");\n            _f.label = 8;\n\n          case 8:\n            _f.trys.push([8, 10,, 11]);\n\n            newDevice.stream = DefaultDeviceController.createEmptyAudioDevice();\n            newDevice.constraints = null;\n            return [4\n            /*yield*/\n            , this.handleNewInputDevice(kind, newDevice, fromAcquire)];\n\n          case 9:\n            _f.sent();\n\n            return [3\n            /*break*/\n            , 11];\n\n          case 10:\n            error_2 = _f.sent();\n            this.logger.error(\"failed to choose null \" + kind + \" device. \" + error_2.name + \": \" + error_2.message);\n            return [3\n            /*break*/\n            , 11];\n\n          case 11:\n            return [2\n            /*return*/\n            , deniedForDuration(startTimeMs, Date.now())];\n\n          case 12:\n            this.logger.info(\"got \" + kind + \" device for constraints \" + JSON.stringify(proposedConstraints));\n            return [4\n            /*yield*/\n            , this.handleNewInputDevice(kind, newDevice, fromAcquire)];\n\n          case 13:\n            _f.sent();\n\n            return [2\n            /*return*/\n            , grantedForDuration(startTimeMs, Date.now())];\n        }\n      });\n    });\n  };\n\n  DefaultDeviceController.prototype.handleNewInputDevice = function (kind, newDevice, fromAcquire) {\n    return __awaiter(this, void 0, void 0, function () {\n      var oldStream, error_3;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            oldStream = this.activeDevices[kind] ? this.activeDevices[kind].stream : null;\n            this.activeDevices[kind] = newDevice;\n            if (!(kind === 'video')) return [3\n            /*break*/\n            , 1];\n            this.restartLocalVideoAfterSelection(oldStream, fromAcquire);\n            return [3\n            /*break*/\n            , 8];\n\n          case 1:\n            this.releaseMediaStream(oldStream);\n            if (!this.useWebAudio) return [3\n            /*break*/\n            , 2];\n            this.attachAudioInputStreamToAudioContext(this.activeDevices[kind].stream);\n            return [3\n            /*break*/\n            , 8];\n\n          case 2:\n            if (!this.boundAudioVideoController) return [3\n            /*break*/\n            , 7];\n            _a.label = 3;\n\n          case 3:\n            _a.trys.push([3, 5,, 6]);\n\n            return [4\n            /*yield*/\n            , this.boundAudioVideoController.restartLocalAudio(function () {})];\n\n          case 4:\n            _a.sent();\n\n            return [3\n            /*break*/\n            , 6];\n\n          case 5:\n            error_3 = _a.sent();\n            this.logger.info(\"cannot replace audio track due to: \" + error_3.message);\n            return [3\n            /*break*/\n            , 6];\n\n          case 6:\n            return [3\n            /*break*/\n            , 8];\n\n          case 7:\n            this.logger.info('no audio-video controller is bound to the device controller');\n            _a.label = 8;\n\n          case 8:\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  DefaultDeviceController.prototype.bindAudioOutput = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var deviceInfo;\n      return __generator(this, function (_a) {\n        if (!this.boundAudioVideoController) {\n          return [2\n          /*return*/\n          ];\n        }\n\n        deviceInfo = this.deviceInfoFromDeviceId('audiooutput', this.audioOutputDeviceId); // TODO: fail promise if audio output device cannot be selected or setSinkId promise rejects\n\n        this.boundAudioVideoController.audioMixController.bindAudioDevice(deviceInfo);\n        return [2\n        /*return*/\n        ];\n      });\n    });\n  };\n\n  DefaultDeviceController.prototype.calculateMediaStreamConstraints = function (kind, device) {\n    var trackConstraints = {};\n\n    if (device === '') {\n      device = null;\n    }\n\n    var stream = this.deviceAsMediaStream(device);\n\n    if (device === null) {\n      return null;\n    } else if (typeof device === 'string') {\n      if (this.browserBehavior.requiresNoExactMediaStreamConstraints()) {\n        trackConstraints.deviceId = device;\n      } else {\n        trackConstraints.deviceId = {\n          exact: device\n        };\n      }\n    } else if (stream) {\n      // @ts-ignore - create a fake track constraint using the stream id\n      trackConstraints.streamId = stream.id;\n    } else {\n      // @ts-ignore - device is a MediaTrackConstraints\n      trackConstraints = device;\n    }\n\n    if (kind === 'video') {\n      trackConstraints.width = trackConstraints.width || {\n        ideal: this.videoInputQualitySettings.videoWidth\n      };\n      trackConstraints.height = trackConstraints.height || {\n        ideal: this.videoInputQualitySettings.videoHeight\n      };\n      trackConstraints.frameRate = trackConstraints.frameRate || {\n        ideal: this.videoInputQualitySettings.videoFrameRate\n      }; // TODO: try to replace hard-code value related to videos into quality-level presets\n      // The following configs relaxes CPU overuse detection threshold to offer better encoding quality\n      // @ts-ignore\n\n      trackConstraints.googCpuOveruseDetection = true; // @ts-ignore\n\n      trackConstraints.googCpuOveruseEncodeUsage = true; // @ts-ignore\n\n      trackConstraints.googCpuOveruseThreshold = 85; // @ts-ignore\n\n      trackConstraints.googCpuUnderuseThreshold = 55;\n    }\n\n    if (kind === 'audio' && this.supportSampleRateConstraint()) {\n      trackConstraints.sampleRate = {\n        ideal: DefaultDeviceController.defaultSampleRate\n      };\n    }\n\n    if (kind === 'audio' && this.supportSampleSizeConstraint()) {\n      trackConstraints.sampleSize = {\n        ideal: DefaultDeviceController.defaultSampleSize\n      };\n    }\n\n    if (kind === 'audio' && this.supportChannelCountConstraint()) {\n      trackConstraints.channelCount = {\n        ideal: DefaultDeviceController.defaultChannelCount\n      };\n    }\n\n    if (kind === 'audio') {\n      // @ts-ignore\n      trackConstraints.echoCancellation = true; // @ts-ignore\n\n      trackConstraints.googEchoCancellation = true; // @ts-ignore\n\n      trackConstraints.googAutoGainControl = true; // @ts-ignore\n\n      trackConstraints.googNoiseSuppression = true; // @ts-ignore\n\n      trackConstraints.googHighpassFilter = true; // @ts-ignore\n\n      trackConstraints.googNoiseSuppression2 = true; // @ts-ignore\n\n      trackConstraints.googEchoCancellation2 = true; // @ts-ignore\n\n      trackConstraints.googAutoGainControl2 = true;\n    }\n\n    return kind === 'audio' ? {\n      audio: trackConstraints\n    } : {\n      video: trackConstraints\n    };\n  };\n\n  DefaultDeviceController.prototype.deviceInfoFromDeviceId = function (deviceKind, deviceId) {\n    var e_6, _a;\n\n    if (this.deviceInfoCache === null) {\n      return null;\n    }\n\n    try {\n      for (var _b = __values(this.deviceInfoCache), _c = _b.next(); !_c.done; _c = _b.next()) {\n        var device = _c.value;\n\n        if (device.kind === deviceKind && device.deviceId === deviceId) {\n          return device;\n        }\n      }\n    } catch (e_6_1) {\n      e_6 = {\n        error: e_6_1\n      };\n    } finally {\n      try {\n        if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\n      } finally {\n        if (e_6) throw e_6.error;\n      }\n    }\n\n    return null;\n  };\n\n  DefaultDeviceController.prototype.acquireInputStream = function (kind) {\n    return __awaiter(this, void 0, void 0, function () {\n      var existingConstraints, active, result;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            if (kind === 'audio') {\n              if (this.useWebAudio) {\n                return [2\n                /*return*/\n                , this.getMediaStreamDestinationNode().stream];\n              }\n            }\n\n            existingConstraints = null;\n\n            if (!this.activeDevices[kind]) {\n              if (kind === 'audio') {\n                this.logger.info(\"no \" + kind + \" device chosen, creating empty \" + kind + \" device\");\n              } else {\n                this.logger.error(\"no \" + kind + \" device chosen, stopping local video tile\");\n                this.boundAudioVideoController.videoTileController.stopLocalVideoTile();\n                throw new Error(\"no \" + kind + \" device chosen, stopping local video tile\");\n              }\n            } else {\n              this.logger.info(\"checking whether existing \" + kind + \" device can be reused\");\n              active = this.activeDevices[kind]; // @ts-ignore\n\n              existingConstraints = active.constraints ? active.constraints[kind] : null;\n            }\n\n            return [4\n            /*yield*/\n            , this.chooseInputDevice(kind, existingConstraints, true)];\n\n          case 1:\n            result = _a.sent();\n\n            if (result === DevicePermission_1.default.PermissionDeniedByBrowser || result === DevicePermission_1.default.PermissionDeniedByUser) {\n              this.logger.error(\"unable to acquire \" + kind + \" device\");\n              throw new Error(\"unable to acquire \" + kind + \" device\");\n            }\n\n            return [2\n            /*return*/\n            , this.activeDevices[kind].stream];\n        }\n      });\n    });\n  };\n\n  DefaultDeviceController.prototype.attachAudioInputStreamToAudioContext = function (stream) {\n    if (this.audioInputSourceNode) {\n      this.audioInputSourceNode.disconnect();\n    }\n\n    this.audioInputSourceNode = DefaultDeviceController.getAudioContext().createMediaStreamSource(stream);\n    this.audioInputSourceNode.connect(this.getMediaStreamDestinationNode());\n  };\n\n  DefaultDeviceController.prototype.getMediaStreamDestinationNode = function () {\n    if (!this.audioInputDestinationNode) {\n      this.audioInputDestinationNode = DefaultDeviceController.getAudioContext().createMediaStreamDestination();\n    }\n\n    return this.audioInputDestinationNode;\n  };\n\n  DefaultDeviceController.getAudioContext = function () {\n    if (!DefaultDeviceController.audioContext) {\n      var options = {};\n\n      if (navigator.mediaDevices.getSupportedConstraints().sampleRate) {\n        options.sampleRate = DefaultDeviceController.defaultSampleRate;\n      } // @ts-ignore\n\n\n      DefaultDeviceController.audioContext = new (window.AudioContext || window.webkitAudioContext)(options);\n    }\n\n    return DefaultDeviceController.audioContext;\n  };\n\n  DefaultDeviceController.closeAudioContext = function () {\n    if (DefaultDeviceController.audioContext) {\n      DefaultDeviceController.audioContext.close();\n    }\n\n    DefaultDeviceController.audioContext = null;\n  };\n\n  DefaultDeviceController.prototype.supportSampleRateConstraint = function () {\n    return this.useWebAudio && !!navigator.mediaDevices.getSupportedConstraints().sampleRate;\n  };\n\n  DefaultDeviceController.prototype.supportSampleSizeConstraint = function () {\n    return this.useWebAudio && !!navigator.mediaDevices.getSupportedConstraints().sampleSize;\n  };\n\n  DefaultDeviceController.prototype.supportChannelCountConstraint = function () {\n    return this.useWebAudio && !!navigator.mediaDevices.getSupportedConstraints().channelCount;\n  }; // eslint-disable-next-line @typescript-eslint/no-explicit-any\n\n\n  DefaultDeviceController.prototype.trace = function (name, input, output) {\n    var s = \"API/DefaultDeviceController/\" + name;\n\n    if (typeof input !== 'undefined') {\n      s += \" \" + JSON.stringify(input);\n    }\n\n    if (typeof output !== 'undefined') {\n      s += \" -> \" + JSON.stringify(output);\n    }\n\n    this.logger.info(s);\n  };\n\n  DefaultDeviceController.permissionGrantedOriginDetectionThresholdMs = 1000;\n  DefaultDeviceController.permissionDeniedOriginDetectionThresholdMs = 500;\n  DefaultDeviceController.defaultVideoWidth = 960;\n  DefaultDeviceController.defaultVideoHeight = 540;\n  DefaultDeviceController.defaultVideoFrameRate = 15;\n  DefaultDeviceController.defaultVideoMaxBandwidthKbps = 1400;\n  DefaultDeviceController.defaultSampleRate = 48000;\n  DefaultDeviceController.defaultSampleSize = 16;\n  DefaultDeviceController.defaultChannelCount = 1;\n  DefaultDeviceController.audioContext = null;\n  return DefaultDeviceController;\n}();\n\nexports.default = DefaultDeviceController;","map":{"version":3,"sources":["../../src/devicecontroller/DefaultDeviceController.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\n// Copyright 2019-2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nvar __values = (this && this.__values) || function(o) {\n    var s = typeof Symbol === \"function\" && Symbol.iterator, m = s && o[s], i = 0;\n    if (m) return m.call(o);\n    if (o && typeof o.length === \"number\") return {\n        next: function () {\n            if (o && i >= o.length) o = void 0;\n            return { value: o && o[i++], done: !o };\n        }\n    };\n    throw new TypeError(s ? \"Object is not iterable.\" : \"Symbol.iterator is not defined.\");\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar DefaultBrowserBehavior_1 = require(\"../browserbehavior/DefaultBrowserBehavior\");\nvar Maybe_1 = require(\"../maybe/Maybe\");\nvar DefaultMediaDeviceFactory_1 = require(\"../mediadevicefactory/DefaultMediaDeviceFactory\");\nvar AsyncScheduler_1 = require(\"../scheduler/AsyncScheduler\");\nvar IntervalScheduler_1 = require(\"../scheduler/IntervalScheduler\");\nvar DefaultVideoTile_1 = require(\"../videotile/DefaultVideoTile\");\nvar DevicePermission_1 = require(\"./DevicePermission\");\nvar DeviceSelection_1 = require(\"./DeviceSelection\");\nvar VideoQualitySettings_1 = require(\"./VideoQualitySettings\");\nvar DefaultDeviceController = /** @class */ (function () {\n    function DefaultDeviceController(logger) {\n        var _this = this;\n        this.logger = logger;\n        this.deviceInfoCache = null;\n        this.activeDevices = { audio: null, video: null };\n        this.audioOutputDeviceId = null;\n        this.deviceChangeObservers = new Set();\n        this.deviceLabelTrigger = function () {\n            return navigator.mediaDevices.getUserMedia({ audio: true, video: true });\n        };\n        this.audioInputDestinationNode = null;\n        this.audioInputSourceNode = null;\n        this.videoInputQualitySettings = null;\n        this.useWebAudio = false;\n        this.inputDeviceCount = 0;\n        this.browserBehavior = new DefaultBrowserBehavior_1.default();\n        this.alreadyHandlingDeviceChange = false;\n        this.videoInputQualitySettings = new VideoQualitySettings_1.default(DefaultDeviceController.defaultVideoWidth, DefaultDeviceController.defaultVideoHeight, DefaultDeviceController.defaultVideoFrameRate, DefaultDeviceController.defaultVideoMaxBandwidthKbps);\n        var dimension = this.browserBehavior.requiresResolutionAlignment(this.videoInputQualitySettings.videoWidth, this.videoInputQualitySettings.videoHeight);\n        this.videoInputQualitySettings.videoWidth = dimension[0];\n        this.videoInputQualitySettings.videoHeight = dimension[1];\n        this.logger.info(\"DefaultDeviceController video dimension \" + this.videoInputQualitySettings.videoWidth + \" x \" + this.videoInputQualitySettings.videoHeight);\n        try {\n            var mediaDeviceWrapper = new DefaultMediaDeviceFactory_1.default().create();\n            mediaDeviceWrapper.addEventListener('devicechange', function () {\n                _this.handleDeviceChange();\n            });\n            var supportedConstraints = navigator.mediaDevices.getSupportedConstraints();\n            this.logger.info(\"Supported Constraints in this browser \" + JSON.stringify(supportedConstraints));\n        }\n        catch (error) {\n            logger.error(error.message);\n        }\n    }\n    DefaultDeviceController.prototype.listAudioInputDevices = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var result;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.listDevicesOfKind('audioinput')];\n                    case 1:\n                        result = _a.sent();\n                        this.trace('listAudioInputDevices', null, result);\n                        return [2 /*return*/, result];\n                }\n            });\n        });\n    };\n    DefaultDeviceController.prototype.listVideoInputDevices = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var result;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.listDevicesOfKind('videoinput')];\n                    case 1:\n                        result = _a.sent();\n                        this.trace('listVideoInputDevices', null, result);\n                        return [2 /*return*/, result];\n                }\n            });\n        });\n    };\n    DefaultDeviceController.prototype.listAudioOutputDevices = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var result;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.listDevicesOfKind('audiooutput')];\n                    case 1:\n                        result = _a.sent();\n                        this.trace('listAudioOutputDevices', null, result);\n                        return [2 /*return*/, result];\n                }\n            });\n        });\n    };\n    DefaultDeviceController.prototype.chooseAudioInputDevice = function (device) {\n        var _a, _b;\n        return __awaiter(this, void 0, void 0, function () {\n            var result;\n            return __generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0: return [4 /*yield*/, this.chooseInputDevice('audio', device, false)];\n                    case 1:\n                        result = _c.sent();\n                        if (result === DevicePermission_1.default.PermissionGrantedByUser ||\n                            result === DevicePermission_1.default.PermissionGrantedByBrowser) {\n                            (_b = (_a = this.boundAudioVideoController) === null || _a === void 0 ? void 0 : _a.eventController) === null || _b === void 0 ? void 0 : _b.pushMeetingState(device === null ? 'audioInputUnselected' : 'audioInputSelected');\n                        }\n                        this.trace('chooseAudioInputDevice', device, DevicePermission_1.default[result]);\n                        return [2 /*return*/, result];\n                }\n            });\n        });\n    };\n    DefaultDeviceController.prototype.chooseVideoInputDevice = function (device) {\n        var _a, _b;\n        return __awaiter(this, void 0, void 0, function () {\n            var result;\n            return __generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        this.updateMaxBandwidthKbps();\n                        return [4 /*yield*/, this.chooseInputDevice('video', device, false)];\n                    case 1:\n                        result = _c.sent();\n                        if (result === DevicePermission_1.default.PermissionGrantedByUser ||\n                            result === DevicePermission_1.default.PermissionGrantedByBrowser) {\n                            (_b = (_a = this.boundAudioVideoController) === null || _a === void 0 ? void 0 : _a.eventController) === null || _b === void 0 ? void 0 : _b.pushMeetingState(device === null ? 'videoInputUnselected' : 'videoInputSelected');\n                        }\n                        this.trace('chooseVideoInputDevice', device, DevicePermission_1.default[result]);\n                        return [2 /*return*/, result];\n                }\n            });\n        });\n    };\n    DefaultDeviceController.prototype.chooseAudioOutputDevice = function (deviceId) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                this.audioOutputDeviceId = deviceId;\n                this.bindAudioOutput();\n                this.trace('chooseAudioOutputDevice', deviceId, null);\n                return [2 /*return*/];\n            });\n        });\n    };\n    DefaultDeviceController.prototype.enableWebAudio = function (flag) {\n        this.logger.warn('enableWebAudio has been Deprecated and will be removed in v2.0.0. ' +\n            'This API method will removed entirely, along with the corresponding field on MeetingSessionConfiguration. ' +\n            'The MeetingSession will no longer call enableWebAudio on the corresponding DeviceController. ');\n        this.useWebAudio = flag;\n        this.trace('enableWebAudio', flag);\n    };\n    DefaultDeviceController.prototype.addDeviceChangeObserver = function (observer) {\n        this.logger.info('adding device change observer');\n        this.deviceChangeObservers.add(observer);\n        this.trace('addDeviceChangeObserver');\n    };\n    DefaultDeviceController.prototype.removeDeviceChangeObserver = function (observer) {\n        this.logger.info('removing device change observer');\n        this.deviceChangeObservers.delete(observer);\n        this.trace('removeDeviceChangeObserver');\n    };\n    DefaultDeviceController.prototype.createAnalyserNodeForAudioInput = function () {\n        if (!this.activeDevices['audio']) {\n            return null;\n        }\n        var audioContext = DefaultDeviceController.getAudioContext();\n        var analyser = audioContext.createAnalyser();\n        audioContext.createMediaStreamSource(this.activeDevices['audio'].stream).connect(analyser);\n        this.trace('createAnalyserNodeForAudioInput');\n        return analyser;\n    };\n    DefaultDeviceController.prototype.startVideoPreviewForVideoInput = function (element) {\n        var _this = this;\n        if (!this.activeDevices['video']) {\n            this.logger.warn('cannot bind video preview since video input device has not been chosen');\n            this.trace('startVideoPreviewForVideoInput', element.id);\n            return;\n        }\n        // TODO: implement MediaDestroyer to provide single release MediaStream function\n        this.releaseMediaStream(element.srcObject);\n        DefaultVideoTile_1.default.disconnectVideoStreamFromVideoElement(element, false);\n        navigator.mediaDevices\n            .getUserMedia(this.activeDevices['video'].constraints)\n            .then(function (previewStream) {\n            DefaultVideoTile_1.default.connectVideoStreamToVideoElement(previewStream, element, true);\n        })\n            .catch(function (error) {\n            _this.logger.warn(\"Unable to reacquire video stream for preview to element \" + element.id + \": \" + error);\n        });\n        this.trace('startVideoPreviewForVideoInput', element.id);\n    };\n    DefaultDeviceController.prototype.stopVideoPreviewForVideoInput = function (element) {\n        var stream = element.srcObject;\n        if (stream) {\n            this.releaseMediaStream(stream);\n            DefaultVideoTile_1.default.disconnectVideoStreamFromVideoElement(element, false);\n        }\n        if (this.activeDevices['video']) {\n            this.releaseMediaStream(this.activeDevices['video'].stream);\n        }\n        this.trace('stopVideoPreviewForVideoInput', element.id);\n    };\n    DefaultDeviceController.prototype.setDeviceLabelTrigger = function (trigger) {\n        this.deviceLabelTrigger = trigger;\n        this.trace('setDeviceLabelTrigger');\n    };\n    DefaultDeviceController.prototype.mixIntoAudioInput = function (stream) {\n        var node = null;\n        if (this.useWebAudio) {\n            node = DefaultDeviceController.getAudioContext().createMediaStreamSource(stream);\n            node.connect(this.getMediaStreamDestinationNode());\n        }\n        else {\n            this.logger.warn('WebAudio is not enabled, mixIntoAudioInput will not work');\n        }\n        this.trace('mixIntoAudioInput', stream.id);\n        return node;\n    };\n    DefaultDeviceController.prototype.chooseVideoInputQuality = function (width, height, frameRate, maxBandwidthKbps) {\n        var dimension = this.browserBehavior.requiresResolutionAlignment(width, height);\n        this.videoInputQualitySettings = new VideoQualitySettings_1.default(dimension[0], dimension[1], frameRate, maxBandwidthKbps);\n        this.updateMaxBandwidthKbps();\n    };\n    DefaultDeviceController.prototype.getVideoInputQualitySettings = function () {\n        return this.videoInputQualitySettings;\n    };\n    DefaultDeviceController.prototype.acquireAudioInputStream = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.acquireInputStream('audio')];\n                    case 1: return [2 /*return*/, _a.sent()];\n                }\n            });\n        });\n    };\n    DefaultDeviceController.prototype.acquireVideoInputStream = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.acquireInputStream('video')];\n                    case 1: return [2 /*return*/, _a.sent()];\n                }\n            });\n        });\n    };\n    DefaultDeviceController.prototype.acquireDisplayInputStream = function (streamConstraints) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                if (streamConstraints &&\n                    streamConstraints.video &&\n                    // @ts-ignore\n                    streamConstraints.video.mandatory &&\n                    // @ts-ignore\n                    streamConstraints.video.mandatory.chromeMediaSource &&\n                    // @ts-ignore\n                    streamConstraints.video.mandatory.chromeMediaSourceId) {\n                    return [2 /*return*/, navigator.mediaDevices.getUserMedia(streamConstraints)];\n                }\n                // @ts-ignore https://github.com/microsoft/TypeScript/issues/31821\n                return [2 /*return*/, navigator.mediaDevices.getDisplayMedia(streamConstraints)];\n            });\n        });\n    };\n    DefaultDeviceController.prototype.releaseMediaStream = function (mediaStreamToRelease) {\n        var e_1, _a;\n        if (!mediaStreamToRelease) {\n            return;\n        }\n        var tracksToStop = null;\n        if (!!this.audioInputDestinationNode &&\n            mediaStreamToRelease === this.audioInputDestinationNode.stream) {\n            // release the true audio stream if WebAudio is used.\n            this.logger.info('stopping audio track');\n            tracksToStop = this.audioInputSourceNode.mediaStream.getTracks();\n            this.audioInputSourceNode.disconnect();\n        }\n        else {\n            tracksToStop = mediaStreamToRelease.getTracks();\n        }\n        try {\n            for (var tracksToStop_1 = __values(tracksToStop), tracksToStop_1_1 = tracksToStop_1.next(); !tracksToStop_1_1.done; tracksToStop_1_1 = tracksToStop_1.next()) {\n                var track = tracksToStop_1_1.value;\n                this.logger.info(\"stopping \" + track.kind + \" track\");\n                track.stop();\n            }\n        }\n        catch (e_1_1) { e_1 = { error: e_1_1 }; }\n        finally {\n            try {\n                if (tracksToStop_1_1 && !tracksToStop_1_1.done && (_a = tracksToStop_1.return)) _a.call(tracksToStop_1);\n            }\n            finally { if (e_1) throw e_1.error; }\n        }\n        for (var kind in this.activeDevices) {\n            if (this.activeDevices[kind] && this.activeDevices[kind].stream === mediaStreamToRelease) {\n                this.activeDevices[kind] = null;\n                if (kind === 'video' &&\n                    this.boundAudioVideoController &&\n                    this.boundAudioVideoController.videoTileController.hasStartedLocalVideoTile()) {\n                    this.boundAudioVideoController.videoTileController.stopLocalVideoTile();\n                }\n            }\n        }\n    };\n    DefaultDeviceController.prototype.bindToAudioVideoController = function (audioVideoController) {\n        this.boundAudioVideoController = audioVideoController;\n        this.bindAudioOutput();\n    };\n    DefaultDeviceController.createEmptyAudioDevice = function () {\n        return DefaultDeviceController.synthesizeAudioDevice(0);\n    };\n    DefaultDeviceController.createEmptyVideoDevice = function () {\n        return DefaultDeviceController.synthesizeVideoDevice('black');\n    };\n    DefaultDeviceController.synthesizeAudioDevice = function (toneHz) {\n        var audioContext = DefaultDeviceController.getAudioContext();\n        var outputNode = audioContext.createMediaStreamDestination();\n        if (!toneHz) {\n            var source = audioContext.createBufferSource();\n            // The AudioContext object uses the sample rate of the default output device\n            // if not specified. Creating an AudioBuffer object with the output device's\n            // sample rate fails in some browsers, e.g. Safari with a Bluetooth headphone.\n            try {\n                source.buffer = audioContext.createBuffer(1, audioContext.sampleRate * 5, audioContext.sampleRate);\n            }\n            catch (error) {\n                if (error && error.name === 'NotSupportedError') {\n                    source.buffer = audioContext.createBuffer(1, DefaultDeviceController.defaultSampleRate * 5, DefaultDeviceController.defaultSampleRate);\n                }\n                else {\n                    throw error;\n                }\n            }\n            // Some browsers will not play audio out the MediaStreamDestination\n            // unless there is actually audio to play, so we add a small amount of\n            // noise here to ensure that audio is played out.\n            source.buffer.getChannelData(0)[0] = 0.0003;\n            source.loop = true;\n            source.connect(outputNode);\n            source.start();\n        }\n        else {\n            var gainNode = audioContext.createGain();\n            gainNode.gain.value = 0.1;\n            gainNode.connect(outputNode);\n            var oscillatorNode = audioContext.createOscillator();\n            oscillatorNode.frequency.value = toneHz;\n            oscillatorNode.connect(gainNode);\n            oscillatorNode.start();\n        }\n        return outputNode.stream;\n    };\n    DefaultDeviceController.synthesizeVideoDevice = function (colorOrPattern) {\n        var canvas = document.createElement('canvas');\n        canvas.width = 480;\n        canvas.height = (canvas.width / 16) * 9;\n        var scheduler = new IntervalScheduler_1.default(1000);\n        var context = canvas.getContext('2d');\n        // @ts-ignore\n        var stream = canvas.captureStream(5) || null;\n        if (stream) {\n            scheduler.start(function () {\n                if (colorOrPattern === 'smpte') {\n                    DefaultDeviceController.fillSMPTEColorBars(canvas, 0);\n                }\n                else {\n                    context.fillStyle = colorOrPattern;\n                    context.fillRect(0, 0, canvas.width, canvas.height);\n                }\n            });\n            stream.getVideoTracks()[0].addEventListener('ended', function () {\n                scheduler.stop();\n            });\n        }\n        return stream;\n    };\n    DefaultDeviceController.fillSMPTEColorBars = function (canvas, xShift) {\n        var w = canvas.width;\n        var h = canvas.height;\n        var h1 = (h * 2) / 3;\n        var h2 = (h * 3) / 4;\n        var h3 = h;\n        var top = ['#c0c0c0', '#c0c000', '#00c0c0', '#00c000', '#c000c0', '#c00000', '#0000c0'];\n        var middle = ['#0000c0', '#000000', '#c000c0', '#000000', '#00c0c0', '#000000', '#c0c0c0'];\n        var bottom = [\n            '#00214c',\n            '#ffffff',\n            '#32006a',\n            '#131313',\n            '#090909',\n            '#131313',\n            '#1d1d1d',\n            '#131313',\n        ];\n        var bottomX = [\n            w * 0,\n            ((w * 1) / 4) * (5 / 7),\n            ((w * 2) / 4) * (5 / 7),\n            ((w * 3) / 4) * (5 / 7),\n            w * (5 / 7),\n            w * (5 / 7 + 1 / 21),\n            w * (5 / 7 + 2 / 21),\n            w * (6 / 7),\n            w * 1,\n        ];\n        var segmentWidth = w / top.length;\n        var ctx = canvas.getContext('2d');\n        for (var i = 0; i < top.length; i++) {\n            ctx.fillStyle = top[i];\n            ctx.fillRect(xShift + i * segmentWidth, 0, segmentWidth, h1);\n            ctx.fillStyle = middle[i];\n            ctx.fillRect(xShift + i * segmentWidth, h1, segmentWidth, h2 - h1);\n        }\n        for (var i = 0; i < bottom.length; i++) {\n            ctx.fillStyle = bottom[i];\n            ctx.fillRect(xShift + bottomX[i], h2, bottomX[i + 1] - bottomX[i], h3 - h2);\n        }\n    };\n    DefaultDeviceController.prototype.updateMaxBandwidthKbps = function () {\n        if (this.boundAudioVideoController) {\n            this.boundAudioVideoController.setVideoMaxBandwidthKbps(this.videoInputQualitySettings.videoMaxBandwidthKbps);\n        }\n    };\n    DefaultDeviceController.prototype.listDevicesOfKind = function (deviceKind) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (!(this.deviceInfoCache === null)) return [3 /*break*/, 2];\n                        return [4 /*yield*/, this.updateDeviceInfoCacheFromBrowser()];\n                    case 1:\n                        _a.sent();\n                        _a.label = 2;\n                    case 2: return [2 /*return*/, this.listCachedDevicesOfKind(deviceKind)];\n                }\n            });\n        });\n    };\n    DefaultDeviceController.prototype.updateDeviceInfoCacheFromBrowser = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var doesNotHaveAccessToMediaDevices, devices, hasDeviceLabels, devices_1, devices_1_1, device, triggerStream, _a, _b, track, err_1;\n            var e_2, _c, e_3, _d;\n            return __generator(this, function (_e) {\n                switch (_e.label) {\n                    case 0:\n                        doesNotHaveAccessToMediaDevices = !MediaDeviceInfo;\n                        if (doesNotHaveAccessToMediaDevices) {\n                            this.deviceInfoCache = [];\n                            return [2 /*return*/];\n                        }\n                        return [4 /*yield*/, navigator.mediaDevices.enumerateDevices()];\n                    case 1:\n                        devices = _e.sent();\n                        hasDeviceLabels = true;\n                        try {\n                            for (devices_1 = __values(devices), devices_1_1 = devices_1.next(); !devices_1_1.done; devices_1_1 = devices_1.next()) {\n                                device = devices_1_1.value;\n                                if (!device.label) {\n                                    hasDeviceLabels = false;\n                                    break;\n                                }\n                            }\n                        }\n                        catch (e_2_1) { e_2 = { error: e_2_1 }; }\n                        finally {\n                            try {\n                                if (devices_1_1 && !devices_1_1.done && (_c = devices_1.return)) _c.call(devices_1);\n                            }\n                            finally { if (e_2) throw e_2.error; }\n                        }\n                        if (!!hasDeviceLabels) return [3 /*break*/, 6];\n                        _e.label = 2;\n                    case 2:\n                        _e.trys.push([2, 5, , 6]);\n                        this.logger.info('attempting to trigger media device labels since they are hidden');\n                        return [4 /*yield*/, this.deviceLabelTrigger()];\n                    case 3:\n                        triggerStream = _e.sent();\n                        return [4 /*yield*/, navigator.mediaDevices.enumerateDevices()];\n                    case 4:\n                        devices = _e.sent();\n                        try {\n                            for (_a = __values(triggerStream.getTracks()), _b = _a.next(); !_b.done; _b = _a.next()) {\n                                track = _b.value;\n                                track.stop();\n                            }\n                        }\n                        catch (e_3_1) { e_3 = { error: e_3_1 }; }\n                        finally {\n                            try {\n                                if (_b && !_b.done && (_d = _a.return)) _d.call(_a);\n                            }\n                            finally { if (e_3) throw e_3.error; }\n                        }\n                        return [3 /*break*/, 6];\n                    case 5:\n                        err_1 = _e.sent();\n                        this.logger.info('unable to get media device labels');\n                        return [3 /*break*/, 6];\n                    case 6:\n                        this.deviceInfoCache = devices;\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    DefaultDeviceController.prototype.listCachedDevicesOfKind = function (deviceKind) {\n        var e_4, _a;\n        var devicesOfKind = [];\n        try {\n            for (var _b = __values(this.deviceInfoCache), _c = _b.next(); !_c.done; _c = _b.next()) {\n                var device = _c.value;\n                if (device.kind === deviceKind) {\n                    devicesOfKind.push(device);\n                }\n            }\n        }\n        catch (e_4_1) { e_4 = { error: e_4_1 }; }\n        finally {\n            try {\n                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\n            }\n            finally { if (e_4) throw e_4.error; }\n        }\n        return devicesOfKind;\n    };\n    DefaultDeviceController.prototype.handleDeviceChange = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var oldAudioInputDevices, oldVideoInputDevices, oldAudioOutputDevices, newAudioInputDevices, newVideoInputDevices, newAudioOutputDevices;\n            var _this = this;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (this.deviceInfoCache === null) {\n                            return [2 /*return*/];\n                        }\n                        if (this.alreadyHandlingDeviceChange) {\n                            new AsyncScheduler_1.default().start(function () {\n                                _this.handleDeviceChange();\n                            });\n                            return [2 /*return*/];\n                        }\n                        this.alreadyHandlingDeviceChange = true;\n                        oldAudioInputDevices = this.listCachedDevicesOfKind('audioinput');\n                        oldVideoInputDevices = this.listCachedDevicesOfKind('videoinput');\n                        oldAudioOutputDevices = this.listCachedDevicesOfKind('audiooutput');\n                        return [4 /*yield*/, this.updateDeviceInfoCacheFromBrowser()];\n                    case 1:\n                        _a.sent();\n                        newAudioInputDevices = this.listCachedDevicesOfKind('audioinput');\n                        newVideoInputDevices = this.listCachedDevicesOfKind('videoinput');\n                        newAudioOutputDevices = this.listCachedDevicesOfKind('audiooutput');\n                        this.forEachObserver(function (observer) {\n                            if (!_this.areDeviceListsEqual(oldAudioInputDevices, newAudioInputDevices)) {\n                                Maybe_1.default.of(observer.audioInputsChanged).map(function (f) { return f.bind(observer)(newAudioInputDevices); });\n                            }\n                            if (!_this.areDeviceListsEqual(oldVideoInputDevices, newVideoInputDevices)) {\n                                Maybe_1.default.of(observer.videoInputsChanged).map(function (f) { return f.bind(observer)(newVideoInputDevices); });\n                            }\n                            if (!_this.areDeviceListsEqual(oldAudioOutputDevices, newAudioOutputDevices)) {\n                                Maybe_1.default.of(observer.audioOutputsChanged).map(function (f) { return f.bind(observer)(newAudioOutputDevices); });\n                            }\n                        });\n                        this.alreadyHandlingDeviceChange = false;\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    DefaultDeviceController.prototype.handleDeviceStreamEnded = function (kind, deviceId) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.chooseInputDevice(kind, null, false)];\n                    case 1:\n                        _a.sent();\n                        if (kind === 'audio') {\n                            this.forEachObserver(function (observer) {\n                                Maybe_1.default.of(observer.audioInputStreamEnded).map(function (f) { return f.bind(observer)(deviceId); });\n                            });\n                        }\n                        else {\n                            this.forEachObserver(function (observer) {\n                                Maybe_1.default.of(observer.videoInputStreamEnded).map(function (f) { return f.bind(observer)(deviceId); });\n                            });\n                        }\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    DefaultDeviceController.prototype.forEachObserver = function (observerFunc) {\n        var e_5, _a;\n        var _this = this;\n        var _loop_1 = function (observer) {\n            new AsyncScheduler_1.default().start(function () {\n                /* istanbul ignore else */\n                if (_this.deviceChangeObservers.has(observer)) {\n                    observerFunc(observer);\n                }\n            });\n        };\n        try {\n            for (var _b = __values(this.deviceChangeObservers), _c = _b.next(); !_c.done; _c = _b.next()) {\n                var observer = _c.value;\n                _loop_1(observer);\n            }\n        }\n        catch (e_5_1) { e_5 = { error: e_5_1 }; }\n        finally {\n            try {\n                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\n            }\n            finally { if (e_5) throw e_5.error; }\n        }\n    };\n    DefaultDeviceController.prototype.areDeviceListsEqual = function (a, b) {\n        return (JSON.stringify(a.map(function (device) { return JSON.stringify(device); }).sort()) ===\n            JSON.stringify(b.map(function (device) { return JSON.stringify(device); }).sort()));\n    };\n    DefaultDeviceController.prototype.deviceAsMediaStream = function (device) {\n        // @ts-ignore\n        return device && device.id ? device : null;\n    };\n    DefaultDeviceController.prototype.hasSameGroupId = function (groupId, kind, device) {\n        device = this.getDeviceIdStr(device);\n        if (groupId === this.getGroupIdFromDeviceId(kind, device) || groupId === '') {\n            return true;\n        }\n        return false;\n    };\n    DefaultDeviceController.prototype.getGroupIdFromDeviceId = function (kind, device) {\n        if (this.deviceInfoCache !== null) {\n            var cachedDeviceInfo = this.listCachedDevicesOfKind(kind + \"input\").find(function (cachedDevice) { return cachedDevice.deviceId === device; });\n            if (cachedDeviceInfo && cachedDeviceInfo.groupId) {\n                return cachedDeviceInfo.groupId;\n            }\n        }\n        return '';\n    };\n    DefaultDeviceController.prototype.getDeviceIdStr = function (device) {\n        if (device === null) {\n            return null;\n        }\n        else if (typeof device === 'string') {\n            return device;\n        }\n        else if (device.id) {\n            return device.id;\n        }\n        var constraints = device;\n        if (!constraints.deviceId) {\n            return '';\n        }\n        else if (typeof constraints.deviceId === 'string') {\n            return constraints.deviceId;\n        }\n        var deviceIdConstraint = constraints.deviceId;\n        if (typeof deviceIdConstraint.exact === 'string') {\n            return deviceIdConstraint.exact;\n        }\n        return '';\n    };\n    DefaultDeviceController.prototype.getActiveDeviceId = function (kind) {\n        /* istanbul ignore else */\n        if (this.activeDevices[kind] && this.activeDevices[kind].constraints) {\n            var activeDeviceMediaTrackConstraints = this.activeDevices[kind].constraints.audio || this.activeDevices[kind].constraints.video;\n            var activeDeviceConstrainDOMStringParameters = activeDeviceMediaTrackConstraints\n                .deviceId;\n            var activeDeviceId = void 0;\n            if (typeof activeDeviceConstrainDOMStringParameters === 'string') {\n                activeDeviceId = activeDeviceConstrainDOMStringParameters;\n            }\n            else {\n                activeDeviceId = activeDeviceConstrainDOMStringParameters\n                    .exact;\n            }\n            return activeDeviceId;\n        }\n        /* istanbul ignore next */\n        return null;\n    };\n    DefaultDeviceController.prototype.restartLocalVideoAfterSelection = function (oldStream, fromAcquire) {\n        var _this = this;\n        if (!fromAcquire &&\n            this.boundAudioVideoController &&\n            this.boundAudioVideoController.videoTileController.hasStartedLocalVideoTile()) {\n            this.logger.info('restarting local video to switch to new device');\n            this.boundAudioVideoController.restartLocalVideo(function () {\n                // TODO: implement MediaStreamDestroyer\n                // tracks of oldStream should be stopped when video tile is disconnected from MediaStream\n                // otherwise, camera is still being accessed and we need to stop it here.\n                if (oldStream && oldStream.active) {\n                    _this.logger.warn('previous media stream is not stopped during restart video');\n                    _this.releaseMediaStream(oldStream);\n                }\n            });\n        }\n        else {\n            this.releaseMediaStream(oldStream);\n        }\n    };\n    DefaultDeviceController.prototype.chooseInputDevice = function (kind, device, fromAcquire) {\n        var _a, _b, _c, _d;\n        return __awaiter(this, void 0, void 0, function () {\n            function grantedForDuration(start, end) {\n                return end - start < DefaultDeviceController.permissionGrantedOriginDetectionThresholdMs\n                    ? DevicePermission_1.default.PermissionGrantedByBrowser\n                    : DevicePermission_1.default.PermissionGrantedByUser;\n            }\n            function deniedForDuration(start, end) {\n                return end - start < DefaultDeviceController.permissionDeniedOriginDetectionThresholdMs\n                    ? DevicePermission_1.default.PermissionDeniedByBrowser\n                    : DevicePermission_1.default.PermissionDeniedByUser;\n            }\n            var callCount, proposedConstraints, startTimeMs, newDevice, stream, _e, error_1, errorMessage, error_2;\n            var _this = this;\n            return __generator(this, function (_f) {\n                switch (_f.label) {\n                    case 0:\n                        this.inputDeviceCount += 1;\n                        callCount = this.inputDeviceCount;\n                        if (device === null && kind === 'video') {\n                            this.lastNoVideoInputDeviceCount = this.inputDeviceCount;\n                            if (this.activeDevices[kind]) {\n                                this.releaseMediaStream(this.activeDevices[kind].stream);\n                                delete this.activeDevices[kind];\n                            }\n                            return [2 /*return*/, DevicePermission_1.default.PermissionGrantedByBrowser];\n                        }\n                        proposedConstraints = this.calculateMediaStreamConstraints(kind, device);\n                        if (this.activeDevices[kind] &&\n                            this.activeDevices[kind].matchesConstraints(proposedConstraints) &&\n                            this.activeDevices[kind].stream.active &&\n                            this.activeDevices[kind].groupId !== null &&\n                            this.hasSameGroupId(this.activeDevices[kind].groupId, kind, device)) {\n                            this.logger.info(\"reusing existing \" + kind + \" device\");\n                            return [2 /*return*/, DevicePermission_1.default.PermissionGrantedPreviously];\n                        }\n                        if (kind === 'audio' && this.activeDevices[kind] && this.activeDevices[kind].stream) {\n                            this.releaseMediaStream(this.activeDevices[kind].stream);\n                        }\n                        startTimeMs = Date.now();\n                        newDevice = new DeviceSelection_1.default();\n                        _f.label = 1;\n                    case 1:\n                        _f.trys.push([1, 7, , 12]);\n                        this.logger.info(\"requesting new \" + kind + \" device with constraint \" + JSON.stringify(proposedConstraints));\n                        stream = this.deviceAsMediaStream(device);\n                        if (!(kind === 'audio' && device === null)) return [3 /*break*/, 2];\n                        newDevice.stream = DefaultDeviceController.createEmptyAudioDevice();\n                        newDevice.constraints = null;\n                        return [3 /*break*/, 6];\n                    case 2:\n                        if (!stream) return [3 /*break*/, 3];\n                        this.logger.info(\"using media stream \" + stream.id + \" for \" + kind + \" device\");\n                        newDevice.stream = stream;\n                        newDevice.constraints = proposedConstraints;\n                        return [3 /*break*/, 6];\n                    case 3:\n                        _e = newDevice;\n                        return [4 /*yield*/, navigator.mediaDevices.getUserMedia(proposedConstraints)];\n                    case 4:\n                        _e.stream = _f.sent();\n                        newDevice.constraints = proposedConstraints;\n                        if (kind === 'video' && this.lastNoVideoInputDeviceCount > callCount) {\n                            this.logger.warn(\"ignored to get video device for constraints \" + JSON.stringify(proposedConstraints) + \" as no device was requested\");\n                            this.releaseMediaStream(newDevice.stream);\n                            return [2 /*return*/, DevicePermission_1.default.PermissionGrantedByUser];\n                        }\n                        return [4 /*yield*/, this.handleDeviceChange()];\n                    case 5:\n                        _f.sent();\n                        newDevice.stream.getTracks()[0].addEventListener('ended', function () {\n                            if (_this.activeDevices[kind] && _this.activeDevices[kind].stream === newDevice.stream) {\n                                _this.logger.warn(kind + \" input device which was active is no longer available, resetting to null device\");\n                                _this.handleDeviceStreamEnded(kind, _this.getActiveDeviceId(kind));\n                            }\n                        });\n                        _f.label = 6;\n                    case 6:\n                        newDevice.groupId = this.getGroupIdFromDeviceId(kind, this.getDeviceIdStr(device));\n                        return [3 /*break*/, 12];\n                    case 7:\n                        error_1 = _f.sent();\n                        errorMessage = void 0;\n                        if ((error_1 === null || error_1 === void 0 ? void 0 : error_1.name) && error_1.message) {\n                            errorMessage = error_1.name + \": \" + error_1.message;\n                        }\n                        else if (error_1 === null || error_1 === void 0 ? void 0 : error_1.name) {\n                            errorMessage = error_1.name;\n                        }\n                        else if (error_1 === null || error_1 === void 0 ? void 0 : error_1.message) {\n                            errorMessage = error_1.message;\n                        }\n                        else {\n                            errorMessage = 'UnknownError';\n                        }\n                        if (kind === 'audio') {\n                            (_b = (_a = this.boundAudioVideoController) === null || _a === void 0 ? void 0 : _a.eventController) === null || _b === void 0 ? void 0 : _b.publishEvent('audioInputFailed', {\n                                audioInputErrorMessage: errorMessage,\n                            });\n                        }\n                        else {\n                            (_d = (_c = this.boundAudioVideoController) === null || _c === void 0 ? void 0 : _c.eventController) === null || _d === void 0 ? void 0 : _d.publishEvent('videoInputFailed', {\n                                videoInputErrorMessage: errorMessage,\n                            });\n                        }\n                        this.logger.error(\"failed to get \" + kind + \" device for constraints \" + JSON.stringify(proposedConstraints) + \": \" + errorMessage);\n                        if (!(kind === 'audio')) return [3 /*break*/, 11];\n                        this.logger.info(\"choosing null \" + kind + \" device instead\");\n                        _f.label = 8;\n                    case 8:\n                        _f.trys.push([8, 10, , 11]);\n                        newDevice.stream = DefaultDeviceController.createEmptyAudioDevice();\n                        newDevice.constraints = null;\n                        return [4 /*yield*/, this.handleNewInputDevice(kind, newDevice, fromAcquire)];\n                    case 9:\n                        _f.sent();\n                        return [3 /*break*/, 11];\n                    case 10:\n                        error_2 = _f.sent();\n                        this.logger.error(\"failed to choose null \" + kind + \" device. \" + error_2.name + \": \" + error_2.message);\n                        return [3 /*break*/, 11];\n                    case 11: return [2 /*return*/, deniedForDuration(startTimeMs, Date.now())];\n                    case 12:\n                        this.logger.info(\"got \" + kind + \" device for constraints \" + JSON.stringify(proposedConstraints));\n                        return [4 /*yield*/, this.handleNewInputDevice(kind, newDevice, fromAcquire)];\n                    case 13:\n                        _f.sent();\n                        return [2 /*return*/, grantedForDuration(startTimeMs, Date.now())];\n                }\n            });\n        });\n    };\n    DefaultDeviceController.prototype.handleNewInputDevice = function (kind, newDevice, fromAcquire) {\n        return __awaiter(this, void 0, void 0, function () {\n            var oldStream, error_3;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        oldStream = this.activeDevices[kind]\n                            ? this.activeDevices[kind].stream\n                            : null;\n                        this.activeDevices[kind] = newDevice;\n                        if (!(kind === 'video')) return [3 /*break*/, 1];\n                        this.restartLocalVideoAfterSelection(oldStream, fromAcquire);\n                        return [3 /*break*/, 8];\n                    case 1:\n                        this.releaseMediaStream(oldStream);\n                        if (!this.useWebAudio) return [3 /*break*/, 2];\n                        this.attachAudioInputStreamToAudioContext(this.activeDevices[kind].stream);\n                        return [3 /*break*/, 8];\n                    case 2:\n                        if (!this.boundAudioVideoController) return [3 /*break*/, 7];\n                        _a.label = 3;\n                    case 3:\n                        _a.trys.push([3, 5, , 6]);\n                        return [4 /*yield*/, this.boundAudioVideoController.restartLocalAudio(function () { })];\n                    case 4:\n                        _a.sent();\n                        return [3 /*break*/, 6];\n                    case 5:\n                        error_3 = _a.sent();\n                        this.logger.info(\"cannot replace audio track due to: \" + error_3.message);\n                        return [3 /*break*/, 6];\n                    case 6: return [3 /*break*/, 8];\n                    case 7:\n                        this.logger.info('no audio-video controller is bound to the device controller');\n                        _a.label = 8;\n                    case 8: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    DefaultDeviceController.prototype.bindAudioOutput = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var deviceInfo;\n            return __generator(this, function (_a) {\n                if (!this.boundAudioVideoController) {\n                    return [2 /*return*/];\n                }\n                deviceInfo = this.deviceInfoFromDeviceId('audiooutput', this.audioOutputDeviceId);\n                // TODO: fail promise if audio output device cannot be selected or setSinkId promise rejects\n                this.boundAudioVideoController.audioMixController.bindAudioDevice(deviceInfo);\n                return [2 /*return*/];\n            });\n        });\n    };\n    DefaultDeviceController.prototype.calculateMediaStreamConstraints = function (kind, device) {\n        var trackConstraints = {};\n        if (device === '') {\n            device = null;\n        }\n        var stream = this.deviceAsMediaStream(device);\n        if (device === null) {\n            return null;\n        }\n        else if (typeof device === 'string') {\n            if (this.browserBehavior.requiresNoExactMediaStreamConstraints()) {\n                trackConstraints.deviceId = device;\n            }\n            else {\n                trackConstraints.deviceId = { exact: device };\n            }\n        }\n        else if (stream) {\n            // @ts-ignore - create a fake track constraint using the stream id\n            trackConstraints.streamId = stream.id;\n        }\n        else {\n            // @ts-ignore - device is a MediaTrackConstraints\n            trackConstraints = device;\n        }\n        if (kind === 'video') {\n            trackConstraints.width = trackConstraints.width || {\n                ideal: this.videoInputQualitySettings.videoWidth,\n            };\n            trackConstraints.height = trackConstraints.height || {\n                ideal: this.videoInputQualitySettings.videoHeight,\n            };\n            trackConstraints.frameRate = trackConstraints.frameRate || {\n                ideal: this.videoInputQualitySettings.videoFrameRate,\n            };\n            // TODO: try to replace hard-code value related to videos into quality-level presets\n            // The following configs relaxes CPU overuse detection threshold to offer better encoding quality\n            // @ts-ignore\n            trackConstraints.googCpuOveruseDetection = true;\n            // @ts-ignore\n            trackConstraints.googCpuOveruseEncodeUsage = true;\n            // @ts-ignore\n            trackConstraints.googCpuOveruseThreshold = 85;\n            // @ts-ignore\n            trackConstraints.googCpuUnderuseThreshold = 55;\n        }\n        if (kind === 'audio' && this.supportSampleRateConstraint()) {\n            trackConstraints.sampleRate = { ideal: DefaultDeviceController.defaultSampleRate };\n        }\n        if (kind === 'audio' && this.supportSampleSizeConstraint()) {\n            trackConstraints.sampleSize = { ideal: DefaultDeviceController.defaultSampleSize };\n        }\n        if (kind === 'audio' && this.supportChannelCountConstraint()) {\n            trackConstraints.channelCount = { ideal: DefaultDeviceController.defaultChannelCount };\n        }\n        if (kind === 'audio') {\n            // @ts-ignore\n            trackConstraints.echoCancellation = true;\n            // @ts-ignore\n            trackConstraints.googEchoCancellation = true;\n            // @ts-ignore\n            trackConstraints.googAutoGainControl = true;\n            // @ts-ignore\n            trackConstraints.googNoiseSuppression = true;\n            // @ts-ignore\n            trackConstraints.googHighpassFilter = true;\n            // @ts-ignore\n            trackConstraints.googNoiseSuppression2 = true;\n            // @ts-ignore\n            trackConstraints.googEchoCancellation2 = true;\n            // @ts-ignore\n            trackConstraints.googAutoGainControl2 = true;\n        }\n        return kind === 'audio' ? { audio: trackConstraints } : { video: trackConstraints };\n    };\n    DefaultDeviceController.prototype.deviceInfoFromDeviceId = function (deviceKind, deviceId) {\n        var e_6, _a;\n        if (this.deviceInfoCache === null) {\n            return null;\n        }\n        try {\n            for (var _b = __values(this.deviceInfoCache), _c = _b.next(); !_c.done; _c = _b.next()) {\n                var device = _c.value;\n                if (device.kind === deviceKind && device.deviceId === deviceId) {\n                    return device;\n                }\n            }\n        }\n        catch (e_6_1) { e_6 = { error: e_6_1 }; }\n        finally {\n            try {\n                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\n            }\n            finally { if (e_6) throw e_6.error; }\n        }\n        return null;\n    };\n    DefaultDeviceController.prototype.acquireInputStream = function (kind) {\n        return __awaiter(this, void 0, void 0, function () {\n            var existingConstraints, active, result;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (kind === 'audio') {\n                            if (this.useWebAudio) {\n                                return [2 /*return*/, this.getMediaStreamDestinationNode().stream];\n                            }\n                        }\n                        existingConstraints = null;\n                        if (!this.activeDevices[kind]) {\n                            if (kind === 'audio') {\n                                this.logger.info(\"no \" + kind + \" device chosen, creating empty \" + kind + \" device\");\n                            }\n                            else {\n                                this.logger.error(\"no \" + kind + \" device chosen, stopping local video tile\");\n                                this.boundAudioVideoController.videoTileController.stopLocalVideoTile();\n                                throw new Error(\"no \" + kind + \" device chosen, stopping local video tile\");\n                            }\n                        }\n                        else {\n                            this.logger.info(\"checking whether existing \" + kind + \" device can be reused\");\n                            active = this.activeDevices[kind];\n                            // @ts-ignore\n                            existingConstraints = active.constraints ? active.constraints[kind] : null;\n                        }\n                        return [4 /*yield*/, this.chooseInputDevice(kind, existingConstraints, true)];\n                    case 1:\n                        result = _a.sent();\n                        if (result === DevicePermission_1.default.PermissionDeniedByBrowser ||\n                            result === DevicePermission_1.default.PermissionDeniedByUser) {\n                            this.logger.error(\"unable to acquire \" + kind + \" device\");\n                            throw new Error(\"unable to acquire \" + kind + \" device\");\n                        }\n                        return [2 /*return*/, this.activeDevices[kind].stream];\n                }\n            });\n        });\n    };\n    DefaultDeviceController.prototype.attachAudioInputStreamToAudioContext = function (stream) {\n        if (this.audioInputSourceNode) {\n            this.audioInputSourceNode.disconnect();\n        }\n        this.audioInputSourceNode = DefaultDeviceController.getAudioContext().createMediaStreamSource(stream);\n        this.audioInputSourceNode.connect(this.getMediaStreamDestinationNode());\n    };\n    DefaultDeviceController.prototype.getMediaStreamDestinationNode = function () {\n        if (!this.audioInputDestinationNode) {\n            this.audioInputDestinationNode = DefaultDeviceController.getAudioContext().createMediaStreamDestination();\n        }\n        return this.audioInputDestinationNode;\n    };\n    DefaultDeviceController.getAudioContext = function () {\n        if (!DefaultDeviceController.audioContext) {\n            var options = {};\n            if (navigator.mediaDevices.getSupportedConstraints().sampleRate) {\n                options.sampleRate = DefaultDeviceController.defaultSampleRate;\n            }\n            // @ts-ignore\n            DefaultDeviceController.audioContext = new (window.AudioContext || window.webkitAudioContext)(options);\n        }\n        return DefaultDeviceController.audioContext;\n    };\n    DefaultDeviceController.closeAudioContext = function () {\n        if (DefaultDeviceController.audioContext) {\n            DefaultDeviceController.audioContext.close();\n        }\n        DefaultDeviceController.audioContext = null;\n    };\n    DefaultDeviceController.prototype.supportSampleRateConstraint = function () {\n        return this.useWebAudio && !!navigator.mediaDevices.getSupportedConstraints().sampleRate;\n    };\n    DefaultDeviceController.prototype.supportSampleSizeConstraint = function () {\n        return this.useWebAudio && !!navigator.mediaDevices.getSupportedConstraints().sampleSize;\n    };\n    DefaultDeviceController.prototype.supportChannelCountConstraint = function () {\n        return this.useWebAudio && !!navigator.mediaDevices.getSupportedConstraints().channelCount;\n    };\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    DefaultDeviceController.prototype.trace = function (name, input, output) {\n        var s = \"API/DefaultDeviceController/\" + name;\n        if (typeof input !== 'undefined') {\n            s += \" \" + JSON.stringify(input);\n        }\n        if (typeof output !== 'undefined') {\n            s += \" -> \" + JSON.stringify(output);\n        }\n        this.logger.info(s);\n    };\n    DefaultDeviceController.permissionGrantedOriginDetectionThresholdMs = 1000;\n    DefaultDeviceController.permissionDeniedOriginDetectionThresholdMs = 500;\n    DefaultDeviceController.defaultVideoWidth = 960;\n    DefaultDeviceController.defaultVideoHeight = 540;\n    DefaultDeviceController.defaultVideoFrameRate = 15;\n    DefaultDeviceController.defaultVideoMaxBandwidthKbps = 1400;\n    DefaultDeviceController.defaultSampleRate = 48000;\n    DefaultDeviceController.defaultSampleSize = 16;\n    DefaultDeviceController.defaultChannelCount = 1;\n    DefaultDeviceController.audioContext = null;\n    return DefaultDeviceController;\n}());\nexports.default = DefaultDeviceController;\n//# sourceMappingURL=DefaultDeviceController.js.map"]},"metadata":{},"sourceType":"script"}