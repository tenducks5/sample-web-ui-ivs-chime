{"ast":null,"code":"\"use strict\"; // Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n\nvar __extends = this && this.__extends || function () {\n  var _extendStatics = function extendStatics(d, b) {\n    _extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) {\n        if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n      }\n    };\n\n    return _extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    _extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function sent() {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (_) {\n      try {\n        if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n        if (y = 0, t) op = [op[0] & 2, t.value];\n\n        switch (op[0]) {\n          case 0:\n          case 1:\n            t = op;\n            break;\n\n          case 4:\n            _.label++;\n            return {\n              value: op[1],\n              done: false\n            };\n\n          case 5:\n            _.label++;\n            y = op[1];\n            op = [0];\n            continue;\n\n          case 7:\n            op = _.ops.pop();\n\n            _.trys.pop();\n\n            continue;\n\n          default:\n            if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n              _ = 0;\n              continue;\n            }\n\n            if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n              _.label = op[1];\n              break;\n            }\n\n            if (op[0] === 6 && _.label < t[1]) {\n              _.label = t[1];\n              t = op;\n              break;\n            }\n\n            if (t && _.label < t[2]) {\n              _.label = t[2];\n\n              _.ops.push(op);\n\n              break;\n            }\n\n            if (t[2]) _.ops.pop();\n\n            _.trys.pop();\n\n            continue;\n        }\n\n        op = body.call(thisArg, _);\n      } catch (e) {\n        op = [6, e];\n        y = 0;\n      } finally {\n        f = t = 0;\n      }\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar DefaultAudioMixController_1 = require(\"../audiomixcontroller/DefaultAudioMixController\");\n\nvar DefaultBrowserBehavior_1 = require(\"../browserbehavior/DefaultBrowserBehavior\");\n\nvar DefaultDeviceController_1 = require(\"../devicecontroller/DefaultDeviceController\");\n\nvar DevicePermission_1 = require(\"../devicecontroller/DevicePermission\");\n\nvar TimeoutScheduler_1 = require(\"../scheduler/TimeoutScheduler\");\n\nvar BaseTask_1 = require(\"../task/BaseTask\");\n\nvar TimeoutTask_1 = require(\"../task/TimeoutTask\");\n\nvar CheckAudioConnectivityFeedback_1 = require(\"./CheckAudioConnectivityFeedback\");\n\nvar CheckAudioInputFeedback_1 = require(\"./CheckAudioInputFeedback\");\n\nvar CheckAudioOutputFeedback_1 = require(\"./CheckAudioOutputFeedback\");\n\nvar CheckCameraResolutionFeedback_1 = require(\"./CheckCameraResolutionFeedback\");\n\nvar CheckContentShareConnectivityFeedback_1 = require(\"./CheckContentShareConnectivityFeedback\");\n\nvar CheckNetworkTCPConnectivityFeedback_1 = require(\"./CheckNetworkTCPConnectivityFeedback\");\n\nvar CheckNetworkUDPConnectivityFeedback_1 = require(\"./CheckNetworkUDPConnectivityFeedback\");\n\nvar CheckVideoConnectivityFeedback_1 = require(\"./CheckVideoConnectivityFeedback\");\n\nvar CheckVideoInputFeedback_1 = require(\"./CheckVideoInputFeedback\");\n\nvar MeetingReadinessCheckerConfiguration_1 = require(\"./MeetingReadinessCheckerConfiguration\");\n\nvar DefaultMeetingReadinessChecker =\n/** @class */\nfunction () {\n  function DefaultMeetingReadinessChecker(logger, meetingSession, configuration) {\n    if (configuration === void 0) {\n      configuration = new MeetingReadinessCheckerConfiguration_1.default();\n    }\n\n    this.logger = logger;\n    this.meetingSession = meetingSession;\n    this.configuration = configuration;\n    this.browserBehavior = new DefaultBrowserBehavior_1.default();\n  }\n\n  DefaultMeetingReadinessChecker.delay = function (timeoutMs) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , new Promise(function (resolve) {\n              return new TimeoutScheduler_1.default(timeoutMs).start(resolve);\n            })];\n\n          case 1:\n            _a.sent();\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  DefaultMeetingReadinessChecker.prototype.checkAudioInput = function (audioInputDeviceInfo) {\n    return __awaiter(this, void 0, void 0, function () {\n      var result, error_1;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            _a.trys.push([0, 5,, 6]);\n\n            return [4\n            /*yield*/\n            , this.meetingSession.audioVideo.chooseAudioInputDevice(audioInputDeviceInfo)];\n\n          case 1:\n            result = _a.sent();\n            if (!(result === DevicePermission_1.default.PermissionDeniedByBrowser || result === DevicePermission_1.default.PermissionDeniedByUser)) return [3\n            /*break*/\n            , 2];\n            return [2\n            /*return*/\n            , CheckAudioInputFeedback_1.default.PermissionDenied];\n\n          case 2:\n            return [4\n            /*yield*/\n            , this.meetingSession.audioVideo.chooseAudioInputDevice(null)];\n\n          case 3:\n            _a.sent();\n\n            return [2\n            /*return*/\n            , CheckAudioInputFeedback_1.default.Succeeded];\n\n          case 4:\n            return [3\n            /*break*/\n            , 6];\n\n          case 5:\n            error_1 = _a.sent();\n            this.logger.error(\"MeetingReadinessChecker: Audio input check failed with error \" + error_1);\n            return [2\n            /*return*/\n            , CheckAudioInputFeedback_1.default.Failed];\n\n          case 6:\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  DefaultMeetingReadinessChecker.prototype.checkAudioOutput = function (audioOutputDeviceInfo, audioOutputVerificationCallback, audioElement) {\n    if (audioElement === void 0) {\n      audioElement = null;\n    }\n\n    return __awaiter(this, void 0, void 0, function () {\n      var audioOutputDeviceId, userFeedback, error_2;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            _a.trys.push([0, 2, 3, 4]);\n\n            audioOutputDeviceId = audioOutputDeviceInfo && audioOutputDeviceInfo.deviceId ? audioOutputDeviceInfo.deviceId : '';\n            this.playTone(audioOutputDeviceId, 440, audioElement);\n            return [4\n            /*yield*/\n            , audioOutputVerificationCallback()];\n\n          case 1:\n            userFeedback = _a.sent();\n\n            if (userFeedback) {\n              return [2\n              /*return*/\n              , CheckAudioOutputFeedback_1.default.Succeeded];\n            } else {\n              return [2\n              /*return*/\n              , CheckAudioOutputFeedback_1.default.Failed];\n            }\n\n            return [3\n            /*break*/\n            , 4];\n\n          case 2:\n            error_2 = _a.sent();\n            this.logger.error(\"MeetingReadinessChecker: Audio output check failed with error: \" + error_2);\n            return [2\n            /*return*/\n            , CheckAudioOutputFeedback_1.default.Failed];\n\n          case 3:\n            this.stopTone();\n            return [7\n            /*endfinally*/\n            ];\n\n          case 4:\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  DefaultMeetingReadinessChecker.prototype.playTone = function (sinkId, frequency, audioElement) {\n    var rampSec = 0.1;\n    var maxGainValue = 0.1;\n\n    if (this.oscillatorNode) {\n      this.stopTone();\n    }\n\n    this.audioContext = DefaultDeviceController_1.default.getAudioContext();\n    this.gainNode = this.audioContext.createGain();\n    this.gainNode.gain.value = 0;\n    this.oscillatorNode = this.audioContext.createOscillator();\n    this.oscillatorNode.frequency.value = frequency;\n    this.oscillatorNode.connect(this.gainNode);\n    this.destinationStream = this.audioContext.createMediaStreamDestination();\n    this.gainNode.connect(this.destinationStream);\n    var currentTime = this.audioContext.currentTime;\n    var startTime = currentTime + 0.1;\n    this.gainNode.gain.linearRampToValueAtTime(0, startTime);\n    this.gainNode.gain.linearRampToValueAtTime(maxGainValue, startTime + rampSec);\n    this.oscillatorNode.start();\n    var audioMixController = new DefaultAudioMixController_1.default(); // @ts-ignore\n\n    audioMixController.bindAudioDevice({\n      deviceId: sinkId\n    });\n    audioMixController.bindAudioElement(audioElement || new Audio());\n    audioMixController.bindAudioStream(this.destinationStream.stream);\n  };\n\n  DefaultMeetingReadinessChecker.prototype.stopTone = function () {\n    if (!this.audioContext || !this.gainNode || !this.oscillatorNode || !this.destinationStream) {\n      return;\n    }\n\n    var durationSec = 1;\n    var rampSec = 0.1;\n    var maxGainValue = 0.1;\n    var currentTime = this.audioContext.currentTime;\n    this.gainNode.gain.linearRampToValueAtTime(maxGainValue, currentTime + rampSec + durationSec);\n    this.gainNode.gain.linearRampToValueAtTime(0, currentTime + rampSec * 2 + durationSec);\n    this.oscillatorNode.stop();\n    this.oscillatorNode.disconnect(this.gainNode);\n    this.gainNode.disconnect(this.destinationStream);\n    this.oscillatorNode = null;\n    this.gainNode = null;\n    this.destinationStream = null;\n  };\n\n  DefaultMeetingReadinessChecker.prototype.checkVideoInput = function (videoInputDeviceInfo) {\n    return __awaiter(this, void 0, void 0, function () {\n      var result, error_3;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            _a.trys.push([0, 5,, 6]);\n\n            return [4\n            /*yield*/\n            , this.meetingSession.audioVideo.chooseVideoInputDevice(videoInputDeviceInfo)];\n\n          case 1:\n            result = _a.sent();\n            if (!(result === DevicePermission_1.default.PermissionDeniedByBrowser || result === DevicePermission_1.default.PermissionDeniedByUser)) return [3\n            /*break*/\n            , 2];\n            return [2\n            /*return*/\n            , CheckVideoInputFeedback_1.default.PermissionDenied];\n\n          case 2:\n            return [4\n            /*yield*/\n            , this.meetingSession.audioVideo.chooseVideoInputDevice(null)];\n\n          case 3:\n            _a.sent();\n\n            return [2\n            /*return*/\n            , CheckVideoInputFeedback_1.default.Succeeded];\n\n          case 4:\n            return [3\n            /*break*/\n            , 6];\n\n          case 5:\n            error_3 = _a.sent();\n            this.logger.error(\"MeetingReadinessChecker: Video check failed with error \" + error_3);\n            return [2\n            /*return*/\n            , CheckVideoInputFeedback_1.default.Failed];\n\n          case 6:\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  DefaultMeetingReadinessChecker.prototype.checkCameraResolution = function (videoInputDevice, width, height) {\n    return __awaiter(this, void 0, void 0, function () {\n      var videoConstraint, stream, error_4;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            videoConstraint = {\n              video: this.calculateVideoConstraint(videoInputDevice, width, height)\n            };\n            _a.label = 1;\n\n          case 1:\n            _a.trys.push([1, 3, 4, 5]);\n\n            return [4\n            /*yield*/\n            , navigator.mediaDevices.getUserMedia(videoConstraint)];\n\n          case 2:\n            stream = _a.sent();\n            return [3\n            /*break*/\n            , 5];\n\n          case 3:\n            error_4 = _a.sent();\n            this.logger.error(\"MeetingReadinessChecker: Camera resolution check with width: \" + width + \" height \" + height + \" failed with error \" + error_4);\n\n            if (error_4 && error_4.name === 'OverconstrainedError') {\n              return [2\n              /*return*/\n              , CheckCameraResolutionFeedback_1.default.ResolutionNotSupported];\n            }\n\n            if (error_4 && error_4.name === 'NotAllowedError') {\n              return [2\n              /*return*/\n              , CheckCameraResolutionFeedback_1.default.PermissionDenied];\n            }\n\n            return [2\n            /*return*/\n            , CheckCameraResolutionFeedback_1.default.Failed];\n\n          case 4:\n            if (stream) {\n              stream.getTracks().forEach(function (track) {\n                track.stop();\n              });\n            }\n\n            return [7\n            /*endfinally*/\n            ];\n\n          case 5:\n            return [2\n            /*return*/\n            , CheckCameraResolutionFeedback_1.default.Succeeded];\n        }\n      });\n    });\n  };\n\n  DefaultMeetingReadinessChecker.prototype.calculateVideoConstraint = function (videoInputDevice, width, height) {\n    var dimension = this.browserBehavior.requiresResolutionAlignment(width, height);\n    var trackConstraints = {};\n\n    if (this.browserBehavior.requiresNoExactMediaStreamConstraints()) {\n      trackConstraints.deviceId = videoInputDevice.deviceId;\n      trackConstraints.width = width;\n      trackConstraints.height = height;\n    } else {\n      trackConstraints.deviceId = {\n        exact: videoInputDevice.deviceId\n      };\n      trackConstraints.width = {\n        exact: dimension[0]\n      };\n      trackConstraints.height = {\n        exact: dimension[1]\n      };\n    }\n\n    return trackConstraints;\n  };\n\n  DefaultMeetingReadinessChecker.prototype.checkContentShareConnectivity = function (sourceId) {\n    return __awaiter(this, void 0, void 0, function () {\n      var isContentShareStarted, isAudioVideoStarted, contentShareObserver, observer, error_5;\n\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            isContentShareStarted = false;\n            isAudioVideoStarted = false;\n            contentShareObserver = {\n              contentShareDidStart: function contentShareDidStart() {\n                isContentShareStarted = true;\n              }\n            };\n            observer = {\n              audioVideoDidStart: function audioVideoDidStart() {\n                isAudioVideoStarted = true;\n              }\n            };\n            _a.label = 1;\n\n          case 1:\n            _a.trys.push([1, 5, 6, 7]);\n\n            this.meetingSession.audioVideo.addObserver(observer);\n            this.meetingSession.audioVideo.start();\n            this.meetingSession.audioVideo.addContentShareObserver(contentShareObserver);\n            return [4\n            /*yield*/\n            , this.meetingSession.audioVideo.startContentShareFromScreenCapture(sourceId)];\n\n          case 2:\n            _a.sent();\n\n            return [4\n            /*yield*/\n            , this.executeTimeoutTask(function () {\n              return __awaiter(_this, void 0, void 0, function () {\n                return __generator(this, function (_a) {\n                  return [2\n                  /*return*/\n                  , isAudioVideoStarted && isContentShareStarted];\n                });\n              });\n            })];\n\n          case 3:\n            _a.sent();\n\n            if (!isAudioVideoStarted) {\n              return [2\n              /*return*/\n              , CheckContentShareConnectivityFeedback_1.default.ConnectionFailed];\n            }\n\n            return [4\n            /*yield*/\n            , this.stopMeeting()];\n\n          case 4:\n            _a.sent();\n\n            return [2\n            /*return*/\n            , isContentShareStarted ? CheckContentShareConnectivityFeedback_1.default.Succeeded : CheckContentShareConnectivityFeedback_1.default.TimedOut];\n\n          case 5:\n            error_5 = _a.sent();\n            this.logger.error(\"MeetingReadinessChecker: Content share check failed with error \" + error_5);\n\n            if (error_5.name === 'NotAllowedError') {\n              return [2\n              /*return*/\n              , CheckContentShareConnectivityFeedback_1.default.PermissionDenied];\n            } else {\n              return [2\n              /*return*/\n              , CheckContentShareConnectivityFeedback_1.default.Failed];\n            }\n\n            return [3\n            /*break*/\n            , 7];\n\n          case 6:\n            this.meetingSession.audioVideo.removeObserver(observer);\n            this.meetingSession.audioVideo.stopContentShare();\n            this.meetingSession.audioVideo.removeContentShareObserver(contentShareObserver);\n            return [7\n            /*endfinally*/\n            ];\n\n          case 7:\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  DefaultMeetingReadinessChecker.prototype.checkAudioConnectivity = function (audioInputDeviceInfo) {\n    return __awaiter(this, void 0, void 0, function () {\n      var audioPresence, audioVideo, attendeePresenceHandler, permissionResult, error_6;\n\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            audioPresence = false;\n            audioVideo = this.meetingSession.audioVideo;\n\n            attendeePresenceHandler = function attendeePresenceHandler(attendeeId, present, _externalUserId, _dropped) {\n              if (attendeeId === _this.meetingSession.configuration.credentials.attendeeId && present) {\n                audioPresence = true;\n              }\n            };\n\n            _a.label = 1;\n\n          case 1:\n            _a.trys.push([1, 3,, 4]);\n\n            return [4\n            /*yield*/\n            , audioVideo.chooseAudioInputDevice(audioInputDeviceInfo)];\n\n          case 2:\n            permissionResult = _a.sent();\n\n            if (permissionResult === DevicePermission_1.default.PermissionDeniedByBrowser || permissionResult === DevicePermission_1.default.PermissionDeniedByUser) {\n              return [2\n              /*return*/\n              , CheckAudioConnectivityFeedback_1.default.AudioInputPermissionDenied];\n            }\n\n            return [3\n            /*break*/\n            , 4];\n\n          case 3:\n            error_6 = _a.sent();\n            this.logger.error(\"MeetingReadinessChecker: Failed to get audio input device with error \" + error_6);\n            return [2\n            /*return*/\n            , CheckAudioConnectivityFeedback_1.default.AudioInputRequestFailed];\n\n          case 4:\n            audioVideo.realtimeSubscribeToAttendeeIdPresence(attendeePresenceHandler);\n            return [4\n            /*yield*/\n            , this.startMeeting()];\n\n          case 5:\n            if (!!_a.sent()) return [3\n            /*break*/\n            , 7];\n            audioVideo.realtimeUnsubscribeToAttendeeIdPresence(attendeePresenceHandler);\n            return [4\n            /*yield*/\n            , this.meetingSession.audioVideo.chooseAudioInputDevice(null)];\n\n          case 6:\n            _a.sent();\n\n            return [2\n            /*return*/\n            , CheckAudioConnectivityFeedback_1.default.ConnectionFailed];\n\n          case 7:\n            return [4\n            /*yield*/\n            , this.executeTimeoutTask(function () {\n              return __awaiter(_this, void 0, void 0, function () {\n                return __generator(this, function (_a) {\n                  return [2\n                  /*return*/\n                  , audioPresence];\n                });\n              });\n            })];\n\n          case 8:\n            _a.sent();\n\n            audioVideo.realtimeUnsubscribeToAttendeeIdPresence(attendeePresenceHandler);\n            return [4\n            /*yield*/\n            , this.stopMeeting()];\n\n          case 9:\n            _a.sent();\n\n            return [4\n            /*yield*/\n            , this.meetingSession.audioVideo.chooseAudioInputDevice(null)];\n\n          case 10:\n            _a.sent();\n\n            return [2\n            /*return*/\n            , audioPresence ? CheckAudioConnectivityFeedback_1.default.Succeeded : CheckAudioConnectivityFeedback_1.default.AudioNotReceived];\n        }\n      });\n    });\n  };\n\n  DefaultMeetingReadinessChecker.prototype.checkVideoConnectivity = function (videoInputDeviceInfo) {\n    return __awaiter(this, void 0, void 0, function () {\n      var audioVideo, permissionResult, error_7, packetsSent;\n\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            audioVideo = this.meetingSession.audioVideo;\n            _a.label = 1;\n\n          case 1:\n            _a.trys.push([1, 3,, 4]);\n\n            return [4\n            /*yield*/\n            , audioVideo.chooseVideoInputDevice(videoInputDeviceInfo)];\n\n          case 2:\n            permissionResult = _a.sent();\n\n            if (permissionResult === DevicePermission_1.default.PermissionDeniedByBrowser || permissionResult === DevicePermission_1.default.PermissionDeniedByUser) {\n              return [2\n              /*return*/\n              , CheckVideoConnectivityFeedback_1.default.VideoInputPermissionDenied];\n            }\n\n            return [3\n            /*break*/\n            , 4];\n\n          case 3:\n            error_7 = _a.sent();\n            this.logger.error(\"MeetingReadinessChecker: Failed to get video input device with error \" + error_7);\n            return [2\n            /*return*/\n            , CheckVideoConnectivityFeedback_1.default.VideoInputRequestFailed];\n\n          case 4:\n            return [4\n            /*yield*/\n            , this.startMeeting()];\n\n          case 5:\n            if (!_a.sent()) {\n              return [2\n              /*return*/\n              , CheckVideoConnectivityFeedback_1.default.ConnectionFailed];\n            }\n\n            packetsSent = 0;\n            audioVideo.startLocalVideoTile();\n            return [4\n            /*yield*/\n            , this.executeTimeoutTask(function () {\n              return __awaiter(_this, void 0, void 0, function () {\n                var rawStats;\n                return __generator(this, function (_a) {\n                  switch (_a.label) {\n                    case 0:\n                      return [4\n                      /*yield*/\n                      , audioVideo.getRTCPeerConnectionStats()];\n\n                    case 1:\n                      rawStats = _a.sent();\n\n                      if (rawStats) {\n                        rawStats.forEach(function (report) {\n                          if (report.type === 'outbound-rtp' && report.mediaType === 'video') {\n                            packetsSent = report.packetsSent;\n                          }\n                        });\n                      }\n\n                      return [2\n                      /*return*/\n                      , packetsSent > 0];\n                  }\n                });\n              });\n            })];\n\n          case 6:\n            _a.sent();\n\n            audioVideo.stopLocalVideoTile();\n            return [4\n            /*yield*/\n            , this.stopMeeting()];\n\n          case 7:\n            _a.sent();\n\n            if (packetsSent <= 0) {\n              return [2\n              /*return*/\n              , CheckVideoConnectivityFeedback_1.default.VideoNotSent];\n            }\n\n            return [2\n            /*return*/\n            , CheckVideoConnectivityFeedback_1.default.Succeeded];\n        }\n      });\n    });\n  };\n\n  DefaultMeetingReadinessChecker.prototype.checkNetworkUDPConnectivity = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var audioVideo, candidatePairSucceed;\n\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            try {\n              this.originalURLRewriter = this.meetingSession.configuration.urls.urlRewriter;\n            } catch (error) {\n              this.logger.error(\"MeetingSessionConfiguration.urls doesn't exist. Error: \" + error);\n              return [2\n              /*return*/\n              , CheckNetworkUDPConnectivityFeedback_1.default.MeetingSessionURLsNotInitialized];\n            }\n\n            this.meetingSession.configuration.urls.urlRewriter = function (uri) {\n              var transformedUri = _this.originalURLRewriter(uri);\n\n              if (transformedUri.includes('transport=tcp')) {\n                return '';\n              }\n\n              return transformedUri;\n            };\n\n            audioVideo = this.meetingSession.audioVideo;\n            return [4\n            /*yield*/\n            , this.startMeeting()];\n\n          case 1:\n            if (!_a.sent()) {\n              this.meetingSession.configuration.urls.urlRewriter = this.originalURLRewriter;\n              return [2\n              /*return*/\n              , CheckNetworkUDPConnectivityFeedback_1.default.ConnectionFailed];\n            }\n\n            candidatePairSucceed = false;\n            return [4\n            /*yield*/\n            , this.executeTimeoutTask(function () {\n              return __awaiter(_this, void 0, void 0, function () {\n                var rawStats;\n                return __generator(this, function (_a) {\n                  switch (_a.label) {\n                    case 0:\n                      return [4\n                      /*yield*/\n                      , audioVideo.getRTCPeerConnectionStats()];\n\n                    case 1:\n                      rawStats = _a.sent();\n\n                      if (rawStats) {\n                        rawStats.forEach(function (report) {\n                          if (report.type === 'candidate-pair' && report.state === 'succeeded') {\n                            candidatePairSucceed = true;\n                          }\n                        });\n                      }\n\n                      return [2\n                      /*return*/\n                      , candidatePairSucceed];\n                  }\n                });\n              });\n            })];\n\n          case 2:\n            _a.sent();\n\n            this.meetingSession.configuration.urls.urlRewriter = this.originalURLRewriter;\n            return [4\n            /*yield*/\n            , this.stopMeeting()];\n\n          case 3:\n            _a.sent();\n\n            if (!candidatePairSucceed) {\n              return [2\n              /*return*/\n              , CheckNetworkUDPConnectivityFeedback_1.default.ICENegotiationFailed];\n            }\n\n            return [2\n            /*return*/\n            , CheckNetworkUDPConnectivityFeedback_1.default.Succeeded];\n        }\n      });\n    });\n  };\n\n  DefaultMeetingReadinessChecker.prototype.checkNetworkTCPConnectivity = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var audioVideo, candidatePairSucceed;\n\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            try {\n              this.originalURLRewriter = this.meetingSession.configuration.urls.urlRewriter;\n            } catch (error) {\n              this.logger.error(\"MeetingSessionConfiguration.urls doesn't exist. Error: \" + error);\n              return [2\n              /*return*/\n              , CheckNetworkTCPConnectivityFeedback_1.default.MeetingSessionURLsNotInitialized];\n            }\n\n            this.meetingSession.configuration.urls.urlRewriter = function (uri) {\n              var transformedUri = _this.originalURLRewriter(uri);\n\n              if (transformedUri.includes('transport=udp')) {\n                return '';\n              }\n\n              return transformedUri;\n            };\n\n            audioVideo = this.meetingSession.audioVideo;\n            return [4\n            /*yield*/\n            , this.startMeeting()];\n\n          case 1:\n            if (!_a.sent()) {\n              this.meetingSession.configuration.urls.urlRewriter = this.originalURLRewriter;\n              return [2\n              /*return*/\n              , CheckNetworkTCPConnectivityFeedback_1.default.ConnectionFailed];\n            }\n\n            candidatePairSucceed = false;\n            return [4\n            /*yield*/\n            , this.executeTimeoutTask(function () {\n              return __awaiter(_this, void 0, void 0, function () {\n                var rawStats;\n                return __generator(this, function (_a) {\n                  switch (_a.label) {\n                    case 0:\n                      return [4\n                      /*yield*/\n                      , audioVideo.getRTCPeerConnectionStats()];\n\n                    case 1:\n                      rawStats = _a.sent();\n\n                      if (rawStats) {\n                        rawStats.forEach(function (report) {\n                          if (report.type === 'candidate-pair' && report.state === 'succeeded') {\n                            candidatePairSucceed = true;\n                          }\n                        });\n                      }\n\n                      return [2\n                      /*return*/\n                      , candidatePairSucceed];\n                  }\n                });\n              });\n            })];\n\n          case 2:\n            _a.sent();\n\n            this.meetingSession.configuration.urls.urlRewriter = this.originalURLRewriter;\n            return [4\n            /*yield*/\n            , this.stopMeeting()];\n\n          case 3:\n            _a.sent();\n\n            if (!candidatePairSucceed) {\n              return [2\n              /*return*/\n              , CheckNetworkTCPConnectivityFeedback_1.default.ICENegotiationFailed];\n            }\n\n            return [2\n            /*return*/\n            , CheckNetworkTCPConnectivityFeedback_1.default.Succeeded];\n        }\n      });\n    });\n  };\n\n  DefaultMeetingReadinessChecker.prototype.startMeeting = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var isStarted, observer;\n\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            isStarted = false;\n            observer = {\n              audioVideoDidStart: function audioVideoDidStart() {\n                isStarted = true;\n              }\n            };\n            this.meetingSession.audioVideo.addObserver(observer);\n            this.meetingSession.audioVideo.start();\n            return [4\n            /*yield*/\n            , this.executeTimeoutTask(function () {\n              return __awaiter(_this, void 0, void 0, function () {\n                return __generator(this, function (_a) {\n                  return [2\n                  /*return*/\n                  , isStarted];\n                });\n              });\n            })];\n\n          case 1:\n            _a.sent();\n\n            this.meetingSession.audioVideo.removeObserver(observer);\n            return [2\n            /*return*/\n            , isStarted];\n        }\n      });\n    });\n  };\n\n  DefaultMeetingReadinessChecker.prototype.stopMeeting = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var isStopped, observer;\n\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            isStopped = false;\n            observer = {\n              audioVideoDidStop: function audioVideoDidStop(_sessionStatus) {\n                isStopped = true;\n              }\n            };\n            this.meetingSession.audioVideo.addObserver(observer);\n            this.meetingSession.audioVideo.stop();\n            return [4\n            /*yield*/\n            , this.executeTimeoutTask(function () {\n              return __awaiter(_this, void 0, void 0, function () {\n                return __generator(this, function (_a) {\n                  return [2\n                  /*return*/\n                  , isStopped];\n                });\n              });\n            })];\n\n          case 1:\n            _a.sent();\n\n            this.meetingSession.audioVideo.removeObserver(observer);\n            return [2\n            /*return*/\n            , isStopped];\n        }\n      });\n    });\n  };\n\n  DefaultMeetingReadinessChecker.prototype.executeTimeoutTask = function (conditionCheck) {\n    return __awaiter(this, void 0, void 0, function () {\n      var isSuccess, CheckForConditionTask, timeoutTask;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            isSuccess = false;\n\n            CheckForConditionTask =\n            /** @class */\n            function (_super) {\n              __extends(CheckForConditionTask, _super);\n\n              function CheckForConditionTask(logger, waitDurationMs) {\n                var _this = _super.call(this, logger) || this;\n\n                _this.waitDurationMs = waitDurationMs;\n                _this.isCancelled = false;\n                return _this;\n              }\n\n              CheckForConditionTask.prototype.cancel = function () {\n                this.isCancelled = true;\n              };\n\n              CheckForConditionTask.prototype.run = function () {\n                return __awaiter(this, void 0, void 0, function () {\n                  return __generator(this, function (_a) {\n                    switch (_a.label) {\n                      case 0:\n                        if (!!this.isCancelled) return [3\n                        /*break*/\n                        , 3];\n                        return [4\n                        /*yield*/\n                        , conditionCheck()];\n\n                      case 1:\n                        if (_a.sent()) {\n                          isSuccess = true;\n                          return [3\n                          /*break*/\n                          , 3];\n                        }\n\n                        return [4\n                        /*yield*/\n                        , DefaultMeetingReadinessChecker.delay(this.waitDurationMs)];\n\n                      case 2:\n                        _a.sent();\n\n                        return [3\n                        /*break*/\n                        , 0];\n\n                      case 3:\n                        return [2\n                        /*return*/\n                        ];\n                    }\n                  });\n                });\n              };\n\n              return CheckForConditionTask;\n            }(BaseTask_1.default);\n\n            timeoutTask = new TimeoutTask_1.default(this.logger, new CheckForConditionTask(this.logger, this.configuration.waitDurationMs), this.configuration.timeoutMs);\n            return [4\n            /*yield*/\n            , timeoutTask.run()];\n\n          case 1:\n            _a.sent();\n\n            return [2\n            /*return*/\n            , isSuccess];\n        }\n      });\n    });\n  };\n\n  return DefaultMeetingReadinessChecker;\n}();\n\nexports.default = DefaultMeetingReadinessChecker;","map":{"version":3,"sources":["../../src/meetingreadinesschecker/DefaultMeetingReadinessChecker.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\n// Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar DefaultAudioMixController_1 = require(\"../audiomixcontroller/DefaultAudioMixController\");\nvar DefaultBrowserBehavior_1 = require(\"../browserbehavior/DefaultBrowserBehavior\");\nvar DefaultDeviceController_1 = require(\"../devicecontroller/DefaultDeviceController\");\nvar DevicePermission_1 = require(\"../devicecontroller/DevicePermission\");\nvar TimeoutScheduler_1 = require(\"../scheduler/TimeoutScheduler\");\nvar BaseTask_1 = require(\"../task/BaseTask\");\nvar TimeoutTask_1 = require(\"../task/TimeoutTask\");\nvar CheckAudioConnectivityFeedback_1 = require(\"./CheckAudioConnectivityFeedback\");\nvar CheckAudioInputFeedback_1 = require(\"./CheckAudioInputFeedback\");\nvar CheckAudioOutputFeedback_1 = require(\"./CheckAudioOutputFeedback\");\nvar CheckCameraResolutionFeedback_1 = require(\"./CheckCameraResolutionFeedback\");\nvar CheckContentShareConnectivityFeedback_1 = require(\"./CheckContentShareConnectivityFeedback\");\nvar CheckNetworkTCPConnectivityFeedback_1 = require(\"./CheckNetworkTCPConnectivityFeedback\");\nvar CheckNetworkUDPConnectivityFeedback_1 = require(\"./CheckNetworkUDPConnectivityFeedback\");\nvar CheckVideoConnectivityFeedback_1 = require(\"./CheckVideoConnectivityFeedback\");\nvar CheckVideoInputFeedback_1 = require(\"./CheckVideoInputFeedback\");\nvar MeetingReadinessCheckerConfiguration_1 = require(\"./MeetingReadinessCheckerConfiguration\");\nvar DefaultMeetingReadinessChecker = /** @class */ (function () {\n    function DefaultMeetingReadinessChecker(logger, meetingSession, configuration) {\n        if (configuration === void 0) { configuration = new MeetingReadinessCheckerConfiguration_1.default(); }\n        this.logger = logger;\n        this.meetingSession = meetingSession;\n        this.configuration = configuration;\n        this.browserBehavior = new DefaultBrowserBehavior_1.default();\n    }\n    DefaultMeetingReadinessChecker.delay = function (timeoutMs) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, new Promise(function (resolve) { return new TimeoutScheduler_1.default(timeoutMs).start(resolve); })];\n                    case 1:\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    DefaultMeetingReadinessChecker.prototype.checkAudioInput = function (audioInputDeviceInfo) {\n        return __awaiter(this, void 0, void 0, function () {\n            var result, error_1;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        _a.trys.push([0, 5, , 6]);\n                        return [4 /*yield*/, this.meetingSession.audioVideo.chooseAudioInputDevice(audioInputDeviceInfo)];\n                    case 1:\n                        result = _a.sent();\n                        if (!(result === DevicePermission_1.default.PermissionDeniedByBrowser ||\n                            result === DevicePermission_1.default.PermissionDeniedByUser)) return [3 /*break*/, 2];\n                        return [2 /*return*/, CheckAudioInputFeedback_1.default.PermissionDenied];\n                    case 2: return [4 /*yield*/, this.meetingSession.audioVideo.chooseAudioInputDevice(null)];\n                    case 3:\n                        _a.sent();\n                        return [2 /*return*/, CheckAudioInputFeedback_1.default.Succeeded];\n                    case 4: return [3 /*break*/, 6];\n                    case 5:\n                        error_1 = _a.sent();\n                        this.logger.error(\"MeetingReadinessChecker: Audio input check failed with error \" + error_1);\n                        return [2 /*return*/, CheckAudioInputFeedback_1.default.Failed];\n                    case 6: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    DefaultMeetingReadinessChecker.prototype.checkAudioOutput = function (audioOutputDeviceInfo, audioOutputVerificationCallback, audioElement) {\n        if (audioElement === void 0) { audioElement = null; }\n        return __awaiter(this, void 0, void 0, function () {\n            var audioOutputDeviceId, userFeedback, error_2;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        _a.trys.push([0, 2, 3, 4]);\n                        audioOutputDeviceId = audioOutputDeviceInfo && audioOutputDeviceInfo.deviceId\n                            ? audioOutputDeviceInfo.deviceId\n                            : '';\n                        this.playTone(audioOutputDeviceId, 440, audioElement);\n                        return [4 /*yield*/, audioOutputVerificationCallback()];\n                    case 1:\n                        userFeedback = _a.sent();\n                        if (userFeedback) {\n                            return [2 /*return*/, CheckAudioOutputFeedback_1.default.Succeeded];\n                        }\n                        else {\n                            return [2 /*return*/, CheckAudioOutputFeedback_1.default.Failed];\n                        }\n                        return [3 /*break*/, 4];\n                    case 2:\n                        error_2 = _a.sent();\n                        this.logger.error(\"MeetingReadinessChecker: Audio output check failed with error: \" + error_2);\n                        return [2 /*return*/, CheckAudioOutputFeedback_1.default.Failed];\n                    case 3:\n                        this.stopTone();\n                        return [7 /*endfinally*/];\n                    case 4: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    DefaultMeetingReadinessChecker.prototype.playTone = function (sinkId, frequency, audioElement) {\n        var rampSec = 0.1;\n        var maxGainValue = 0.1;\n        if (this.oscillatorNode) {\n            this.stopTone();\n        }\n        this.audioContext = DefaultDeviceController_1.default.getAudioContext();\n        this.gainNode = this.audioContext.createGain();\n        this.gainNode.gain.value = 0;\n        this.oscillatorNode = this.audioContext.createOscillator();\n        this.oscillatorNode.frequency.value = frequency;\n        this.oscillatorNode.connect(this.gainNode);\n        this.destinationStream = this.audioContext.createMediaStreamDestination();\n        this.gainNode.connect(this.destinationStream);\n        var currentTime = this.audioContext.currentTime;\n        var startTime = currentTime + 0.1;\n        this.gainNode.gain.linearRampToValueAtTime(0, startTime);\n        this.gainNode.gain.linearRampToValueAtTime(maxGainValue, startTime + rampSec);\n        this.oscillatorNode.start();\n        var audioMixController = new DefaultAudioMixController_1.default();\n        // @ts-ignore\n        audioMixController.bindAudioDevice({ deviceId: sinkId });\n        audioMixController.bindAudioElement(audioElement || new Audio());\n        audioMixController.bindAudioStream(this.destinationStream.stream);\n    };\n    DefaultMeetingReadinessChecker.prototype.stopTone = function () {\n        if (!this.audioContext || !this.gainNode || !this.oscillatorNode || !this.destinationStream) {\n            return;\n        }\n        var durationSec = 1;\n        var rampSec = 0.1;\n        var maxGainValue = 0.1;\n        var currentTime = this.audioContext.currentTime;\n        this.gainNode.gain.linearRampToValueAtTime(maxGainValue, currentTime + rampSec + durationSec);\n        this.gainNode.gain.linearRampToValueAtTime(0, currentTime + rampSec * 2 + durationSec);\n        this.oscillatorNode.stop();\n        this.oscillatorNode.disconnect(this.gainNode);\n        this.gainNode.disconnect(this.destinationStream);\n        this.oscillatorNode = null;\n        this.gainNode = null;\n        this.destinationStream = null;\n    };\n    DefaultMeetingReadinessChecker.prototype.checkVideoInput = function (videoInputDeviceInfo) {\n        return __awaiter(this, void 0, void 0, function () {\n            var result, error_3;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        _a.trys.push([0, 5, , 6]);\n                        return [4 /*yield*/, this.meetingSession.audioVideo.chooseVideoInputDevice(videoInputDeviceInfo)];\n                    case 1:\n                        result = _a.sent();\n                        if (!(result === DevicePermission_1.default.PermissionDeniedByBrowser ||\n                            result === DevicePermission_1.default.PermissionDeniedByUser)) return [3 /*break*/, 2];\n                        return [2 /*return*/, CheckVideoInputFeedback_1.default.PermissionDenied];\n                    case 2: return [4 /*yield*/, this.meetingSession.audioVideo.chooseVideoInputDevice(null)];\n                    case 3:\n                        _a.sent();\n                        return [2 /*return*/, CheckVideoInputFeedback_1.default.Succeeded];\n                    case 4: return [3 /*break*/, 6];\n                    case 5:\n                        error_3 = _a.sent();\n                        this.logger.error(\"MeetingReadinessChecker: Video check failed with error \" + error_3);\n                        return [2 /*return*/, CheckVideoInputFeedback_1.default.Failed];\n                    case 6: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    DefaultMeetingReadinessChecker.prototype.checkCameraResolution = function (videoInputDevice, width, height) {\n        return __awaiter(this, void 0, void 0, function () {\n            var videoConstraint, stream, error_4;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        videoConstraint = {\n                            video: this.calculateVideoConstraint(videoInputDevice, width, height),\n                        };\n                        _a.label = 1;\n                    case 1:\n                        _a.trys.push([1, 3, 4, 5]);\n                        return [4 /*yield*/, navigator.mediaDevices.getUserMedia(videoConstraint)];\n                    case 2:\n                        stream = _a.sent();\n                        return [3 /*break*/, 5];\n                    case 3:\n                        error_4 = _a.sent();\n                        this.logger.error(\"MeetingReadinessChecker: Camera resolution check with width: \" + width + \" height \" + height + \" failed with error \" + error_4);\n                        if (error_4 && error_4.name === 'OverconstrainedError') {\n                            return [2 /*return*/, CheckCameraResolutionFeedback_1.default.ResolutionNotSupported];\n                        }\n                        if (error_4 && error_4.name === 'NotAllowedError') {\n                            return [2 /*return*/, CheckCameraResolutionFeedback_1.default.PermissionDenied];\n                        }\n                        return [2 /*return*/, CheckCameraResolutionFeedback_1.default.Failed];\n                    case 4:\n                        if (stream) {\n                            stream.getTracks().forEach(function (track) {\n                                track.stop();\n                            });\n                        }\n                        return [7 /*endfinally*/];\n                    case 5: return [2 /*return*/, CheckCameraResolutionFeedback_1.default.Succeeded];\n                }\n            });\n        });\n    };\n    DefaultMeetingReadinessChecker.prototype.calculateVideoConstraint = function (videoInputDevice, width, height) {\n        var dimension = this.browserBehavior.requiresResolutionAlignment(width, height);\n        var trackConstraints = {};\n        if (this.browserBehavior.requiresNoExactMediaStreamConstraints()) {\n            trackConstraints.deviceId = videoInputDevice.deviceId;\n            trackConstraints.width = width;\n            trackConstraints.height = height;\n        }\n        else {\n            trackConstraints.deviceId = { exact: videoInputDevice.deviceId };\n            trackConstraints.width = { exact: dimension[0] };\n            trackConstraints.height = { exact: dimension[1] };\n        }\n        return trackConstraints;\n    };\n    DefaultMeetingReadinessChecker.prototype.checkContentShareConnectivity = function (sourceId) {\n        return __awaiter(this, void 0, void 0, function () {\n            var isContentShareStarted, isAudioVideoStarted, contentShareObserver, observer, error_5;\n            var _this = this;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        isContentShareStarted = false;\n                        isAudioVideoStarted = false;\n                        contentShareObserver = {\n                            contentShareDidStart: function () {\n                                isContentShareStarted = true;\n                            },\n                        };\n                        observer = {\n                            audioVideoDidStart: function () {\n                                isAudioVideoStarted = true;\n                            },\n                        };\n                        _a.label = 1;\n                    case 1:\n                        _a.trys.push([1, 5, 6, 7]);\n                        this.meetingSession.audioVideo.addObserver(observer);\n                        this.meetingSession.audioVideo.start();\n                        this.meetingSession.audioVideo.addContentShareObserver(contentShareObserver);\n                        return [4 /*yield*/, this.meetingSession.audioVideo.startContentShareFromScreenCapture(sourceId)];\n                    case 2:\n                        _a.sent();\n                        return [4 /*yield*/, this.executeTimeoutTask(function () { return __awaiter(_this, void 0, void 0, function () {\n                                return __generator(this, function (_a) {\n                                    return [2 /*return*/, isAudioVideoStarted && isContentShareStarted];\n                                });\n                            }); })];\n                    case 3:\n                        _a.sent();\n                        if (!isAudioVideoStarted) {\n                            return [2 /*return*/, CheckContentShareConnectivityFeedback_1.default.ConnectionFailed];\n                        }\n                        return [4 /*yield*/, this.stopMeeting()];\n                    case 4:\n                        _a.sent();\n                        return [2 /*return*/, isContentShareStarted\n                                ? CheckContentShareConnectivityFeedback_1.default.Succeeded\n                                : CheckContentShareConnectivityFeedback_1.default.TimedOut];\n                    case 5:\n                        error_5 = _a.sent();\n                        this.logger.error(\"MeetingReadinessChecker: Content share check failed with error \" + error_5);\n                        if (error_5.name === 'NotAllowedError') {\n                            return [2 /*return*/, CheckContentShareConnectivityFeedback_1.default.PermissionDenied];\n                        }\n                        else {\n                            return [2 /*return*/, CheckContentShareConnectivityFeedback_1.default.Failed];\n                        }\n                        return [3 /*break*/, 7];\n                    case 6:\n                        this.meetingSession.audioVideo.removeObserver(observer);\n                        this.meetingSession.audioVideo.stopContentShare();\n                        this.meetingSession.audioVideo.removeContentShareObserver(contentShareObserver);\n                        return [7 /*endfinally*/];\n                    case 7: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    DefaultMeetingReadinessChecker.prototype.checkAudioConnectivity = function (audioInputDeviceInfo) {\n        return __awaiter(this, void 0, void 0, function () {\n            var audioPresence, audioVideo, attendeePresenceHandler, permissionResult, error_6;\n            var _this = this;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        audioPresence = false;\n                        audioVideo = this.meetingSession.audioVideo;\n                        attendeePresenceHandler = function (attendeeId, present, _externalUserId, _dropped) {\n                            if (attendeeId === _this.meetingSession.configuration.credentials.attendeeId && present) {\n                                audioPresence = true;\n                            }\n                        };\n                        _a.label = 1;\n                    case 1:\n                        _a.trys.push([1, 3, , 4]);\n                        return [4 /*yield*/, audioVideo.chooseAudioInputDevice(audioInputDeviceInfo)];\n                    case 2:\n                        permissionResult = _a.sent();\n                        if (permissionResult === DevicePermission_1.default.PermissionDeniedByBrowser ||\n                            permissionResult === DevicePermission_1.default.PermissionDeniedByUser) {\n                            return [2 /*return*/, CheckAudioConnectivityFeedback_1.default.AudioInputPermissionDenied];\n                        }\n                        return [3 /*break*/, 4];\n                    case 3:\n                        error_6 = _a.sent();\n                        this.logger.error(\"MeetingReadinessChecker: Failed to get audio input device with error \" + error_6);\n                        return [2 /*return*/, CheckAudioConnectivityFeedback_1.default.AudioInputRequestFailed];\n                    case 4:\n                        audioVideo.realtimeSubscribeToAttendeeIdPresence(attendeePresenceHandler);\n                        return [4 /*yield*/, this.startMeeting()];\n                    case 5:\n                        if (!!(_a.sent())) return [3 /*break*/, 7];\n                        audioVideo.realtimeUnsubscribeToAttendeeIdPresence(attendeePresenceHandler);\n                        return [4 /*yield*/, this.meetingSession.audioVideo.chooseAudioInputDevice(null)];\n                    case 6:\n                        _a.sent();\n                        return [2 /*return*/, CheckAudioConnectivityFeedback_1.default.ConnectionFailed];\n                    case 7: return [4 /*yield*/, this.executeTimeoutTask(function () { return __awaiter(_this, void 0, void 0, function () {\n                            return __generator(this, function (_a) {\n                                return [2 /*return*/, audioPresence];\n                            });\n                        }); })];\n                    case 8:\n                        _a.sent();\n                        audioVideo.realtimeUnsubscribeToAttendeeIdPresence(attendeePresenceHandler);\n                        return [4 /*yield*/, this.stopMeeting()];\n                    case 9:\n                        _a.sent();\n                        return [4 /*yield*/, this.meetingSession.audioVideo.chooseAudioInputDevice(null)];\n                    case 10:\n                        _a.sent();\n                        return [2 /*return*/, audioPresence\n                                ? CheckAudioConnectivityFeedback_1.default.Succeeded\n                                : CheckAudioConnectivityFeedback_1.default.AudioNotReceived];\n                }\n            });\n        });\n    };\n    DefaultMeetingReadinessChecker.prototype.checkVideoConnectivity = function (videoInputDeviceInfo) {\n        return __awaiter(this, void 0, void 0, function () {\n            var audioVideo, permissionResult, error_7, packetsSent;\n            var _this = this;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        audioVideo = this.meetingSession.audioVideo;\n                        _a.label = 1;\n                    case 1:\n                        _a.trys.push([1, 3, , 4]);\n                        return [4 /*yield*/, audioVideo.chooseVideoInputDevice(videoInputDeviceInfo)];\n                    case 2:\n                        permissionResult = _a.sent();\n                        if (permissionResult === DevicePermission_1.default.PermissionDeniedByBrowser ||\n                            permissionResult === DevicePermission_1.default.PermissionDeniedByUser) {\n                            return [2 /*return*/, CheckVideoConnectivityFeedback_1.default.VideoInputPermissionDenied];\n                        }\n                        return [3 /*break*/, 4];\n                    case 3:\n                        error_7 = _a.sent();\n                        this.logger.error(\"MeetingReadinessChecker: Failed to get video input device with error \" + error_7);\n                        return [2 /*return*/, CheckVideoConnectivityFeedback_1.default.VideoInputRequestFailed];\n                    case 4: return [4 /*yield*/, this.startMeeting()];\n                    case 5:\n                        if (!(_a.sent())) {\n                            return [2 /*return*/, CheckVideoConnectivityFeedback_1.default.ConnectionFailed];\n                        }\n                        packetsSent = 0;\n                        audioVideo.startLocalVideoTile();\n                        return [4 /*yield*/, this.executeTimeoutTask(function () { return __awaiter(_this, void 0, void 0, function () {\n                                var rawStats;\n                                return __generator(this, function (_a) {\n                                    switch (_a.label) {\n                                        case 0: return [4 /*yield*/, audioVideo.getRTCPeerConnectionStats()];\n                                        case 1:\n                                            rawStats = _a.sent();\n                                            if (rawStats) {\n                                                rawStats.forEach(function (report) {\n                                                    if (report.type === 'outbound-rtp' && report.mediaType === 'video') {\n                                                        packetsSent = report.packetsSent;\n                                                    }\n                                                });\n                                            }\n                                            return [2 /*return*/, packetsSent > 0];\n                                    }\n                                });\n                            }); })];\n                    case 6:\n                        _a.sent();\n                        audioVideo.stopLocalVideoTile();\n                        return [4 /*yield*/, this.stopMeeting()];\n                    case 7:\n                        _a.sent();\n                        if (packetsSent <= 0) {\n                            return [2 /*return*/, CheckVideoConnectivityFeedback_1.default.VideoNotSent];\n                        }\n                        return [2 /*return*/, CheckVideoConnectivityFeedback_1.default.Succeeded];\n                }\n            });\n        });\n    };\n    DefaultMeetingReadinessChecker.prototype.checkNetworkUDPConnectivity = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var audioVideo, candidatePairSucceed;\n            var _this = this;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        try {\n                            this.originalURLRewriter = this.meetingSession.configuration.urls.urlRewriter;\n                        }\n                        catch (error) {\n                            this.logger.error(\"MeetingSessionConfiguration.urls doesn't exist. Error: \" + error);\n                            return [2 /*return*/, CheckNetworkUDPConnectivityFeedback_1.default.MeetingSessionURLsNotInitialized];\n                        }\n                        this.meetingSession.configuration.urls.urlRewriter = function (uri) {\n                            var transformedUri = _this.originalURLRewriter(uri);\n                            if (transformedUri.includes('transport=tcp')) {\n                                return '';\n                            }\n                            return transformedUri;\n                        };\n                        audioVideo = this.meetingSession.audioVideo;\n                        return [4 /*yield*/, this.startMeeting()];\n                    case 1:\n                        if (!(_a.sent())) {\n                            this.meetingSession.configuration.urls.urlRewriter = this.originalURLRewriter;\n                            return [2 /*return*/, CheckNetworkUDPConnectivityFeedback_1.default.ConnectionFailed];\n                        }\n                        candidatePairSucceed = false;\n                        return [4 /*yield*/, this.executeTimeoutTask(function () { return __awaiter(_this, void 0, void 0, function () {\n                                var rawStats;\n                                return __generator(this, function (_a) {\n                                    switch (_a.label) {\n                                        case 0: return [4 /*yield*/, audioVideo.getRTCPeerConnectionStats()];\n                                        case 1:\n                                            rawStats = _a.sent();\n                                            if (rawStats) {\n                                                rawStats.forEach(function (report) {\n                                                    if (report.type === 'candidate-pair' && report.state === 'succeeded') {\n                                                        candidatePairSucceed = true;\n                                                    }\n                                                });\n                                            }\n                                            return [2 /*return*/, candidatePairSucceed];\n                                    }\n                                });\n                            }); })];\n                    case 2:\n                        _a.sent();\n                        this.meetingSession.configuration.urls.urlRewriter = this.originalURLRewriter;\n                        return [4 /*yield*/, this.stopMeeting()];\n                    case 3:\n                        _a.sent();\n                        if (!candidatePairSucceed) {\n                            return [2 /*return*/, CheckNetworkUDPConnectivityFeedback_1.default.ICENegotiationFailed];\n                        }\n                        return [2 /*return*/, CheckNetworkUDPConnectivityFeedback_1.default.Succeeded];\n                }\n            });\n        });\n    };\n    DefaultMeetingReadinessChecker.prototype.checkNetworkTCPConnectivity = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var audioVideo, candidatePairSucceed;\n            var _this = this;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        try {\n                            this.originalURLRewriter = this.meetingSession.configuration.urls.urlRewriter;\n                        }\n                        catch (error) {\n                            this.logger.error(\"MeetingSessionConfiguration.urls doesn't exist. Error: \" + error);\n                            return [2 /*return*/, CheckNetworkTCPConnectivityFeedback_1.default.MeetingSessionURLsNotInitialized];\n                        }\n                        this.meetingSession.configuration.urls.urlRewriter = function (uri) {\n                            var transformedUri = _this.originalURLRewriter(uri);\n                            if (transformedUri.includes('transport=udp')) {\n                                return '';\n                            }\n                            return transformedUri;\n                        };\n                        audioVideo = this.meetingSession.audioVideo;\n                        return [4 /*yield*/, this.startMeeting()];\n                    case 1:\n                        if (!(_a.sent())) {\n                            this.meetingSession.configuration.urls.urlRewriter = this.originalURLRewriter;\n                            return [2 /*return*/, CheckNetworkTCPConnectivityFeedback_1.default.ConnectionFailed];\n                        }\n                        candidatePairSucceed = false;\n                        return [4 /*yield*/, this.executeTimeoutTask(function () { return __awaiter(_this, void 0, void 0, function () {\n                                var rawStats;\n                                return __generator(this, function (_a) {\n                                    switch (_a.label) {\n                                        case 0: return [4 /*yield*/, audioVideo.getRTCPeerConnectionStats()];\n                                        case 1:\n                                            rawStats = _a.sent();\n                                            if (rawStats) {\n                                                rawStats.forEach(function (report) {\n                                                    if (report.type === 'candidate-pair' && report.state === 'succeeded') {\n                                                        candidatePairSucceed = true;\n                                                    }\n                                                });\n                                            }\n                                            return [2 /*return*/, candidatePairSucceed];\n                                    }\n                                });\n                            }); })];\n                    case 2:\n                        _a.sent();\n                        this.meetingSession.configuration.urls.urlRewriter = this.originalURLRewriter;\n                        return [4 /*yield*/, this.stopMeeting()];\n                    case 3:\n                        _a.sent();\n                        if (!candidatePairSucceed) {\n                            return [2 /*return*/, CheckNetworkTCPConnectivityFeedback_1.default.ICENegotiationFailed];\n                        }\n                        return [2 /*return*/, CheckNetworkTCPConnectivityFeedback_1.default.Succeeded];\n                }\n            });\n        });\n    };\n    DefaultMeetingReadinessChecker.prototype.startMeeting = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var isStarted, observer;\n            var _this = this;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        isStarted = false;\n                        observer = {\n                            audioVideoDidStart: function () {\n                                isStarted = true;\n                            },\n                        };\n                        this.meetingSession.audioVideo.addObserver(observer);\n                        this.meetingSession.audioVideo.start();\n                        return [4 /*yield*/, this.executeTimeoutTask(function () { return __awaiter(_this, void 0, void 0, function () {\n                                return __generator(this, function (_a) {\n                                    return [2 /*return*/, isStarted];\n                                });\n                            }); })];\n                    case 1:\n                        _a.sent();\n                        this.meetingSession.audioVideo.removeObserver(observer);\n                        return [2 /*return*/, isStarted];\n                }\n            });\n        });\n    };\n    DefaultMeetingReadinessChecker.prototype.stopMeeting = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var isStopped, observer;\n            var _this = this;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        isStopped = false;\n                        observer = {\n                            audioVideoDidStop: function (_sessionStatus) {\n                                isStopped = true;\n                            },\n                        };\n                        this.meetingSession.audioVideo.addObserver(observer);\n                        this.meetingSession.audioVideo.stop();\n                        return [4 /*yield*/, this.executeTimeoutTask(function () { return __awaiter(_this, void 0, void 0, function () {\n                                return __generator(this, function (_a) {\n                                    return [2 /*return*/, isStopped];\n                                });\n                            }); })];\n                    case 1:\n                        _a.sent();\n                        this.meetingSession.audioVideo.removeObserver(observer);\n                        return [2 /*return*/, isStopped];\n                }\n            });\n        });\n    };\n    DefaultMeetingReadinessChecker.prototype.executeTimeoutTask = function (conditionCheck) {\n        return __awaiter(this, void 0, void 0, function () {\n            var isSuccess, CheckForConditionTask, timeoutTask;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        isSuccess = false;\n                        CheckForConditionTask = /** @class */ (function (_super) {\n                            __extends(CheckForConditionTask, _super);\n                            function CheckForConditionTask(logger, waitDurationMs) {\n                                var _this = _super.call(this, logger) || this;\n                                _this.waitDurationMs = waitDurationMs;\n                                _this.isCancelled = false;\n                                return _this;\n                            }\n                            CheckForConditionTask.prototype.cancel = function () {\n                                this.isCancelled = true;\n                            };\n                            CheckForConditionTask.prototype.run = function () {\n                                return __awaiter(this, void 0, void 0, function () {\n                                    return __generator(this, function (_a) {\n                                        switch (_a.label) {\n                                            case 0:\n                                                if (!!this.isCancelled) return [3 /*break*/, 3];\n                                                return [4 /*yield*/, conditionCheck()];\n                                            case 1:\n                                                if (_a.sent()) {\n                                                    isSuccess = true;\n                                                    return [3 /*break*/, 3];\n                                                }\n                                                return [4 /*yield*/, DefaultMeetingReadinessChecker.delay(this.waitDurationMs)];\n                                            case 2:\n                                                _a.sent();\n                                                return [3 /*break*/, 0];\n                                            case 3: return [2 /*return*/];\n                                        }\n                                    });\n                                });\n                            };\n                            return CheckForConditionTask;\n                        }(BaseTask_1.default));\n                        timeoutTask = new TimeoutTask_1.default(this.logger, new CheckForConditionTask(this.logger, this.configuration.waitDurationMs), this.configuration.timeoutMs);\n                        return [4 /*yield*/, timeoutTask.run()];\n                    case 1:\n                        _a.sent();\n                        return [2 /*return*/, isSuccess];\n                }\n            });\n        });\n    };\n    return DefaultMeetingReadinessChecker;\n}());\nexports.default = DefaultMeetingReadinessChecker;\n//# sourceMappingURL=DefaultMeetingReadinessChecker.js.map"]},"metadata":{},"sourceType":"script"}